
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">


  
<script>
  // A global function that the theme toggle can use to apply the current theme.
  window.applyThemeSetting = function(override) {
    const currentSetting = override || localStorage.getItem('user-color-scheme');
    const currentAttribute = document.documentElement.getAttribute('data-user-theme');

    if (currentSetting && currentSetting !== currentAttribute) {
      document.documentElement.setAttribute('data-user-theme', currentSetting);
    }
  };
window.applyThemeSetting();
</script>

  
  <link rel="stylesheet" href="/css/next.css?v=30488467bac09">
  <link rel="stylesheet" href="/css/legacy-rollout.css?v=45ee8627e107d">
  <link rel="preload" as="font" crossorigin href="/fonts/material-icons/regular.woff2">


<link rel="preload" as="font" crossorigin href="/fonts/google-sans/regular/latin.woff2">
<link rel="preload" as="font" crossorigin href="/fonts/google-sans/bold/latin.woff2">

<meta name="theme-color" content="#fff"/>




<title>Kapwing: Powerful video editing for the web</title>
<meta name="description" content="Companies like Kapwing make it possible to create all this video content right on the web, by using powerful APIs (like IndexedDB and WebCodecs) and performance tools.  " />

<link rel="canonical" href="https://web.dev/kapwing/" />

<meta itemprop="name" content="Kapwing: Powerful video editing for the web" />
<meta itemprop="description" content="Companies like Kapwing make it possible to create all this video content right on the web, by using powerful APIs (like IndexedDB and WebCodecs) and performance tools.  " />
<meta itemprop="image" content="https://web-dev.imgix.net/image/VbsHyyQopiec0718rMq2kTE1hke2/to1mQCrluLRKhX5k97lc.jpeg?auto=format&fit=max&w=1200&fm=auto" />
<meta property="og:locale" content="en_US" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://web.dev/kapwing/" />
<meta property="og:site_name" content="web.dev" />
<meta property="og:title" content="Kapwing: Powerful video editing for the web" />
<meta property="og:description" content="Companies like Kapwing make it possible to create all this video content right on the web, by using powerful APIs (like IndexedDB and WebCodecs) and performance tools.  " />
<meta property="og:image" content="https://web-dev.imgix.net/image/VbsHyyQopiec0718rMq2kTE1hke2/to1mQCrluLRKhX5k97lc.jpeg?auto=format&fit=max&w=1200&fm=auto" />
<meta property="og:image:alt" content="Kapwing logo" />
<meta property="tag" content="case-study" />
<meta property="tag" content="capabilities" />
<meta property="tag" content="progressive-web-apps" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="Kapwing: Powerful video editing for the web" />
<meta name="twitter:description" content="Companies like Kapwing make it possible to create all this video content right on the web, by using powerful APIs (like IndexedDB and WebCodecs) and performance tools.  " />
<meta name="twitter:image" content="https://web-dev.imgix.net/image/VbsHyyQopiec0718rMq2kTE1hke2/to1mQCrluLRKhX5k97lc.jpeg?auto=format&fit=max&w=1200&fm=auto" />
<link
  rel="alternate"
  href="/feed.xml"
  type="application/atom+xml"
  data-title="web.dev feed"
/>

<link rel="manifest" href="/manifest.webmanifest" />

<link rel="shortcut icon" href="/images/favicon.ico">
<link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
<link rel="mask-icon" color="#0054ff" href="/images/safari-pinned-tab.svg">



<script>
window.ga =
  window.ga ||
  function () {
    (ga.q = ga.q || []).push(arguments);
  };
ga.l = +new Date();
ga('create', 'UA-126406676-2');
ga('set', 'transport', 'beacon');
ga('set', 'anonymizeIp', true);
ga('set', 'page', window.location.pathname);
ga('set', 'dimension5', '4');
ga('send', 'pageview');
</script>







<script>
function loadScript(url, type) {
  const s = document.createElement('script');
  s.src = url;
  if (type) {
    s.type = type;
  }
  if (type === 'module') {
    s.async = false; // Preserve load order.
    const pre = document.createElement('link');
    pre.rel = 'modulepreload';
    pre.href = url;
    document.head.append(pre);
    // We use DOMContentLoaded as the loader script is running sync, and inserting a module script here doesn't defer. This brings back normal type="module" behavior.
    window.addEventListener('DOMContentLoaded', () => {
      document.head.append(s);
    });
  } else {
    document.head.append(s);
  }
}
loadScript('/js/app.js?v=c1b32b682a27d', 'module');




  loadScript('/js/content.js?v=b0658e6870c27', 'module');


  loadScript('https://www.google-analytics.com/analytics.js', null);

</script>

  </head>
  <body class="unresolved">
    
    <web-snackbar-container></web-snackbar-container>

    
<a href="#main" class="skip-link button" data-type="primary">Skip to content</a>


<web-header role="banner" class="site-header">
  <div class="cluster gutter-base">
    <button class="icon-button tooltip color-core-text md:hidden-yes" data-open-drawer-button data-alignment="right">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" height="24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
      <span class="tooltip__content">Open menu</span>
    </button>
    <a href="/" class="site-header__brand brand">
      


  <svg role="img" aria-label="web.dev" xmlns="http://www.w3.org/2000/svg" width="119.79" height="22.32" viewBox="0 0 119.79 22.32"><path class="brand__text" d="M114.99 19.32h-2.2l-4.8-11.9h2.4l3.5 9.2 3.5-9.2h2.4Zm-16.8-7.3h6.8a3.17 3.17 0 0 0-3.4-2.9 3.42 3.42 0 0 0-3.4 2.9Zm3.6 7.7a6 6 0 0 1-6-6.3c0-3.6 2.5-6.3 5.9-6.3s5.8 2.4 5.8 6.5v.2h-9.3a3.88 3.88 0 0 0 3.8 3.9 3.56 3.56 0 0 0 3.3-2.1l2 1a6.22 6.22 0 0 1-5.5 3.1Zm-14 0c-3.1 0-5.7-2.8-5.7-6.3s2.6-6.3 5.7-6.3a5 5 0 0 1 4.1 2h.1l-.1-1.6v-5.5h2.2v17.3h-2.1v-1.6h-.1a5.12 5.12 0 0 1-4.1 2Zm.3-2c2.2 0 3.8-1.7 3.8-4.3s-1.6-4.3-3.8-4.3a4 4 0 0 0-3.8 4.3 4 4 0 0 0 3.8 4.3Zm-6.8.1a1.61 1.61 0 0 1-1.7 1.6 1.74 1.74 0 0 1-1.7-1.6 1.67 1.67 0 0 1 1.7-1.6 1.61 1.61 0 0 1 1.7 1.6Zm-10.5-.1a4 4 0 0 0 3.8-4.3 4 4 0 0 0-3.8-4.3c-2.2 0-3.8 1.8-3.8 4.3s1.6 4.3 3.8 4.3Zm.4 2a5 5 0 0 1-4.1-2h-.1v1.6h-2.1V2.02h2.2v5.5l-.1 1.6h.1a4.84 4.84 0 0 1 4.1-2c3.1 0 5.7 2.8 5.7 6.3s-2.6 6.3-5.7 6.3Zm-17.4-7.7h6.8a3.17 3.17 0 0 0-3.4-2.9 3.42 3.42 0 0 0-3.4 2.9Zm3.6 7.7a6 6 0 0 1-6-6.3c0-3.6 2.5-6.3 5.9-6.3s5.8 2.4 5.8 6.5v.2h-9.3a3.88 3.88 0 0 0 3.8 3.9 3.67 3.67 0 0 0 3.3-2.1l2 1a6.22 6.22 0 0 1-5.5 3.1Zm-6.3-12.2-3.8 11.9h-2.3l-3-9.1-2.9 9.1h-2.3l-3.9-11.9h2.3l2.6 9 2.9-9h2.3l2.9 9 2.6-9Z" fill="#5f6368" fill-rule="evenodd"/><path d="M0 19.28a3 3 0 0 1 3-3h16.27a3.045 3.045 0 0 1 0 6.09H3.04A3 3 0 0 1 0 19.28Z" fill="#6cf"/><path d="M.89.9a3 3 0 0 1 4.3 0l8.12 8.11a3.05 3.05 0 0 1 0 4.3l-8.12 8.12a3.04 3.04 0 1 1-4.3-4.3l5.6-5.61a.51.51 0 0 0 0-.72L.89 5.22A3 3 0 0 1 .89.9Z" fill="#06f" fill-rule="evenodd"/><path d="m10.39 16.22-5.2 5.2a3.04 3.04 0 1 1-4.3-4.3l.89-.9Z" fill="#c6f"/><circle cx="19.27" cy="19.27" r="3.04" fill="#06f"/></svg>


    </a>
  </div>
  <web-navigation-drawer type="standard">
    <nav class="site-header__nav" aria-label="main navigation" data-drawer-container>
      <a
        class="site-header__link"
        href="/learn/" data-category="Site-Wide Custom Events"
        data-label="Tab: Learn"
        >
          Learn
      </a>
      <a
        class="site-header__link"
        href="/measure/"
        data-category="Site-Wide Custom Events"
        data-label="Tab: Measure"
        >
        Measure
      </a>
      <a
        class="site-header__link"
        href="/blog/"
        data-category="Site-Wide Custom Events"
        data-label="Tab: Blog"
        >
        Blog
      </a>
      <a
        class="site-header__link"
        href="/tags/case-study/"
        data-category="Site-Wide Custom Events"
        data-label="Tab: Case Studies"
        >
        Case studies
      </a>
      <a
        class="site-header__link"
        href="/about/"
        data-category="Site-Wide Custom Events"
        data-label="Tab: About" >
        About
      </a>
      <button class="icon-button tooltip color-core-text md:hidden-yes" data-drawer-close-button>
        








  










  <svg class="icon " role="img" aria-label="close" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" height="24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>


        <span class="tooltip__content">Close</span>
      </button>
    </nav>
  </web-navigation-drawer>
  <div class="site-header__actions cluster">
    <div class="site-header__search">
      <web-search results-id="search-main-results" i18n="{&quot;search&quot;:{&quot;en&quot;:&quot;Search&quot;},&quot;open_search&quot;:{&quot;en&quot;:&quot;Open search&quot;},&quot;all_articles&quot;:{&quot;en&quot;:&quot;All articles&quot;},&quot;close_search&quot;:{&quot;en&quot;:&quot;Close search&quot;}}"></web-search>
      <web-search-results id="search-main-results"></web-search-results>
    </div>
  </div>
</web-header>

<main id="main">
  
    
  
  





  <img     alt="Kapwing logo"     class="hero-image"     decoding="async"     height="480"               sizes="100vw"     src="https://web-dev.imgix.net/image/VbsHyyQopiec0718rMq2kTE1hke2/to1mQCrluLRKhX5k97lc.jpeg?auto=format"     srcset="https://web-dev.imgix.net/image/VbsHyyQopiec0718rMq2kTE1hke2/to1mQCrluLRKhX5k97lc.jpeg?auto=format&w=200 200w,     https://web-dev.imgix.net/image/VbsHyyQopiec0718rMq2kTE1hke2/to1mQCrluLRKhX5k97lc.jpeg?auto=format&w=228 228w,     https://web-dev.imgix.net/image/VbsHyyQopiec0718rMq2kTE1hke2/to1mQCrluLRKhX5k97lc.jpeg?auto=format&w=260 260w,     https://web-dev.imgix.net/image/VbsHyyQopiec0718rMq2kTE1hke2/to1mQCrluLRKhX5k97lc.jpeg?auto=format&w=296 296w,     https://web-dev.imgix.net/image/VbsHyyQopiec0718rMq2kTE1hke2/to1mQCrluLRKhX5k97lc.jpeg?auto=format&w=338 338w,     https://web-dev.imgix.net/image/VbsHyyQopiec0718rMq2kTE1hke2/to1mQCrluLRKhX5k97lc.jpeg?auto=format&w=385 385w,     https://web-dev.imgix.net/image/VbsHyyQopiec0718rMq2kTE1hke2/to1mQCrluLRKhX5k97lc.jpeg?auto=format&w=439 439w,     https://web-dev.imgix.net/image/VbsHyyQopiec0718rMq2kTE1hke2/to1mQCrluLRKhX5k97lc.jpeg?auto=format&w=500 500w,     https://web-dev.imgix.net/image/VbsHyyQopiec0718rMq2kTE1hke2/to1mQCrluLRKhX5k97lc.jpeg?auto=format&w=571 571w,     https://web-dev.imgix.net/image/VbsHyyQopiec0718rMq2kTE1hke2/to1mQCrluLRKhX5k97lc.jpeg?auto=format&w=650 650w,     https://web-dev.imgix.net/image/VbsHyyQopiec0718rMq2kTE1hke2/to1mQCrluLRKhX5k97lc.jpeg?auto=format&w=741 741w,     https://web-dev.imgix.net/image/VbsHyyQopiec0718rMq2kTE1hke2/to1mQCrluLRKhX5k97lc.jpeg?auto=format&w=845 845w,     https://web-dev.imgix.net/image/VbsHyyQopiec0718rMq2kTE1hke2/to1mQCrluLRKhX5k97lc.jpeg?auto=format&w=964 964w,     https://web-dev.imgix.net/image/VbsHyyQopiec0718rMq2kTE1hke2/to1mQCrluLRKhX5k97lc.jpeg?auto=format&w=1098 1098w,     https://web-dev.imgix.net/image/VbsHyyQopiec0718rMq2kTE1hke2/to1mQCrluLRKhX5k97lc.jpeg?auto=format&w=1252 1252w,     https://web-dev.imgix.net/image/VbsHyyQopiec0718rMq2kTE1hke2/to1mQCrluLRKhX5k97lc.jpeg?auto=format&w=1428 1428w,     https://web-dev.imgix.net/image/VbsHyyQopiec0718rMq2kTE1hke2/to1mQCrluLRKhX5k97lc.jpeg?auto=format&w=1600 1600w"          width="1600"   />


<div class="post wrapper" data-flush>
  
    
    
    
  
  

  <div class="sidebar region flex-align-start flex-dir-rev flex-wrap-no">
    

  <nav class="course__toc toc over-scroll hidden-yes xl:hidden-no" data-type="side" aria-label="On this page">
    <div class="course-toc__heading font-google-sans weight-medium">On this page</div>
    <web-scroll-spy>
      <div class="toc__wrapper flow-recursive">
        <ul class="toc__list"><li class="toc__listitem"><a class="toc__anchor" href="#about-kapwing">About Kapwing</a></li><li class="toc__listitem"><a class="toc__anchor" href="#how-kapwing-brings-real-time-editing-and-collaboration-to-the-web">How Kapwing brings real-time editing and collaboration to the web</a><ul class="toc__list"><li class="toc__listitem"><a class="toc__anchor" href="#indexeddb">IndexedDB</a></li><li class="toc__listitem"><a class="toc__anchor" href="#web-audio-api">Web Audio API</a></li><li class="toc__listitem"><a class="toc__anchor" href="#webcodecs">WebCodecs</a></li></ul></li><li class="toc__listitem"><a class="toc__anchor" href="#what's-next">What's next?</a></li></ul>
      </div>
    </web-scroll-spy>
  </nav>


    
    <article class="prose legacy-rollout">
      <header class="flow gap-bottom-size-3">
        
          <nav class="breadcrumbs" aria-label="breadcrumbs">
            <ul class="breadcrumbs__list" role="list">
              <li>
                <a
                  class="gc-analytics-event"
                  data-category="web.dev"
                  data-label="post, home breadcrumb"
                  data-action="click"
                  href="/"
                >
                  Home
                </a>
              </li>
              
              <li>
                <a
                  class="gc-analytics-event"
                  data-category="web.dev"
                  data-label="post, path breadcrumb"
                  data-action="click"
                  href="/blog"
                >
                  All articles
                </a>
              </li>
              
            </ul>
          </nav>
        

        <h1 id="kapwing:-powerful-video-editing-for-the-web">Kapwing: Powerful video editing for the web</h1>
        
          <p class="color-mid-text flow-space-base">
            <p>Creators can now edit high-quality video content on the web with Kapwing, thanks to powerful APIs (like IndexedDB and WebCodecs) and performance tools.</p>

          </p>
        

        
          <div class="flow-space-size-1 color-mid-text text-size-0">
            <time>Dec 6, 2021</time>
            
          </div>
        

        
        

        

        
          <div class="cluster flow-space-size-2">
            
              <div class="author">
  <a class="avatar" href="/authors/joshuagrossberg/"> <img     alt="Joshua Grossberg"     class="w-author__image"     decoding="async"     height="64"          loading="lazy"     sizes="(min-width: 64px) 64px, calc(100vw - 48px)"     src="https://web-dev.imgix.net/image/VbsHyyQopiec0718rMq2kTE1hke2/ghjO05jRwr6p0GPCA8sQ.jpg?auto=format&fit=crop&h=64&w=64"     srcset="https://web-dev.imgix.net/image/VbsHyyQopiec0718rMq2kTE1hke2/ghjO05jRwr6p0GPCA8sQ.jpg?fit=crop&h=64&w=64&auto=format&dpr=1&q=75 1x,     https://web-dev.imgix.net/image/VbsHyyQopiec0718rMq2kTE1hke2/ghjO05jRwr6p0GPCA8sQ.jpg?fit=crop&h=64&w=64&auto=format&dpr=2&q=50 2x,     https://web-dev.imgix.net/image/VbsHyyQopiec0718rMq2kTE1hke2/ghjO05jRwr6p0GPCA8sQ.jpg?fit=crop&h=64&w=64&auto=format&dpr=3&q=35 3x,     https://web-dev.imgix.net/image/VbsHyyQopiec0718rMq2kTE1hke2/ghjO05jRwr6p0GPCA8sQ.jpg?fit=crop&h=64&w=64&auto=format&dpr=4&q=23 4x,     https://web-dev.imgix.net/image/VbsHyyQopiec0718rMq2kTE1hke2/ghjO05jRwr6p0GPCA8sQ.jpg?fit=crop&h=64&w=64&auto=format&dpr=5&q=20 5x"          width="64"   /> </a>
  <div class="flow">
    <cite class="author__name">
      <a href="/authors/joshuagrossberg/">Joshua Grossberg</a>
    </cite>
    <div class="author__links cluster">
               
               
               
               
             </div>
  </div>
</div>
            
          </div>
        
      </header>

      

      

  

  <div class="xl:hidden-yes flow-space-size-1">
    <details data-type="inner" role="navigation" aria-label="On this page">
      <summary>
        On this page
      </summary>
      <div class="toc"><ul class="toc__list"><li class="toc__listitem"><a class="toc__anchor" href="#about-kapwing">About Kapwing</a></li><li class="toc__listitem"><a class="toc__anchor" href="#how-kapwing-brings-real-time-editing-and-collaboration-to-the-web">How Kapwing brings real-time editing and collaboration to the web</a><ul class="toc__list"><li class="toc__listitem"><a class="toc__anchor" href="#indexeddb">IndexedDB</a></li><li class="toc__listitem"><a class="toc__anchor" href="#web-audio-api">Web Audio API</a></li><li class="toc__listitem"><a class="toc__anchor" href="#webcodecs">WebCodecs</a></li></ul></li><li class="toc__listitem"><a class="toc__anchor" href="#what's-next">What's next?</a></li></ul></div>
    </details>
  </div>



      <aside class="aside flow bg-state-info-bg color-state-info-text">
<div class=" flow">
<p>Joshua is the Chief Technology Officer at <a href="https://www.kapwing.com/" rel="noopener">Kapwing</a>.</p>
</div></aside>
<p>Online video consumption has grown rapidly since the start of the pandemic.
People are spending more time consuming endless high-quality video on
platforms such as TikTok, Instagram, and YouTube. Creatives and small business
owners all over the world need quick and easy-to-use tools to make video
content.</p>
<p>Companies like Kapwing make it possible to create all this video content right
on the web, by using the latest in powerful APIs and performance tools.</p>
<div class="youtube">  <lite-youtube    videoid="Df2U9-R-OJs"    videoStartAt="974"  >  </lite-youtube></div>
<h2 id="about-kapwing">About Kapwing <a class="w-headline-link" href="#about-kapwing">#</a></h2>
<p>Kapwing is a web-based collaborative video editor designed mainly for casual
creatives like game-streamers, musicians, YouTube creators, and meme-rs. It's
also a go-to resource for business owners who need an easy way to produce
their own social content, such as Facebook and Instagram ads.</p>
<p>People discover Kapwing by searching for a specific task, for example &quot;how to
trim a video,&quot; &quot;add music to my video,&quot; or &quot;resize a video.&quot; They can do what
they searched for with just one click—without the added friction of
navigating to an app store and downloading an app. The web makes it simple for
people to search for precisely what task they need help with, and then do it.</p>
<p>After that first click, Kapwing users can do a whole lot more. They can
explore free templates, add new layers of free stock videos, insert
subtitles, transcribe videos, and upload background music.</p>
<h2 id="how-kapwing-brings-real-time-editing-and-collaboration-to-the-web">How Kapwing brings real-time editing and collaboration to the web <a class="w-headline-link" href="#how-kapwing-brings-real-time-editing-and-collaboration-to-the-web">#</a></h2>
<p>While the web provides unique advantages, it also presents distinct
challenges. Kapwing needs to deliver smooth and precise playback of complex,
multi-layered projects across a wide range of devices and network conditions.
To achieve this, we use a variety of web APIs to achieve our performance and
feature goals.</p>
<aside class="aside flow bg-state-info-bg color-state-info-text">
<div class=" flow">
<p>Kapwing's work was featured at Chrome Developer Summit in November 2021.
<a href="https://www.youtube.com/watch?v=Df2U9-R-OJs&amp;t=974s" rel="noopener">Watch the keynote</a> for
an overview of Kapwing's work, and keep reading to take a closer look at the
technical implementation.</p>
</div></aside>
<h3 id="indexeddb">IndexedDB <a class="w-headline-link" href="#indexeddb">#</a></h3>
<p>High performance editing requires that all of our users' content live on the
client, avoiding the network whenever possible. Unlike a streaming service,
where users typically access a piece of content once, our customers reuse
their assets frequently, days and even months after upload.</p>
<p><a href="/storage-for-the-web/">IndexedDB</a> allows us to provide persistent file
system-like storage to our users. The result is that over 90% of media
requests in the app are fulfilled locally. Integrating IndexedDB into our
system was very straightforward.</p>
<p>Here is some boiler plate initialization code that runs on app load:</p>
<web-copy-code><pre class="language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span>DBSchema<span class="token punctuation">,</span> openDB<span class="token punctuation">,</span> deleteDB<span class="token punctuation">,</span> IDBPDatabase<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'idb'</span><span class="token punctuation">;</span><br><br><span class="token keyword">let</span> openIdb<span class="token operator">:</span> Promise <span class="token operator">&lt;</span>IDBPDatabase<span class="token operator">&lt;</span>Schema<span class="token operator">>></span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> db <span class="token operator">=</span><br>  <span class="token punctuation">(</span><span class="token keyword">await</span> openDB<span class="token punctuation">)</span> <span class="token operator">&lt;</span><br>  Schema <span class="token operator">></span><br>  <span class="token punctuation">(</span><br>    <span class="token string">'kapwing'</span><span class="token punctuation">,</span><br>    version<span class="token punctuation">,</span> <span class="token punctuation">{</span><br>      <span class="token function">upgrade</span><span class="token punctuation">(</span><span class="token parameter">db<span class="token punctuation">,</span> oldVersion</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldVersion <span class="token operator">>=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>          <span class="token comment">// assets store schema changed, need to recreate</span><br>          db<span class="token punctuation">.</span><span class="token function">deleteObjectStore</span><span class="token punctuation">(</span><span class="token string">'assets'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br><br>        db<span class="token punctuation">.</span><span class="token function">createObjectStore</span><span class="token punctuation">(</span><span class="token string">'assets'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><br>          keyPath<span class="token operator">:</span> <span class="token string">'mediaLibraryID'</span><br>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><span class="token punctuation">,</span><br>      <span class="token keyword">async</span> <span class="token function">blocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">await</span> <span class="token function">deleteDB</span><span class="token punctuation">(</span><span class="token string">'kapwing'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><span class="token punctuation">,</span><br>      <span class="token keyword">async</span> <span class="token function">blocking</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">await</span> <span class="token function">deleteDB</span><span class="token punctuation">(</span><span class="token string">'kapwing'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><span class="token punctuation">,</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</web-copy-code><p>We pass a version and define an <code>upgrade</code> function. This is used for
initialization or to update our schema when necessary. We pass error-handling
callbacks, <code>blocked</code> and <code>blocking</code>, which we've found useful in
preventing issues for users with unstable systems.</p>
<p>Finally, note our definition of a primary key <code>keyPath</code>. In our case, this is a
unique ID we call <code>mediaLibraryID</code>. When a user adds a piece of media to our system, whether via our uploader or a third party extension, we add the media
to our media library with the following code:</p>
<web-copy-code><pre class="language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">addAsset</span><span class="token punctuation">(</span><span class="token parameter">mediaLibraryID<span class="token operator">:</span> string<span class="token punctuation">,</span> file<span class="token operator">:</span> File</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> <span class="token function">runWithAssetMutex</span><span class="token punctuation">(</span>mediaLibraryID<span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> assetAlreadyInStore <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token punctuation">(</span><span class="token keyword">await</span> openIdb<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><br>      <span class="token string">'assets'</span><span class="token punctuation">,</span><br>      mediaLibraryID<br>    <span class="token punctuation">)</span><span class="token punctuation">;</span>    <br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>assetAlreadyInStore<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span><br>        <br>    <span class="token keyword">const</span> idbVideo<span class="token operator">:</span> IdbVideo <span class="token operator">=</span> <span class="token punctuation">{</span><br>      file<span class="token punctuation">,</span><br>      mediaLibraryID<span class="token punctuation">,</span><br>    <span class="token punctuation">}</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">await</span> <span class="token punctuation">(</span><span class="token keyword">await</span> openIdb<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'assets'</span><span class="token punctuation">,</span> idbVideo<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
</web-copy-code><p><code>runWithAssetMutex</code> is our own internally defined function that serializes
IndexedDB access. This is required for any read-modify-write type operations,
as the IndexedDB API is asynchronous.</p>
<p>Now let's take a look at how we access files. Below is our <code>getAsset</code> function:</p>
<web-copy-code><pre class="language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getAsset</span><span class="token punctuation">(</span><br>  <span class="token parameter">mediaLibraryID<span class="token operator">:</span> string<span class="token punctuation">,</span><br>  source<span class="token operator">:</span> LayerSource <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span><br>  location<span class="token operator">:</span> string</span><br><span class="token punctuation">)</span><span class="token operator">:</span> Promise<span class="token operator">&lt;</span>IdbAsset <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token operator">></span> <span class="token punctuation">{</span><br>  <span class="token keyword">let</span> asset<span class="token operator">:</span> IdbAsset <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> <span class="token punctuation">{</span> idbCache <span class="token punctuation">}</span> <span class="token operator">=</span> window<span class="token punctuation">;</span><br>  <span class="token keyword">const</span> assetInCache <span class="token operator">=</span> idbCache<span class="token punctuation">[</span>mediaLibraryID<span class="token punctuation">]</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>assetInCache <span class="token operator">&amp;&amp;</span> assetInCache<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token string">'complete'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    asset <span class="token operator">=</span> assetInCache<span class="token punctuation">.</span>asset<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>assetInCache <span class="token operator">&amp;&amp;</span> assetInCache<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    asset <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>      assetInCache<span class="token punctuation">.</span>subscribers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <br>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>    idbCache<span class="token punctuation">[</span>mediaLibraryID<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> subscribers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> status<span class="token operator">:</span> <span class="token string">'pending'</span> <span class="token punctuation">}</span><span class="token punctuation">;</span><br>    asset <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">await</span> openIdb<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'assets'</span><span class="token punctuation">,</span> mediaLibraryID<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    idbCache<span class="token punctuation">[</span>mediaLibraryID<span class="token punctuation">]</span><span class="token punctuation">.</span>asset <span class="token operator">=</span> asset<span class="token punctuation">;</span><br>    idbCache<span class="token punctuation">[</span>mediaLibraryID<span class="token punctuation">]</span><span class="token punctuation">.</span>subscribers<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res<span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>      <span class="token function">res</span><span class="token punctuation">(</span>asset<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">delete</span> <span class="token punctuation">(</span>idbCache<span class="token punctuation">[</span>mediaLibraryID<span class="token punctuation">]</span> <span class="token keyword">as</span> any<span class="token punctuation">)</span><span class="token punctuation">.</span>subscribers<span class="token punctuation">;</span><br><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>asset<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      idbCache<span class="token punctuation">[</span>mediaLibraryID<span class="token punctuation">]</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'complete'</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>      idbCache<span class="token punctuation">[</span>mediaLibraryID<span class="token punctuation">]</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'failed'</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span> <br>  <span class="token keyword">return</span> asset<span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
</web-copy-code><p>We have our own data structure, <code>idbCache</code>, that is used to minimize IndexedDB
accesses. While IndexedDB is fast, accessing local memory is faster. We
recommend this approach so long as you manage the size of the cache.</p>
<p>The <code>subscribers</code> array, which is used to prevent simultaneous access to
IndexedDB, would otherwise be common on load.</p>
<h3 id="web-audio-api">Web Audio API <a class="w-headline-link" href="#web-audio-api">#</a></h3>
<p>Audio visualization is incredibly important for video editing. To understand
why, take a look at a screenshot from the editor:</p>
<img     alt="Kapwing&#x27;s editor has a menu for media, including several templates and custom elements, including some templates which are specific to certain platforms like LinkedIn; a timeline which separates video, audio, and animation; canvas editor with export quality options; a preview of the video; and more capabilities."          decoding="async"     height="397"          loading="lazy"     sizes="(min-width: 800px) 800px, calc(100vw - 48px)"     src="https://web-dev.imgix.net/image/VbsHyyQopiec0718rMq2kTE1hke2/6MqSyhNqFl23wN3GWKbP.png?auto=format"     srcset="https://web-dev.imgix.net/image/VbsHyyQopiec0718rMq2kTE1hke2/6MqSyhNqFl23wN3GWKbP.png?auto=format&w=200 200w,     https://web-dev.imgix.net/image/VbsHyyQopiec0718rMq2kTE1hke2/6MqSyhNqFl23wN3GWKbP.png?auto=format&w=228 228w,     https://web-dev.imgix.net/image/VbsHyyQopiec0718rMq2kTE1hke2/6MqSyhNqFl23wN3GWKbP.png?auto=format&w=260 260w,     https://web-dev.imgix.net/image/VbsHyyQopiec0718rMq2kTE1hke2/6MqSyhNqFl23wN3GWKbP.png?auto=format&w=296 296w,     https://web-dev.imgix.net/image/VbsHyyQopiec0718rMq2kTE1hke2/6MqSyhNqFl23wN3GWKbP.png?auto=format&w=338 338w,     https://web-dev.imgix.net/image/VbsHyyQopiec0718rMq2kTE1hke2/6MqSyhNqFl23wN3GWKbP.png?auto=format&w=385 385w,     https://web-dev.imgix.net/image/VbsHyyQopiec0718rMq2kTE1hke2/6MqSyhNqFl23wN3GWKbP.png?auto=format&w=439 439w,     https://web-dev.imgix.net/image/VbsHyyQopiec0718rMq2kTE1hke2/6MqSyhNqFl23wN3GWKbP.png?auto=format&w=500 500w,     https://web-dev.imgix.net/image/VbsHyyQopiec0718rMq2kTE1hke2/6MqSyhNqFl23wN3GWKbP.png?auto=format&w=571 571w,     https://web-dev.imgix.net/image/VbsHyyQopiec0718rMq2kTE1hke2/6MqSyhNqFl23wN3GWKbP.png?auto=format&w=650 650w,     https://web-dev.imgix.net/image/VbsHyyQopiec0718rMq2kTE1hke2/6MqSyhNqFl23wN3GWKbP.png?auto=format&w=741 741w,     https://web-dev.imgix.net/image/VbsHyyQopiec0718rMq2kTE1hke2/6MqSyhNqFl23wN3GWKbP.png?auto=format&w=845 845w,     https://web-dev.imgix.net/image/VbsHyyQopiec0718rMq2kTE1hke2/6MqSyhNqFl23wN3GWKbP.png?auto=format&w=964 964w,     https://web-dev.imgix.net/image/VbsHyyQopiec0718rMq2kTE1hke2/6MqSyhNqFl23wN3GWKbP.png?auto=format&w=1098 1098w,     https://web-dev.imgix.net/image/VbsHyyQopiec0718rMq2kTE1hke2/6MqSyhNqFl23wN3GWKbP.png?auto=format&w=1252 1252w,     https://web-dev.imgix.net/image/VbsHyyQopiec0718rMq2kTE1hke2/6MqSyhNqFl23wN3GWKbP.png?auto=format&w=1428 1428w,     https://web-dev.imgix.net/image/VbsHyyQopiec0718rMq2kTE1hke2/6MqSyhNqFl23wN3GWKbP.png?auto=format&w=1600 1600w"          width="800"   />
<p>This is a YouTube style video, which is common in our app. The user doesn't
move very much throughout the clip, so the timelines visual thumbnails aren't
as useful for navigating between sections. On the other hand, the audio
<a href="https://en.wikipedia.org/wiki/Waveform" rel="noopener">waveform</a> shows peaks and valleys,
with the valleys typically corresponding to dead time in the recording. If you
zoom in on the timeline, you'd see more fine grained audio information with
valleys corresponding to stutters and pauses.</p>
<p>Our user research shows that creators are often guided by these waveforms as
they splice their content. The web audio API allows us to present this
information performantly and to update quickly on a zoom or pan of the
timeline.</p>
<p>The snippet below demonstrates how we do this:</p>
<web-copy-code><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">getDownsampledBuffer</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">idbAsset<span class="token operator">:</span> IdbAsset</span><span class="token punctuation">)</span> <span class="token operator">=></span><br>  decodeMutex<span class="token punctuation">.</span><span class="token function">runExclusive</span><span class="token punctuation">(</span><br>    <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Promise<span class="token operator">&lt;</span>Float32Array<span class="token operator">></span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>      <span class="token keyword">const</span> arrayBuffer <span class="token operator">=</span> <span class="token keyword">await</span> idbAsset<span class="token punctuation">.</span>file<span class="token punctuation">.</span><span class="token function">arrayBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token keyword">const</span> audioContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AudioContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token keyword">const</span> audioBuffer <span class="token operator">=</span> <span class="token keyword">await</span> audioContext<span class="token punctuation">.</span><span class="token function">decodeAudioData</span><span class="token punctuation">(</span>arrayBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>      <span class="token keyword">const</span> offline <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OfflineAudioContext</span><span class="token punctuation">(</span><br>        audioBuffer<span class="token punctuation">.</span>numberOfChannels<span class="token punctuation">,</span><br>        audioBuffer<span class="token punctuation">.</span>duration <span class="token operator">*</span> <span class="token constant">MIN_BROWSER_SUPPORTED_SAMPLE_RATE</span><span class="token punctuation">,</span><br>        <span class="token constant">MIN_BROWSER_SUPPORTED_SAMPLE_RATE</span><br>      <span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>      <span class="token keyword">const</span> downsampleSource <span class="token operator">=</span> offline<span class="token punctuation">.</span><span class="token function">createBufferSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      downsampleSource<span class="token punctuation">.</span>buffer <span class="token operator">=</span> audioBuffer<span class="token punctuation">;</span><br>      downsampleSource<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      downsampleSource<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>offline<span class="token punctuation">.</span>destination<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>      <span class="token keyword">const</span> downsampledBuffer22K <span class="token operator">=</span> <span class="token keyword">await</span> offline<span class="token punctuation">.</span><span class="token function">startRendering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>      <span class="token keyword">const</span> downsampledBuffer22KData <span class="token operator">=</span> downsampledBuffer22K<span class="token punctuation">.</span><span class="token function">getChannelData</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>      <span class="token keyword">const</span> downsampledBuffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><br>        Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span><br>          downsampledBuffer22KData<span class="token punctuation">.</span>length <span class="token operator">/</span> <span class="token constant">POST_BROWSER_SAMPLE_INTERVAL</span><br>        <span class="token punctuation">)</span><br>      <span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>      <span class="token keyword">for</span> <span class="token punctuation">(</span><br>        <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><br>        i <span class="token operator">&lt;</span> downsampledBuffer22KData<span class="token punctuation">.</span>length<span class="token punctuation">;</span><br>        i <span class="token operator">+=</span> <span class="token constant">POST_BROWSER_SAMPLE_INTERVAL</span><span class="token punctuation">,</span> j <span class="token operator">+=</span> <span class="token number">1</span><br>      <span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">let</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><br>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> <span class="token constant">POST_BROWSER_SAMPLE_INTERVAL</span><span class="token punctuation">;</span> k <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>          sum <span class="token operator">+=</span> Math<span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span>downsampledBuffer22KData<span class="token punctuation">[</span>i <span class="token operator">+</span> k<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br>        <span class="token keyword">const</span> avg <span class="token operator">=</span> sum <span class="token operator">/</span> <span class="token constant">POST_BROWSER_SAMPLE_INTERVAL</span><span class="token punctuation">;</span><br>        downsampledBuffer<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> avg<span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><br><br>      <span class="token keyword">return</span> downsampledBuffer<span class="token punctuation">;</span><br>    <span class="token punctuation">}</span> <br>  <span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</web-copy-code><p>We pass this helper the asset that is stored in IndexedDB. Upon completion we
will update the asset in IndexedDB as well as our own cache.</p>
<p>We gather data about the <code>audioBuffer</code> with the <code>AudioContext</code> constructor,
but because we aren't rendering to the device hardware we use the
<code>OfflineAudioContext</code> to render to an <code>ArrayBuffer</code> where we will store
amplitude data.</p>
<p>The API itself returns data at a sample rate much higher than needed for
effective visualization. That's why we manually downsample to 200 Hz, which we
found to be enough for useful, visually appealing waveforms.</p>
<h3 id="webcodecs">WebCodecs <a class="w-headline-link" href="#webcodecs">#</a></h3>
<p>For certain videos the track thumbnails are more useful for timeline
navigation than the waveforms. However, generating thumbnails is more resource
intensive than generating waveforms.</p>
<p>We can't cache every potential thumbnail on load, so quick decode on timeline
pan/zoom is critical to a performant and responsive application. The
bottleneck to achieving smooth frame drawing is decoding frames, which until
recently we did using an HTML5 video player. The performance of that approach
wasn't reliable and we often saw degraded app responsiveness during frame
rendering.</p>
<p>Recently we have moved over to <a href="/webcodecs/">WebCodecs</a>, which can be used in
web workers. This should enhance our ability to draw thumbnails for large
amounts of layers  without impacting main thread performance. While the web
worker implementation  is still in progress, we give an outline below of our
existing main thread implementation.</p>
<p>A video file contains multiple streams: video, audio, subtitles and so on that
are 'muxed' together. To use WebCodecs, we first need to have a demuxed video
stream. We demux mp4s with the mp4box library, as shown here:</p>
<web-copy-code><pre class="language-js"><code class="language-js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token parameter">demuxer<span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  demuxer<span class="token punctuation">.</span>file <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">await</span> MP4Box<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  demuxer<span class="token punctuation">.</span>file<span class="token punctuation">.</span><span class="token function-variable function">onReady</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">info<span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    demuxer<span class="token punctuation">.</span>info <span class="token operator">=</span> info<span class="token punctuation">;</span><br>    demuxer<span class="token punctuation">.</span><span class="token function">_info_resolver</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br>  demuxer<span class="token punctuation">.</span><span class="token function">loadMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">const</span> <span class="token function-variable function">loadMetadata</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">let</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> asset <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getAsset</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mediaLibraryId<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> maxFetchOffset <span class="token operator">=</span> asset<span class="token operator">?.</span>file<span class="token punctuation">.</span>size <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">const</span> end <span class="token operator">=</span> offset <span class="token operator">+</span> <span class="token constant">FETCH_SIZE</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span><br>    headers<span class="token operator">:</span> <span class="token punctuation">{</span> range<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">bytes=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>offset<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>end<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> reader <span class="token operator">=</span> response<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">getReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">let</span> done<span class="token punctuation">,</span> value<span class="token punctuation">;</span><br>  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token punctuation">(</span><span class="token punctuation">{</span> done<span class="token punctuation">,</span> value <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> reader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token keyword">this</span><span class="token punctuation">.</span>file<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token keyword">break</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">const</span> buf<span class="token operator">:</span> ArrayBufferLike <span class="token operator">&amp;</span> <span class="token punctuation">{</span> fileStart<span class="token operator">?</span><span class="token operator">:</span> number <span class="token punctuation">}</span> <span class="token operator">=</span> value<span class="token punctuation">.</span>buffer<span class="token punctuation">;</span><br>    buf<span class="token punctuation">.</span>fileStart <span class="token operator">=</span> offset<span class="token punctuation">;</span><br>    offset <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>file<span class="token punctuation">.</span><span class="token function">appendBuffer</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
</web-copy-code><p>This snippet refers to a <code>demuxer</code> class, which we use to encapsulate the
interface to <code>MP4Box</code>. We once again access the asset from IndexedDB. These
segments aren't necessarily stored in byte order, and that the <code>appendBuffer</code>
method returns the offset of the next chunk.</p>
<p>Here's how we decode a video frame:</p>
<web-copy-code><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> getFrameFromVideoDecoder <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>demuxer<span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token operator">:</span> Promise<span class="token operator">&lt;</span>any<span class="token operator">></span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">let</span> desiredSampleIndex <span class="token operator">=</span> demuxer<span class="token punctuation">.</span><span class="token function">getFrameIndexForTimestamp</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>frameTime<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">let</span> timestampToMatch<span class="token operator">:</span> number<span class="token punctuation">;</span><br>  <span class="token keyword">let</span> decodedSample<span class="token operator">:</span> VideoFrame <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">const</span> <span class="token function-variable function">outputCallback</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">frame<span class="token operator">:</span> VideoFrame</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>frame<span class="token punctuation">.</span>timestamp <span class="token operator">===</span> timestampToMatch<span class="token punctuation">)</span> decodedSample <span class="token operator">=</span> frame<span class="token punctuation">;</span><br>    <span class="token keyword">else</span> frame<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span>  <br><br>  <span class="token keyword">const</span> decoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VideoDecoder</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>    output<span class="token operator">:</span> outputCallback<span class="token punctuation">,</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <br>  <span class="token keyword">const</span> <span class="token punctuation">{</span><br>    codec<span class="token punctuation">,</span><br>    codecWidth<span class="token punctuation">,</span><br>    codecHeight<span class="token punctuation">,</span><br>    description<span class="token punctuation">,</span><br>  <span class="token punctuation">}</span> <span class="token operator">=</span> demuxer<span class="token punctuation">.</span><span class="token function">getDecoderConfigurationInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  decoder<span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span><span class="token punctuation">{</span> codec<span class="token punctuation">,</span> codecWidth<span class="token punctuation">,</span> codecHeight<span class="token punctuation">,</span> description <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <br><br>  <span class="token comment">/* begin demuxer interface */</span><br>  <span class="token keyword">const</span> preceedingKeyFrameIndex <span class="token operator">=</span> demuxer<span class="token punctuation">.</span><span class="token function">getPreceedingKeyFrameIndex</span><span class="token punctuation">(</span><br>    desiredSampleIndex<br>  <span class="token punctuation">)</span><span class="token punctuation">;</span>  <br>  <span class="token keyword">const</span> trak_id <span class="token operator">=</span> demuxer<span class="token punctuation">.</span>trak_id<br>  <span class="token keyword">const</span> trak <span class="token operator">=</span> demuxer<span class="token punctuation">.</span>moov<span class="token punctuation">.</span>traks<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">trak<span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=></span> trak<span class="token punctuation">.</span>tkhd<span class="token punctuation">.</span>track_id <span class="token operator">===</span> trak_id<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> demuxer<span class="token punctuation">.</span><span class="token function">getFrameDataRange</span><span class="token punctuation">(</span><br>    preceedingKeyFrameIndex<span class="token punctuation">,</span><br>    desiredSampleIndex<br>  <span class="token punctuation">)</span><span class="token punctuation">;</span>  <br>  <span class="token comment">/* end demuxer interface */</span><br><br>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> preceedingKeyFrameIndex<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> desiredSampleIndex<span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> sample <span class="token operator">=</span> trak<span class="token punctuation">.</span>samples<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span><br>    <span class="token keyword">const</span> sampleData <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">readNBytes</span><span class="token punctuation">(</span><br>      sample<span class="token punctuation">.</span>offset<span class="token punctuation">,</span><br>      sample<span class="token punctuation">.</span>size<br>    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <br><br>    <span class="token keyword">const</span> sampleType <span class="token operator">=</span> sample<span class="token punctuation">.</span>is_sync <span class="token operator">?</span> <span class="token string">'key'</span> <span class="token operator">:</span> <span class="token string">'delta'</span><span class="token punctuation">;</span><br>    <span class="token keyword">const</span> encodedFrame <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EncodedVideoChunk</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>      sampleType<span class="token punctuation">,</span><br>      timestamp<span class="token operator">:</span> sample<span class="token punctuation">.</span>cts<span class="token punctuation">,</span><br>      duration<span class="token operator">:</span> sample<span class="token punctuation">.</span>duration<span class="token punctuation">,</span><br>      samapleData<span class="token punctuation">,</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <br><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">===</span> desiredSampleIndex<span class="token punctuation">)</span><br>      timestampToMatch <span class="token operator">=</span> encodedFrame<span class="token punctuation">.</span>timestamp<span class="token punctuation">;</span><br>    decoder<span class="token punctuation">.</span><span class="token function">decodeEncodedFrame</span><span class="token punctuation">(</span>encodedFrame<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span> <br>  <span class="token punctuation">}</span><br>  <span class="token keyword">await</span> decoder<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">return</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">'value'</span><span class="token punctuation">,</span> value<span class="token operator">:</span> decodedSample <span class="token punctuation">}</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
</web-copy-code><p>The structure of the demuxer is quite complex and beyond the scope of this
article. It stores each frame in an array titled <code>samples</code>. We use the demuxer
to find the closest preceding key frame to our desired timestamp, which is
where we must begin video decode.</p>
<p>Videos are composed of full frames, known as key or i-frames, as well as much
smaller delta frames, often referred to as p- or b-frames. Decode must always
begin at a key frame.</p>
<p>The application decodes frames by:</p>
<ol>
<li>Instantiating the decoder with a frame output callback.</li>
<li>Configuring the decoder for the specific codec and input resolution.</li>
<li>Creating an <code>encodedVideoChunk</code> using data from the demuxer.</li>
<li>Calling the <code>decodeEncodedFrame</code> method.</li>
</ol>
<p>We do this until we reach the frame with the desired timestamp.</p>
<h2 id="what's-next">What's next? <a class="w-headline-link" href="#what's-next">#</a></h2>
<p>We define scale on our frontend as the ability to maintain precise and
performant playback as projects get larger and more complex. One way to scale
performance is to mount as few videos as possible at once, however when we do
this, we risk slow and choppy transitions. While we've developed internal
systems to cache video components for reuse, there are limitations to how much
control HTML5 video tags can provide.</p>
<p>In the future, we may attempt to play all media using WebCodecs. This could
allow us to be very precise about what data we buffer which should help scale
performance.</p>
<p>We can also do a better job of offloading large trackpad computations to
<a href="/off-main-thread/">web workers</a>, and we can be smarter about pre-fetching
files and pre-generating frames. We see large opportunities to optimize our
overall application performance and to extend functionality with tools like
<a href="https://developer.mozilla.org/docs/Web/API/WebGL_API" rel="noopener">WebGL</a>.</p>
<p>We would like to continue our investment in
<a href="https://www.tensorflow.org/js" rel="noopener">TensorFlow.js</a>, which we currently use for
intelligent background removal. We plan to leverage TensorFlow.js for other
sophisticated tasks such as object detection, feature extraction, style transfer, and so on.</p>
<p>Ultimately, we're excited to continue builing our product with native-like
performance and functionality on a free and open web.</p>


      

      <div class="cluster gutter-base flow-space-size-2" role="list" aria-label="tags">
        
          
        
          
        
          
            
            <a class="pill" href="/tags/case-study/">Case Study</a>
          
        
          
            
            <a class="pill" href="/tags/capabilities/">Capabilities</a>
          
        
          
            
            <a class="pill" href="/tags/progressive-web-apps/">Progressive Web Apps</a>
          
        
      </div>

      <div class="text-size-0 color-mid-text">
        <span>
          
          Last updated: <time>Dec 6, 2021</time>
          
        </span>
        —
        <a
          href="https://github.com/GoogleChrome/web.dev/blob/main/src/site/content/en/blog/kapwing/index.md"
        >
          Improve article
        </a>
      </div>

      

      
        
        
      

      
        <div class="flow-space-size-2">
          <a href="/blog" class="button" data-type="secondary">
            <svg xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>

            <span>Return to all articles</span>
          </a>
        </div>
      
      <div class="docked-actions flow flow-space-base">    
        <div>
          <share-action class="gc-analytics-event fab"
            authors="Joshua Grossberg"
            data-category="web.dev"
            data-label="share"
            data-action="click"
            data-type="primary"
            data-icon="share"
            tabindex="0"
            role="button"
          >
            <svg xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 24 24"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M18 16.1c-.8 0-1.4.3-2 .8l-7.1-4.2c.1-.2.1-.5.1-.7s0-.5-.1-.7L16 7.2c.5.5 1.2.8 2 .8 1.7 0 3-1.3 3-3s-1.3-3-3-3-3 1.3-3 3c0 .2 0 .5.1.7L8 9.8C7.5 9.3 6.8 9 6 9c-1.7 0-3 1.3-3 3s1.3 3 3 3c.8 0 1.5-.3 2-.8l7.1 4.2c-.1.2-.1.4-.1.6 0 1.6 1.3 2.9 2.9 2.9s2.9-1.3 2.9-2.9-1.2-2.9-2.8-2.9z" fill="currentColor"/></svg>
 
            <span class="fab__label">Share</span>
          </share-action>
        </div>
        
      </div>
    </article>
  </div>
</div>


</main>
<footer class="site-footer" role="contentinfo">
  <nav class="site-footer__primary-nav auto-grid" aria-label="footer navigation">
    <div>
      <h3 class="text-size-2 color-mid-text">Contribute</h3>
      <ul class="w-footer__linkbox-list" role="list">
        <li>
          <a href="https://github.com/GoogleChrome/web.dev/issues/new?assignees=&labels=bug&template=bug_report.md&title="
            data-category="Site-Wide Custom Events" data-label="Footer Link (index 1)">
            File a bug
          </a>
        </li>
        <li>
          <a href="https://github.com/googlechrome/web.dev"
            data-category="Site-Wide Custom Events" data-label="Footer Link (index 2)">
            View source
          </a>
        </li>
      </ul>
    </div>
    <div>
      <h3 class="text-size-2 color-mid-text">Related content</h3>
      <ul class="w-footer__linkbox-list" role="list">
          <li>
          <a href="https://developer.chrome.com/"
            data-category="Site-Wide Custom Events" data-label="Footer Link (index 1)">
            developer.chrome.com
          </a>
        </li>
        <li>
          <a href="https://blog.chromium.org/"
            data-category="Site-Wide Custom Events" data-label="Footer Link (index 1)">
            Chrome updates
          </a>
        </li>
        <li>
          <a href="https://developers.google.com/web/fundamentals"
            data-category="Site-Wide Custom Events" data-label="Footer Link (index 2)">
            Web Fundamentals
          </a>
        </li>
        <li>
          <a href="/tags/case-study/"
            data-category="Site-Wide Custom Events" data-label="Footer Link (index 3)">
            Case studies
          </a>
        </li>
        <li>
          <a href="/podcasts/"
            data-category="Podcasts" data-label="Footer Link (index 5)">
            Podcasts
          </a>
        </li>
        <li>
          <a href="/shows/"
            data-category="Shows" data-label="Footer Link (index 6)">
            Shows
          </a>
        </li>
      </ul>
    </div>
    <div>
      <h3 class="text-size-2 color-mid-text">Connect</h3>
      <ul class="w-footer__linkbox-list" role="list">
        <li>
          <a href="https://www.twitter.com/ChromiumDev"
            data-category="Site-Wide Custom Events" data-label="Footer Link (index 1)">
            Twitter
          </a>
        </li>
        <li>
          <a href="https://www.youtube.com/user/ChromeDevelopers"
            data-category="Site-Wide Custom Events" data-label="Footer Link (index 2)">
            YouTube
          </a>
        </li>
      </ul>
    </div>
  </nav>
  <nav class="site-footer__brand-nav repel" aria-label="Google developers">
    <ul class="cluster" role="list">
      <li>
        <a href="https://developers.google.com/" data-category="Site-Wide Custom Events" data-label="Footer Google Developers Link">
          <img loading="lazy" width="185" height="33" class="w-footer__utility-logo" src="/images/lockup-color.png"
            alt="Google Developers" />
        </a>
      </li>
      <li>
        <a href="https://developer.chrome.com/"
          data-category="Site-Wide Custom Events" data-label="Footer Chrome Link">
          Chrome
        </a>
      </li>
      <li>
        <a href="https://firebase.google.com/" data-category="Site-Wide Custom Events"
          data-label="Footer Firebase Link">
          Firebase
        </a>
      </li>
      <li>
        <a href="https://cloud.google.com/" data-category="Site-Wide Custom Events"
          data-label="Footer Google Cloud Platform Link">
          Google Cloud Platform
        </a>
      </li>
      <li>
        <a href="https://developers.google.com/products"
          data-category="Site-Wide Custom Events" data-label="Footer All products Link">
          All products
        </a>
      </li>
    </ul>
    <web-language-select current="en"></web-language-select>
  </nav>
  <nav class="site-footer__misc-links" aria-label="terms and policies">
    <ul class="cluster" role="list">
      <li>
        <a href="https://policies.google.com/" data-category="Site-Wide Custom Events"
          data-label="Footer Terms and Privacy link">
          Terms &amp; Privacy
        </a>
      </li>
      <li>
        <a href="/community-guidelines/" data-category="Site-Wide Custom Events"
          data-label="Footer Community Guidelines link">
          Community Guidelines
        </a>
      </li>
    </ul>
  </nav>
  <p class="gap-top-size-2 text-size-0">
    Except as otherwise noted, the content of this page is licensed
    under the
    <a href="https://creativecommons.org/licenses/by/4.0/">
    Creative Commons Attribution 4.0 License</a>,
    and code samples are licensed under the
    <a href="https://www.apache.org/licenses/LICENSE-2.0">
    Apache 2.0 License</a>. For details, see the
    <a href="https://developers.google.com/terms/site-policies">
    Google Developers Site Policies</a>.
  </p>
</footer>


  </body>
</html>
