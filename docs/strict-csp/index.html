
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">


  
<script>
  // A global function that the theme toggle can use to apply the current theme.
  window.applyThemeSetting = function(override) {
    const currentSetting = override || localStorage.getItem('user-color-scheme');
    const currentAttribute = document.documentElement.getAttribute('data-user-theme');

    if (currentSetting && currentSetting !== currentAttribute) {
      document.documentElement.setAttribute('data-user-theme', currentSetting);
    }
  };
window.applyThemeSetting();
</script>

  
  <link rel="stylesheet" href="/css/next.css?v=d16f24f727161">
  <link rel="stylesheet" href="/css/legacy-rollout.css?v=f6aeb1eb635ea">
  <link rel="preload" as="font" crossorigin href="/fonts/material-icons/regular.woff2">


<link rel="preload" as="font" crossorigin href="/fonts/google-sans/regular/latin.woff2">
<link rel="preload" as="font" crossorigin href="/fonts/google-sans/bold/latin.woff2">

<meta name="theme-color" content="#fff"/>




<title>Mitigate cross-site scripting (XSS) with a strict Content Security Policy (CSP)</title>
<meta name="description" content="Learn how to deploy a CSP based on script nonces or hashes as a defense-in-depth against cross-site scripting. " />

<link rel="canonical" href="https://web.dev/strict-csp/" />

<meta itemprop="name" content="Mitigate cross-site scripting (XSS) with a strict Content Security Policy (CSP)" />
<meta itemprop="description" content="Learn how to deploy a CSP based on script nonces or hashes as a defense-in-depth against cross-site scripting. " />
<meta itemprop="image" content="https://web-dev.imgix.net/image/3lmWcR1VGYVMicNlBh4aZWBTcSg1/mhE0NYvP3JFyvNyiQ1dj.jpg?auto=format&fit=max&w=1200&fm=auto" />
<meta property="og:locale" content="en_US" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://web.dev/strict-csp/" />
<meta property="og:site_name" content="web.dev" />
<meta property="og:title" content="Mitigate cross-site scripting (XSS) with a strict Content Security Policy (CSP)" />
<meta property="og:description" content="Learn how to deploy a CSP based on script nonces or hashes as a defense-in-depth against cross-site scripting. " />
<meta property="og:image" content="https://web-dev.imgix.net/image/3lmWcR1VGYVMicNlBh4aZWBTcSg1/mhE0NYvP3JFyvNyiQ1dj.jpg?auto=format&fit=max&w=1200&fm=auto" />
<meta property="og:image:alt" content="A screenshot of JavaScript code setting a strict Content Security Policy." />
<meta property="tag" content="security" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="Mitigate cross-site scripting (XSS) with a strict Content Security Policy (CSP)" />
<meta name="twitter:description" content="Learn how to deploy a CSP based on script nonces or hashes as a defense-in-depth against cross-site scripting. " />
<meta name="twitter:image" content="https://web-dev.imgix.net/image/3lmWcR1VGYVMicNlBh4aZWBTcSg1/mhE0NYvP3JFyvNyiQ1dj.jpg?auto=format&fit=max&w=1200&fm=auto" />
<link
  rel="alternate"
  href="/feed.xml"
  type="application/atom+xml"
  data-title="web.dev feed"
/>

<link rel="manifest" href="/manifest.webmanifest" />

<link rel="shortcut icon" href="/images/favicon.ico">
<link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
<link rel="mask-icon" color="#0054ff" href="/images/safari-pinned-tab.svg">



<script>
window.ga =
  window.ga ||
  function () {
    (ga.q = ga.q || []).push(arguments);
  };
ga.l = +new Date();
ga('create', 'UA-126406676-2');
ga('set', 'transport', 'beacon');
ga('set', 'anonymizeIp', true);
ga('set', 'page', window.location.pathname);
ga('set', 'dimension5', '4');
ga('send', 'pageview');
</script>







<script>
function loadScript(url, type) {
  const s = document.createElement('script');
  s.src = url;
  if (type) {
    s.type = type;
  }
  if (type === 'module') {
    s.async = false; // Preserve load order.
    const pre = document.createElement('link');
    pre.rel = 'modulepreload';
    pre.href = url;
    document.head.append(pre);
    // We use DOMContentLoaded as the loader script is running sync, and inserting a module script here doesn't defer. This brings back normal type="module" behavior.
    window.addEventListener('DOMContentLoaded', () => {
      document.head.append(s);
    });
  } else {
    document.head.append(s);
  }
}
loadScript('/js/app.js?v=53ae04e8df045', 'module');




  loadScript('/js/content.js?v=7a83afbf06905', 'module');


  loadScript('https://www.google-analytics.com/analytics.js', null);

</script>

  </head>
  <body class="unresolved">
    
    <web-snackbar-container></web-snackbar-container>

    
<a href="#main" class="skip-link button" data-type="primary">Skip to content</a>


<web-header role="banner" class="site-header">
  <div class="cluster gutter-base">
    <button class="icon-button tooltip color-core-text md:hidden-yes" data-open-drawer-button data-alignment="right">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" height="24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
      <span class="tooltip__content">Open menu</span>
    </button>
    <a href="/" class="site-header__brand brand">
      


  <svg role="img" aria-label="web.dev" xmlns="http://www.w3.org/2000/svg" width="119.79" height="22.32" viewBox="0 0 119.79 22.32"><path class="brand__text" d="M114.99 19.32h-2.2l-4.8-11.9h2.4l3.5 9.2 3.5-9.2h2.4Zm-16.8-7.3h6.8a3.17 3.17 0 0 0-3.4-2.9 3.42 3.42 0 0 0-3.4 2.9Zm3.6 7.7a6 6 0 0 1-6-6.3c0-3.6 2.5-6.3 5.9-6.3s5.8 2.4 5.8 6.5v.2h-9.3a3.88 3.88 0 0 0 3.8 3.9 3.56 3.56 0 0 0 3.3-2.1l2 1a6.22 6.22 0 0 1-5.5 3.1Zm-14 0c-3.1 0-5.7-2.8-5.7-6.3s2.6-6.3 5.7-6.3a5 5 0 0 1 4.1 2h.1l-.1-1.6v-5.5h2.2v17.3h-2.1v-1.6h-.1a5.12 5.12 0 0 1-4.1 2Zm.3-2c2.2 0 3.8-1.7 3.8-4.3s-1.6-4.3-3.8-4.3a4 4 0 0 0-3.8 4.3 4 4 0 0 0 3.8 4.3Zm-6.8.1a1.61 1.61 0 0 1-1.7 1.6 1.74 1.74 0 0 1-1.7-1.6 1.67 1.67 0 0 1 1.7-1.6 1.61 1.61 0 0 1 1.7 1.6Zm-10.5-.1a4 4 0 0 0 3.8-4.3 4 4 0 0 0-3.8-4.3c-2.2 0-3.8 1.8-3.8 4.3s1.6 4.3 3.8 4.3Zm.4 2a5 5 0 0 1-4.1-2h-.1v1.6h-2.1V2.02h2.2v5.5l-.1 1.6h.1a4.84 4.84 0 0 1 4.1-2c3.1 0 5.7 2.8 5.7 6.3s-2.6 6.3-5.7 6.3Zm-17.4-7.7h6.8a3.17 3.17 0 0 0-3.4-2.9 3.42 3.42 0 0 0-3.4 2.9Zm3.6 7.7a6 6 0 0 1-6-6.3c0-3.6 2.5-6.3 5.9-6.3s5.8 2.4 5.8 6.5v.2h-9.3a3.88 3.88 0 0 0 3.8 3.9 3.67 3.67 0 0 0 3.3-2.1l2 1a6.22 6.22 0 0 1-5.5 3.1Zm-6.3-12.2-3.8 11.9h-2.3l-3-9.1-2.9 9.1h-2.3l-3.9-11.9h2.3l2.6 9 2.9-9h2.3l2.9 9 2.6-9Z" fill="#5f6368" fill-rule="evenodd"/><path d="M0 19.28a3 3 0 0 1 3-3h16.27a3.045 3.045 0 0 1 0 6.09H3.04A3 3 0 0 1 0 19.28Z" fill="#6cf"/><path d="M.89.9a3 3 0 0 1 4.3 0l8.12 8.11a3.05 3.05 0 0 1 0 4.3l-8.12 8.12a3.04 3.04 0 1 1-4.3-4.3l5.6-5.61a.51.51 0 0 0 0-.72L.89 5.22A3 3 0 0 1 .89.9Z" fill="#06f" fill-rule="evenodd"/><path d="m10.39 16.22-5.2 5.2a3.04 3.04 0 1 1-4.3-4.3l.89-.9Z" fill="#c6f"/><circle cx="19.27" cy="19.27" r="3.04" fill="#06f"/></svg>


    </a>
  </div>
  <web-navigation-drawer type="standard">
    <nav class="site-header__nav" aria-label="main navigation" data-drawer-container>
      <a
        class="site-header__link"
        href="/learn/" data-category="Site-Wide Custom Events"
        data-label="Tab: Learn"
        >
          Learn
      </a>
      <a
        class="site-header__link"
        href="/measure/"
        data-category="Site-Wide Custom Events"
        data-label="Tab: Measure"
        >
        Measure
      </a>
      <a
        class="site-header__link"
        href="/blog/"
        data-category="Site-Wide Custom Events"
        data-label="Tab: Blog"
        >
        Blog
      </a>
      <a
        class="site-header__link"
        href="/tags/case-study/"
        data-category="Site-Wide Custom Events"
        data-label="Tab: Case Studies"
        >
        Case studies
      </a>
      <a
        class="site-header__link"
        href="/about/"
        data-category="Site-Wide Custom Events"
        data-label="Tab: About" >
        About
      </a>
      <button class="icon-button tooltip color-core-text md:hidden-yes" data-drawer-close-button>
        








  










  <svg class="icon " role="img" aria-label="close" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" height="24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>


        <span class="tooltip__content">Close</span>
      </button>
    </nav>
  </web-navigation-drawer>
  <div class="site-header__actions cluster">
    <div class="site-header__search">
      <web-search results-id="search-main-results" i18n="{&quot;search&quot;:{&quot;en&quot;:&quot;Search&quot;},&quot;open_search&quot;:{&quot;en&quot;:&quot;Open search&quot;},&quot;all_articles&quot;:{&quot;en&quot;:&quot;All articles&quot;},&quot;close_search&quot;:{&quot;en&quot;:&quot;Close search&quot;}}"></web-search>
      <web-search-results id="search-main-results"></web-search-results>
    </div>
  </div>
</web-header>

<main id="main">
  
    
  
  





  <img     alt="A screenshot of JavaScript code setting a strict Content Security Policy."     class="hero-image"     decoding="async"     height="480"               sizes="100vw"     src="https://web-dev.imgix.net/image/3lmWcR1VGYVMicNlBh4aZWBTcSg1/mhE0NYvP3JFyvNyiQ1dj.jpg?auto=format"     srcset="https://web-dev.imgix.net/image/3lmWcR1VGYVMicNlBh4aZWBTcSg1/mhE0NYvP3JFyvNyiQ1dj.jpg?auto=format&w=200 200w,     https://web-dev.imgix.net/image/3lmWcR1VGYVMicNlBh4aZWBTcSg1/mhE0NYvP3JFyvNyiQ1dj.jpg?auto=format&w=228 228w,     https://web-dev.imgix.net/image/3lmWcR1VGYVMicNlBh4aZWBTcSg1/mhE0NYvP3JFyvNyiQ1dj.jpg?auto=format&w=260 260w,     https://web-dev.imgix.net/image/3lmWcR1VGYVMicNlBh4aZWBTcSg1/mhE0NYvP3JFyvNyiQ1dj.jpg?auto=format&w=296 296w,     https://web-dev.imgix.net/image/3lmWcR1VGYVMicNlBh4aZWBTcSg1/mhE0NYvP3JFyvNyiQ1dj.jpg?auto=format&w=338 338w,     https://web-dev.imgix.net/image/3lmWcR1VGYVMicNlBh4aZWBTcSg1/mhE0NYvP3JFyvNyiQ1dj.jpg?auto=format&w=385 385w,     https://web-dev.imgix.net/image/3lmWcR1VGYVMicNlBh4aZWBTcSg1/mhE0NYvP3JFyvNyiQ1dj.jpg?auto=format&w=439 439w,     https://web-dev.imgix.net/image/3lmWcR1VGYVMicNlBh4aZWBTcSg1/mhE0NYvP3JFyvNyiQ1dj.jpg?auto=format&w=500 500w,     https://web-dev.imgix.net/image/3lmWcR1VGYVMicNlBh4aZWBTcSg1/mhE0NYvP3JFyvNyiQ1dj.jpg?auto=format&w=571 571w,     https://web-dev.imgix.net/image/3lmWcR1VGYVMicNlBh4aZWBTcSg1/mhE0NYvP3JFyvNyiQ1dj.jpg?auto=format&w=650 650w,     https://web-dev.imgix.net/image/3lmWcR1VGYVMicNlBh4aZWBTcSg1/mhE0NYvP3JFyvNyiQ1dj.jpg?auto=format&w=741 741w,     https://web-dev.imgix.net/image/3lmWcR1VGYVMicNlBh4aZWBTcSg1/mhE0NYvP3JFyvNyiQ1dj.jpg?auto=format&w=845 845w,     https://web-dev.imgix.net/image/3lmWcR1VGYVMicNlBh4aZWBTcSg1/mhE0NYvP3JFyvNyiQ1dj.jpg?auto=format&w=964 964w,     https://web-dev.imgix.net/image/3lmWcR1VGYVMicNlBh4aZWBTcSg1/mhE0NYvP3JFyvNyiQ1dj.jpg?auto=format&w=1098 1098w,     https://web-dev.imgix.net/image/3lmWcR1VGYVMicNlBh4aZWBTcSg1/mhE0NYvP3JFyvNyiQ1dj.jpg?auto=format&w=1252 1252w,     https://web-dev.imgix.net/image/3lmWcR1VGYVMicNlBh4aZWBTcSg1/mhE0NYvP3JFyvNyiQ1dj.jpg?auto=format&w=1428 1428w,     https://web-dev.imgix.net/image/3lmWcR1VGYVMicNlBh4aZWBTcSg1/mhE0NYvP3JFyvNyiQ1dj.jpg?auto=format&w=1600 1600w"          width="1600"   />


<div class="post wrapper" data-flush>
  
    
    
    
  
  

  <div class="sidebar region flex-align-start flex-dir-rev flex-wrap-no">
    

  <nav class="course__toc toc over-scroll hidden-yes xl:hidden-no" data-type="side" aria-label="On this page">
    <div class="course-toc__heading font-google-sans weight-medium">On this page</div>
    <web-scroll-spy>
      <div class="toc__wrapper flow-recursive">
        <ul class="toc__list"><li class="toc__listitem"><a class="toc__anchor" href="#why-should-you-deploy-a-strict-content-security-policy-(csp)">Why should you deploy a strict Content Security Policy (CSP)?</a><ul class="toc__list"><li class="toc__listitem"><a class="toc__anchor" href="#why-a-strict-csp-is-recommended-over-allowlist-csps">Why a strict CSP is recommended over allowlist CSPs</a></li></ul></li><li class="toc__listitem"><a class="toc__anchor" href="#what-is-a-strict-content-security-policy">What is a strict Content Security Policy?</a></li><li class="toc__listitem"><a class="toc__anchor" href="#adopting-a-strict-csp">Adopting a strict CSP</a><ul class="toc__list"><li class="toc__listitem"><a class="toc__anchor" href="#step-1:-decide-if-you-need-a-nonce-or-hash-based-csp">Step 1: Decide if you need a nonce- or hash-based CSP</a></li><li class="toc__listitem"><a class="toc__anchor" href="#step-2:-set-a-strict-csp-and-prepare-your-scripts">Step 2: Set a strict CSP and prepare your scripts</a></li><li class="toc__listitem"><a class="toc__anchor" href="#step-3:-refactor-html-templates-and-client-side-code-to-remove-patterns-incompatible-with-csp">Step 3:  Refactor HTML templates and client-side code to remove patterns incompatible with CSP</a></li><li class="toc__listitem"><a class="toc__anchor" href="#step-4:-add-fallbacks-to-support-safari-and-older-browsers">Step 4:  Add fallbacks to support Safari and older browsers</a></li><li class="toc__listitem"><a class="toc__anchor" href="#step-5:-deploy-your-csp">Step 5:  Deploy your CSP</a></li></ul></li><li class="toc__listitem"><a class="toc__anchor" href="#limitations">Limitations</a></li><li class="toc__listitem"><a class="toc__anchor" href="#further-reading">Further reading</a></li></ul>
      </div>
    </web-scroll-spy>
  </nav>


    
    <article class="prose legacy-rollout">
      <header class="flow gap-bottom-size-3">
        
          <nav class="breadcrumbs" aria-label="breadcrumbs">
            <ul class="breadcrumbs__list" role="list">
              <li>
                <a
                  class="gc-analytics-event"
                  data-category="web.dev"
                  data-label="post, home breadcrumb"
                  data-action="click"
                  href="/"
                >
                  Home
                </a>
              </li>
              
              <li>
                <a
                  class="gc-analytics-event"
                  data-category="web.dev"
                  data-label="post, path breadcrumb"
                  data-action="click"
                  href="/blog"
                >
                  All articles
                </a>
              </li>
              
            </ul>
          </nav>
        

        <h1 id="mitigate-cross-site-scripting-(xss)-with-a-strict-content-security-policy-(csp)">Mitigate cross-site scripting (XSS) with a strict Content Security Policy (CSP)</h1>
        
          <p class="color-mid-text flow-space-base">
            How to deploy a CSP based on script nonces or hashes as a defense-in-depth against cross-site scripting.
          </p>
        

        
          <div class="flow-space-size-1 color-mid-text text-size-0">
            <time>Mar 15, 2021</time>
            
          </div>
        

        
        

        <div class="w-layout-container--narrow w-post-signpost">
  <span class="w-post-signpost__title">
    Appears in:
  </span>
  <a
          class="w-post-signpost__link"
          href="/secure"
          >Safe and secure</a
        >
</div>

        
          <div class="cluster flow-space-size-2">
            
              <div class="author">
  <a class="avatar" href="/authors/lwe/"> <img     alt="Lukas Weichselbaum"     class="w-author__image"     decoding="async"     height="64"          loading="lazy"     sizes="(min-width: 64px) 64px, calc(100vw - 48px)"     src="https://web-dev.imgix.net/image/admin/SR3DdHwfeqxp5k9ojcr6.jpg?auto=format&fit=crop&h=64&w=64"     srcset="https://web-dev.imgix.net/image/admin/SR3DdHwfeqxp5k9ojcr6.jpg?fit=crop&h=64&w=64&auto=format&dpr=1&q=75 1x,     https://web-dev.imgix.net/image/admin/SR3DdHwfeqxp5k9ojcr6.jpg?fit=crop&h=64&w=64&auto=format&dpr=2&q=50 2x,     https://web-dev.imgix.net/image/admin/SR3DdHwfeqxp5k9ojcr6.jpg?fit=crop&h=64&w=64&auto=format&dpr=3&q=35 3x,     https://web-dev.imgix.net/image/admin/SR3DdHwfeqxp5k9ojcr6.jpg?fit=crop&h=64&w=64&auto=format&dpr=4&q=23 4x,     https://web-dev.imgix.net/image/admin/SR3DdHwfeqxp5k9ojcr6.jpg?fit=crop&h=64&w=64&auto=format&dpr=5&q=20 5x"          width="64"   /> </a>
  <div class="flow">
    <cite class="author__name">
      <a href="/authors/lwe/">Lukas Weichselbaum</a>
    </cite>
    <div class="author__links cluster">
               <a href="https://twitter.com/we1x">Twitter</a>
               <a href="https://github.com/lweichselbaum">GitHub</a>
               
               <a href="https://webappsec.dev">Homepage</a>
             </div>
  </div>
</div>
            
          </div>
        
      </header>

      

      

  

  <div class="xl:hidden-yes flow-space-size-1">
    <details data-type="inner" role="navigation" aria-label="On this page">
      <summary>
        On this page
      </summary>
      <div class="toc"><ul class="toc__list"><li class="toc__listitem"><a class="toc__anchor" href="#why-should-you-deploy-a-strict-content-security-policy-(csp)">Why should you deploy a strict Content Security Policy (CSP)?</a><ul class="toc__list"><li class="toc__listitem"><a class="toc__anchor" href="#why-a-strict-csp-is-recommended-over-allowlist-csps">Why a strict CSP is recommended over allowlist CSPs</a></li></ul></li><li class="toc__listitem"><a class="toc__anchor" href="#what-is-a-strict-content-security-policy">What is a strict Content Security Policy?</a></li><li class="toc__listitem"><a class="toc__anchor" href="#adopting-a-strict-csp">Adopting a strict CSP</a><ul class="toc__list"><li class="toc__listitem"><a class="toc__anchor" href="#step-1:-decide-if-you-need-a-nonce-or-hash-based-csp">Step 1: Decide if you need a nonce- or hash-based CSP</a></li><li class="toc__listitem"><a class="toc__anchor" href="#step-2:-set-a-strict-csp-and-prepare-your-scripts">Step 2: Set a strict CSP and prepare your scripts</a></li><li class="toc__listitem"><a class="toc__anchor" href="#step-3:-refactor-html-templates-and-client-side-code-to-remove-patterns-incompatible-with-csp">Step 3:  Refactor HTML templates and client-side code to remove patterns incompatible with CSP</a></li><li class="toc__listitem"><a class="toc__anchor" href="#step-4:-add-fallbacks-to-support-safari-and-older-browsers">Step 4:  Add fallbacks to support Safari and older browsers</a></li><li class="toc__listitem"><a class="toc__anchor" href="#step-5:-deploy-your-csp">Step 5:  Deploy your CSP</a></li></ul></li><li class="toc__listitem"><a class="toc__anchor" href="#limitations">Limitations</a></li><li class="toc__listitem"><a class="toc__anchor" href="#further-reading">Further reading</a></li></ul></div>
    </details>
  </div>



      <h2 id="why-should-you-deploy-a-strict-content-security-policy-(csp)">Why should you deploy a strict Content Security Policy (CSP)? <a class="w-headline-link" href="#why-should-you-deploy-a-strict-content-security-policy-(csp)">#</a></h2>
<p><a href="https://www.google.com/about/appsecurity/learning/xss/" rel="noopener">Cross-site scripting
(XSS)</a>‚Äîthe ability to
inject malicious scripts into a web application‚Äîhas been one of the biggest web
security vulnerabilities for over a decade.</p>
<p><a href="https://developer.mozilla.org/docs/Web/HTTP/CSP" rel="noopener">Content Security Policy
(CSP)</a> is an added layer
of security that helps to mitigate XSS. Configuring a CSP involves adding the
Content-Security-Policy HTTP header to a web page and setting values to control
what resources the user agent is allowed to load for that page. This article
explains how to use a CSP based on nonces or hashes to mitigate XSS instead of
the commonly used host-allowlist-based CSPs which often leave the page exposed
to XSS as they can be <a href="https://research.google.com/pubs/pub45542.html" rel="noopener">bypassed in most
configurations</a>.</p>
<aside class="aside flow color-secondary-box-text bg-secondary-box-bg">
<p class="cluster ">
<span class="aside__icon box-block "><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" role="img" aria-label="Highlighter pen" xmlns="http://www.w3.org/2000/svg">
  <path fill-rule="evenodd" clip-rule="evenodd" d="M10.22 9.49l-5.91 6c-.77.8-.7 2.05.08 2.85L.77 22h5.68l.74-.75c.78.81 1.95.86 2.73.05l5.96-6.05-5.66-5.76zm12.46-4l-2.82-2.87c-.78-.8-2.07-.84-2.84-.04l-5.75 5.85 5.66 5.75 5.69-5.78c.77-.81.83-2.11.06-2.91z" />
</svg></span>
<strong>Key Term</strong></p>
<div class=" flow">
<p>A <em>nonce</em> is a random number used only once that can be
used to mark a <code>&lt;script&gt;</code> tag as trusted.</p>
</div></aside>
<aside class="aside flow color-secondary-box-text bg-secondary-box-bg">
<p class="cluster ">
<span class="aside__icon box-block "><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" role="img" aria-label="Highlighter pen" xmlns="http://www.w3.org/2000/svg">
  <path fill-rule="evenodd" clip-rule="evenodd" d="M10.22 9.49l-5.91 6c-.77.8-.7 2.05.08 2.85L.77 22h5.68l.74-.75c.78.81 1.95.86 2.73.05l5.96-6.05-5.66-5.76zm12.46-4l-2.82-2.87c-.78-.8-2.07-.84-2.84-.04l-5.75 5.85 5.66 5.75 5.69-5.78c.77-.81.83-2.11.06-2.91z" />
</svg></span>
<strong>Key Term</strong></p>
<div class=" flow">
<p>A hash function is a mathematical function that converts
an input value into a compressed numerical value‚Äîa hash. A <em>hash</em> (such as
<a href="https://en.wikipedia.org/wiki/SHA-2" rel="noopener">SHA-256</a>) can be used to mark an inline
<code>&lt;script&gt;</code> tag as trusted.</p>
</div></aside>
<p>A Content Security Policy based on nonces or hashes is often called a <em>strict
CSP</em>. When an application uses a strict CSP, attackers who find HTML injection
flaws will generally not be able to use them to force the browser to execute
malicious scripts in the context of the vulnerable document. This is because
strict CSP only permits hashed scripts or scripts with the correct nonce value
generated on the server, so attackers cannot execute the script without knowing
the correct nonce for a given response.</p>
<aside class="aside flow bg-state-info-bg color-state-info-text">
<div class=" flow">
<p>To protect your site from XSS, make sure to sanitize user input
<em>and</em> use CSP as an extra security layer. CSP is a
<a href="https://en.wikipedia.org/wiki/Defense_in_depth_(computing)" rel="noopener">defense-in-depth</a>
technique that can prevent the execution of malicious scripts, but it's not a
substitute for avoiding (and promptly fixing) XSS bugs.</p>
</div></aside>
<h3 id="why-a-strict-csp-is-recommended-over-allowlist-csps">Why a strict CSP is recommended over allowlist CSPs <a class="w-headline-link" href="#why-a-strict-csp-is-recommended-over-allowlist-csps">#</a></h3>
<p>If your site already has a CSP that looks like this: <code>script-src www.googleapis.com</code>, it may not be effective against cross-site scripting! This
type of CSP is called an allowlist CSP and it has a couple of downsides:</p>
<ul>
<li>It requires a lot of customization.</li>
<li>It can be <a href="https://research.google.com/pubs/pub45542.html" rel="noopener">bypassed in most
configurations</a>.</li>
</ul>
<p>This makes allowlist CSPs generally ineffective at preventing attackers from
exploiting XSS. That's why it's recommended to use a strict CSP based on
cryptographic nonces or hashes, which avoids the pitfalls outlined above.</p>
<div class="switcher">
<figure class="compare flow" data-type="worse"><p class="compare__label">Allowlist CSP</p>
<ul>
<li>Doesn't effectively protect your site. ‚ùå</li>
<li>Must be highly customized. üòì</li>
</ul>
</figure>
<figure class="compare flow" data-type="better"><p class="compare__label">Strict CSP</p>
<ul>
<li>Effectively protects your site. ‚úÖ</li>
<li>Always has the same structure. üòå</li>
</ul>
</figure>
</div>
<h2 id="what-is-a-strict-content-security-policy">What is a strict Content Security Policy? <a class="w-headline-link" href="#what-is-a-strict-content-security-policy">#</a></h2>
<p>A strict Content Security Policy has the following structure and is enabled by
setting one of the following HTTP response headers:</p>
<ul>
<li><strong>Nonce-based strict CSP</strong></li>
</ul>
<web-copy-code><pre class="language-text"><code class="language-text">Content-Security-Policy:<br>  script-src 'nonce-{RANDOM}' 'strict-dynamic';<br>  object-src 'none';<br>  base-uri 'none';<br></code></pre>
</web-copy-code><img     alt=""          decoding="async"     height="279"          loading="lazy"     sizes="(min-width: 800px) 800px, calc(100vw - 48px)"     src="https://web-dev.imgix.net/image/vgdbNJBYHma2o62ZqYmcnkq3j0o1/er4BaGCJzBwDaESFKfZd.jpg?auto=format"     srcset="https://web-dev.imgix.net/image/vgdbNJBYHma2o62ZqYmcnkq3j0o1/er4BaGCJzBwDaESFKfZd.jpg?auto=format&w=200 200w,     https://web-dev.imgix.net/image/vgdbNJBYHma2o62ZqYmcnkq3j0o1/er4BaGCJzBwDaESFKfZd.jpg?auto=format&w=228 228w,     https://web-dev.imgix.net/image/vgdbNJBYHma2o62ZqYmcnkq3j0o1/er4BaGCJzBwDaESFKfZd.jpg?auto=format&w=260 260w,     https://web-dev.imgix.net/image/vgdbNJBYHma2o62ZqYmcnkq3j0o1/er4BaGCJzBwDaESFKfZd.jpg?auto=format&w=296 296w,     https://web-dev.imgix.net/image/vgdbNJBYHma2o62ZqYmcnkq3j0o1/er4BaGCJzBwDaESFKfZd.jpg?auto=format&w=338 338w,     https://web-dev.imgix.net/image/vgdbNJBYHma2o62ZqYmcnkq3j0o1/er4BaGCJzBwDaESFKfZd.jpg?auto=format&w=385 385w,     https://web-dev.imgix.net/image/vgdbNJBYHma2o62ZqYmcnkq3j0o1/er4BaGCJzBwDaESFKfZd.jpg?auto=format&w=439 439w,     https://web-dev.imgix.net/image/vgdbNJBYHma2o62ZqYmcnkq3j0o1/er4BaGCJzBwDaESFKfZd.jpg?auto=format&w=500 500w,     https://web-dev.imgix.net/image/vgdbNJBYHma2o62ZqYmcnkq3j0o1/er4BaGCJzBwDaESFKfZd.jpg?auto=format&w=571 571w,     https://web-dev.imgix.net/image/vgdbNJBYHma2o62ZqYmcnkq3j0o1/er4BaGCJzBwDaESFKfZd.jpg?auto=format&w=650 650w,     https://web-dev.imgix.net/image/vgdbNJBYHma2o62ZqYmcnkq3j0o1/er4BaGCJzBwDaESFKfZd.jpg?auto=format&w=741 741w,     https://web-dev.imgix.net/image/vgdbNJBYHma2o62ZqYmcnkq3j0o1/er4BaGCJzBwDaESFKfZd.jpg?auto=format&w=845 845w,     https://web-dev.imgix.net/image/vgdbNJBYHma2o62ZqYmcnkq3j0o1/er4BaGCJzBwDaESFKfZd.jpg?auto=format&w=964 964w,     https://web-dev.imgix.net/image/vgdbNJBYHma2o62ZqYmcnkq3j0o1/er4BaGCJzBwDaESFKfZd.jpg?auto=format&w=1098 1098w,     https://web-dev.imgix.net/image/vgdbNJBYHma2o62ZqYmcnkq3j0o1/er4BaGCJzBwDaESFKfZd.jpg?auto=format&w=1252 1252w,     https://web-dev.imgix.net/image/vgdbNJBYHma2o62ZqYmcnkq3j0o1/er4BaGCJzBwDaESFKfZd.jpg?auto=format&w=1428 1428w,     https://web-dev.imgix.net/image/vgdbNJBYHma2o62ZqYmcnkq3j0o1/er4BaGCJzBwDaESFKfZd.jpg?auto=format&w=1600 1600w"          width="800"   />
<ul>
<li><strong>Hash-based strict CSP</strong></li>
</ul>
<web-copy-code><pre class="language-text"><code class="language-text">Content-Security-Policy:<br>  script-src 'sha256-{HASHED_INLINE_SCRIPT}' 'strict-dynamic';<br>  object-src 'none';<br>  base-uri 'none';<br></code></pre>
</web-copy-code><aside class="aside flow bg-state-info-bg color-state-info-text">
<div class=" flow">
<p>This is the most stripped-down version of a strict CSP.
You'll need to tweak it to make it effective across browsers. See <a href="#step-4:-add-fallbacks-to-support-safari-and-older-browsers">add a
fallback to support Safari and older
browsers</a> for
details.</p>
</div></aside>
<p>The following properties make a CSP like the one above &quot;strict&quot; and hence
secure:</p>
<ul>
<li>
<p>Uses nonces <code>'nonce-{RANDOM}'</code> or hashes <code>'sha256-{HASHED_INLINE_SCRIPT}'</code> to
indicate which <code>&lt;script&gt;</code> tags are trusted by the site's developer and should
be allowed to execute in the user's browser.</p>
</li>
<li>
<p>Sets <a href="https://www.w3.org/TR/CSP3/#strict-dynamic-usage" rel="noopener"><code>'strict-dynamic'</code></a> to
reduce the effort of deploying a nonce- or hash-based CSP by automatically
allowing the execution of scripts that are created by an already trusted
script. This also unblocks the use of most third party JavaScript libraries
and widgets.</p>
</li>
<li>
<p>Not based on URL allowlists and therefore doesn't suffer from <a href="https://speakerdeck.com/lweichselbaum/csp-is-dead-long-live-strict-csp-deepsec-2016?slide=15" rel="noopener">common CSP
bypasses</a>.</p>
</li>
<li>
<p>Blocks untrusted inline scripts like inline event handlers or <code>javascript:</code>
URIs.</p>
</li>
<li>
<p>Restricts <code>object-src</code> to disable dangerous plugins such as Flash.</p>
</li>
<li>
<p>Restricts <code>base-uri</code> to block the injection of <code>&lt;base&gt;</code> tags. This prevents
attackers from changing the locations of scripts loaded from relative URLs.</p>
</li>
</ul>
<aside class="aside flow bg-state-info-bg color-state-info-text">
<div class=" flow">
<p>Another advantage of a strict CSP is that the CSP always has the
same structure and doesn't need to be customized for your application.</p>
</div></aside>
<h2 id="adopting-a-strict-csp">Adopting a strict CSP <a class="w-headline-link" href="#adopting-a-strict-csp">#</a></h2>
<p>To adopt a strict CSP, you need to:</p>
<ol>
<li>Decide if your application should set a nonce- or hash-based CSP.</li>
<li>Copy the CSP from the <a href="#what-is-a-strict-content-security-policy">What is a strict Content Security
Policy</a> section and set it as a
response header across your application.</li>
<li>Refactor HTML templates and client-side code to remove patterns that are
incompatible with CSP.</li>
<li>Add fallbacks to support Safari and older browsers.</li>
<li>Deploy your CSP.</li>
</ol>
<p>You can use <a href="https://developers.google.com/web/tools/lighthouse" rel="noopener">Lighthouse</a>
(v7.3.0 and above with flag <code>--preset=experimental</code>) <strong>Best Practices</strong> audit throughout this process to check
whether your site has a CSP, and whether it's strict enough to be effective
against XSS.</p>
<img     alt="Lighthouse report warning that no CSP is found in enforcement mode."     class="w-screenshot"     decoding="async"     height="78"          loading="lazy"     sizes="(min-width: 730px) 730px, calc(100vw - 48px)"     src="https://web-dev.imgix.net/image/9B7J9oWjgsWbuE84mmxDaY37Wpw2/42a4iEEKsD4T3yU47vNQ.png?auto=format"     srcset="https://web-dev.imgix.net/image/9B7J9oWjgsWbuE84mmxDaY37Wpw2/42a4iEEKsD4T3yU47vNQ.png?auto=format&w=200 200w,     https://web-dev.imgix.net/image/9B7J9oWjgsWbuE84mmxDaY37Wpw2/42a4iEEKsD4T3yU47vNQ.png?auto=format&w=228 228w,     https://web-dev.imgix.net/image/9B7J9oWjgsWbuE84mmxDaY37Wpw2/42a4iEEKsD4T3yU47vNQ.png?auto=format&w=260 260w,     https://web-dev.imgix.net/image/9B7J9oWjgsWbuE84mmxDaY37Wpw2/42a4iEEKsD4T3yU47vNQ.png?auto=format&w=296 296w,     https://web-dev.imgix.net/image/9B7J9oWjgsWbuE84mmxDaY37Wpw2/42a4iEEKsD4T3yU47vNQ.png?auto=format&w=338 338w,     https://web-dev.imgix.net/image/9B7J9oWjgsWbuE84mmxDaY37Wpw2/42a4iEEKsD4T3yU47vNQ.png?auto=format&w=385 385w,     https://web-dev.imgix.net/image/9B7J9oWjgsWbuE84mmxDaY37Wpw2/42a4iEEKsD4T3yU47vNQ.png?auto=format&w=439 439w,     https://web-dev.imgix.net/image/9B7J9oWjgsWbuE84mmxDaY37Wpw2/42a4iEEKsD4T3yU47vNQ.png?auto=format&w=500 500w,     https://web-dev.imgix.net/image/9B7J9oWjgsWbuE84mmxDaY37Wpw2/42a4iEEKsD4T3yU47vNQ.png?auto=format&w=571 571w,     https://web-dev.imgix.net/image/9B7J9oWjgsWbuE84mmxDaY37Wpw2/42a4iEEKsD4T3yU47vNQ.png?auto=format&w=650 650w,     https://web-dev.imgix.net/image/9B7J9oWjgsWbuE84mmxDaY37Wpw2/42a4iEEKsD4T3yU47vNQ.png?auto=format&w=741 741w,     https://web-dev.imgix.net/image/9B7J9oWjgsWbuE84mmxDaY37Wpw2/42a4iEEKsD4T3yU47vNQ.png?auto=format&w=845 845w,     https://web-dev.imgix.net/image/9B7J9oWjgsWbuE84mmxDaY37Wpw2/42a4iEEKsD4T3yU47vNQ.png?auto=format&w=964 964w,     https://web-dev.imgix.net/image/9B7J9oWjgsWbuE84mmxDaY37Wpw2/42a4iEEKsD4T3yU47vNQ.png?auto=format&w=1098 1098w,     https://web-dev.imgix.net/image/9B7J9oWjgsWbuE84mmxDaY37Wpw2/42a4iEEKsD4T3yU47vNQ.png?auto=format&w=1252 1252w,     https://web-dev.imgix.net/image/9B7J9oWjgsWbuE84mmxDaY37Wpw2/42a4iEEKsD4T3yU47vNQ.png?auto=format&w=1428 1428w,     https://web-dev.imgix.net/image/9B7J9oWjgsWbuE84mmxDaY37Wpw2/42a4iEEKsD4T3yU47vNQ.png?auto=format&w=1460 1460w"          width="730"   />
<h3 id="step-1:-decide-if-you-need-a-nonce-or-hash-based-csp">Step 1: Decide if you need a nonce- or hash-based CSP <a class="w-headline-link" href="#step-1:-decide-if-you-need-a-nonce-or-hash-based-csp">#</a></h3>
<p>There are two types of strict CSPs, nonce- and hash-based. Here's how they work:</p>
<ul>
<li><strong>Nonce-based CSP</strong>: You generate a random number <em>at runtime</em>, include it in
your CSP, and associate it with every script tag in your page. An attacker
can't include and run a malicious script in your page, because they would need
to guess the correct random number for that script. This only works if the
number is not guessable and newly generated at runtime for every response.</li>
<li><strong>Hash-based CSP</strong>: The hash of every inline script tag is added to the CSP.
Note that each script has a different hash. An attacker can't include and run
a malicious script in your page, because the hash of that script would need to
be present in your CSP.</li>
</ul>
<p>Criteria for choosing a strict CSP approach:</p>
<div>
  <table>
      <caption>Criteria for choosing a strict CSP approach</caption>
      <thead>
      <tr>
        <th>Nonce-based CSP</th>
        <td>For HTML pages rendered on the server where you can create a new random token
(nonce) for every response.</td>
      </tr>
    </thead>
    <tbody>
      <tr>
        <th>Hash-based CSP</th>
        <td>For HTML pages served statically or those that need to be cached. For example,
single-page web applications built with frameworks such as Angular, React or others, that are
statically served without server-side rendering.</td>
      </tr>
    </tbody>
  </table>
</div>
<h3 id="step-2:-set-a-strict-csp-and-prepare-your-scripts">Step 2: Set a strict CSP and prepare your scripts <a class="w-headline-link" href="#step-2:-set-a-strict-csp-and-prepare-your-scripts">#</a></h3>
<p>When setting a CSP, you have a few options:</p>
<ul>
<li>Report-only mode (<code>Content-Security-Policy-Report-Only</code>) or enforcement mode
(<code>Content-Security-Policy</code>). In report-only, the CSP won't block resources
yet‚Äînothing will break‚Äîbut you'll be able to see errors and receive reports
for what would have been blocked. Locally, when you're in the process of
setting a CSP, this doesn't really matter, because both modes will show you
the errors in the browser console. If anything, enforcement mode will make it
even easier for you to see blocked resources and tweak your CSP, since your
page will look broken. Report-only mode becomes most useful later in the
process (see <a href="#step-5:-deploy-your-csp">Step 5</a>).</li>
<li>Header or HTML <code>&lt;meta&gt;</code> tag. For local development, a <code>&lt;meta&gt;</code> tag may be more
convenient for tweaking your CSP and quickly seeing how it affects your site.
However:
<ul>
<li>Later on, when deploying your CSP in production, it is recommended to set it
as an HTTP header.</li>
<li>If you want to set your CSP in report-only mode, you'll need to set it as a
header‚ÄîCSP meta tags don't support report-only mode.</li>
</ul>
</li>
</ul>
<p><span id="nonce-based-csp"></span></p>
<details >
<summary>
  Option A: Nonce-based CSP
</summary>
<p>Set the following <code>Content-Security-Policy</code> HTTP response header in your
application:</p>
<web-copy-code><pre class="language-text"><code class="language-text">Content-Security-Policy:<br>  script-src 'nonce-{RANDOM}' 'strict-dynamic';<br>  object-src 'none';<br>  base-uri 'none';</code></pre>
</web-copy-code><aside class="aside flow bg-state-bad-bg color-state-bad-text">
<p class="cluster color-state-bad-text">
<span class="aside__icon box-block "><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Error sign">
  <path fill-rule="evenodd" clip-rule="evenodd" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15v-2h2v2h-2zm0-10v6h2V7h-2z" />
</svg></span>
<strong>Caution</strong></p>
<div class=" flow">
<p>Replace the <code>{RANDOM}</code> placeholder with a <em>random</em> nonce that is regenerated
<strong>on every server response</strong>.</p>
</div></aside>
<h4 id="generate-a-nonce-for-csp">Generate a nonce for CSP <a class="w-headline-link" href="#generate-a-nonce-for-csp">#</a></h4>
<p>A nonce is a random number used only once per page load. A nonce-based CSP can
only mitigate XSS if the nonce value is <strong>not guessable</strong> by an attacker. A
nonce for CSP needs to be:</p>
<ul>
<li>A cryptographically <strong>strong random</strong> value (ideally 128+ bits in length)</li>
<li>Newly <strong>generated for every response</strong></li>
<li>Base64 encoded</li>
</ul>
<p>Here are some examples on how to add a CSP nonce in server-side frameworks:</p>
<ul>
<li><a href="https://django-csp.readthedocs.io/en/latest/nonce.html" rel="noopener">Django (python)</a></li>
<li>Express (JavaScript):</li>
</ul>
<web-copy-code><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">// Generate a new random nonce value for every response.</span><br>    <span class="token keyword">const</span> nonce <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">randomBytes</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">"base64"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token comment">// Set the strict nonce-based CSP response header</span><br>    <span class="token keyword">const</span> csp <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">script-src 'nonce-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>nonce<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">' 'strict-dynamic' https:; object-src 'none'; base-uri 'none';</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span><br>    response<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"Content-Security-Policy"</span><span class="token punctuation">,</span> csp<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token comment">// Every &lt;script> tag in your application should set the `nonce` attribute to this value.</span><br>    response<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>template<span class="token punctuation">,</span> <span class="token punctuation">{</span> nonce<span class="token operator">:</span> nonce <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
</web-copy-code><h4 id="add-a-nonce-attribute-to-lessscriptgreater-elements">Add a <code>nonce</code> attribute to <code>&lt;script&gt;</code> elements <a class="w-headline-link" href="#add-a-nonce-attribute-to-lessscriptgreater-elements">#</a></h4>
<p>With a nonce-based CSP, every <code>&lt;script&gt;</code> element must have a <code>nonce</code> attribute
which matches the random nonce value specified in the CSP header (all scripts
can have the same nonce). The first step is to add these attributes to all
scripts:</p>
<figure class="compare flow" data-type="worse"><p class="compare__label">Blocked by CSP</p>
<web-copy-code><pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/path/to/script.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript"><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code></pre>
</web-copy-code><figcaption class="compare__caption">
<p>CSP will block these scripts, because they don't have
<code>nonce</code> attributes.</p>
</figcaption>
</figure>
<figure class="compare flow" data-type="better"><p class="compare__label">Allowed by CSP</p>
<web-copy-code><pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">nonce</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>${NONCE}<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/path/to/script.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">nonce</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>${NONCE}<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript"><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code></pre>
</web-copy-code><figcaption class="compare__caption">
<p>CSP will allow the execution of these scripts if <code>${NONCE}</code>
is replaced with a value matching the nonce in the CSP response header. Note
that some browsers will hide the <code>nonce</code> attribute when inspecting the page
source.</p>
</figcaption>
</figure>
<aside class="aside flow bg-tertiary-box-bg color-tertiary-box-text">
<p class="cluster ">
<span class="aside__icon box-block "><svg width="24" height="24" viewBox="0 0 24 24" role="img" aria-label="Lightbulb" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
  <path d="M9 21c0 .55.45 1 1 1h4c.55 0 1-.45 1-1v-1H9v1zm3-19C8.14 2 5 5.14 5 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26c1.81-1.27 3-3.36 3-5.74 0-3.86-3.14-7-7-7zm2.85 11.1l-.85.6V16h-4v-2.3l-.85-.6A4.997 4.997 0 017 9c0-2.76 2.24-5 5-5s5 2.24 5 5c0 1.63-.8 3.16-2.15 4.1z" />
</svg></span>
<strong>Gotchas</strong></p>
<div class=" flow">
<p>With <code>'strict-dynamic'</code> in your CSP, you'll only have to
add nonces to <code>&lt;script&gt;</code> tags that are present in the initial HTML
response.<code>'strict-dynamic'</code> allows the execution of scripts dynamically added to
the page, as long as they were loaded by a safe, already-trusted script (see the
<a href="https://www.w3.org/TR/CSP3/#strict-dynamic-usage" rel="noopener">specification</a>).</p>
</div></aside>
</details>
<p><span id="hash-based-csp"></span></p>
<details >
<summary>
  Option B: Hash-based CSP Response Header
</summary>
<p>Set the following <code>Content-Security-Policy</code> HTTP response header in your
application:</p>
<web-copy-code><pre class="language-text"><code class="language-text">Content-Security-Policy:<br>  script-src 'sha256-{HASHED_INLINE_SCRIPT}' 'strict-dynamic';<br>  object-src 'none';<br>  base-uri 'none';</code></pre>
</web-copy-code><p>For several inline scripts, the syntax is as follows:
<code>'sha256-{HASHED_INLINE_SCRIPT_1}' 'sha256-{HASHED_INLINE_SCRIPT_2}'</code>.</p>
<aside class="aside flow bg-state-bad-bg color-state-bad-text">
<p class="cluster color-state-bad-text">
<span class="aside__icon box-block "><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Error sign">
  <path fill-rule="evenodd" clip-rule="evenodd" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15v-2h2v2h-2zm0-10v6h2V7h-2z" />
</svg></span>
<strong>Caution</strong></p>
<div class=" flow">
<p>The <code>{HASHED_INLINE_SCRIPT}</code> placeholder must be replaced
with a base64-encoded SHA-256 hash of an inline script that can be used to load
other scripts (see next section). You can calculate SHA hashes of static inline
<code>&lt;script&gt;</code> blocks with this
<a href="https://strict-csp-codelab.glitch.me/csp_sha256_util.html" rel="noopener">tool</a>. An
alternative is to inspect the CSP violation warnings in Chrome's developer
console, which contains hashes of blocked scripts, and add these hashes to the
policy as 'sha256-‚Ä¶'.</p>
<p>A script injected by an attacker will be blocked by the browser as only the
hashed inline script and any scripts dynamically added by it will be allowed to
execute by the browser.</p>
</div></aside>
<h4 id="load-sourced-scripts-dynamically">Load sourced scripts dynamically <a class="w-headline-link" href="#load-sourced-scripts-dynamically">#</a></h4>
<p>All scripts that are externally sourced need to be loaded dynamically via an
inline script, because CSP hashes are supported across browsers only for inline
scripts (hashes for sourced scripts are <a href="https://wpt.fyi/results/content-security-policy/script-src/script-src-sri_hash.sub.html?label=master&amp;label=experimental&amp;aligned" rel="noopener">not well-supported across
browsers</a>).</p>
<img     alt=""          decoding="async"     height="333"          loading="lazy"     sizes="(min-width: 800px) 800px, calc(100vw - 48px)"     src="https://web-dev.imgix.net/image/vgdbNJBYHma2o62ZqYmcnkq3j0o1/B2YsfJDYw8PRI6kJI7Bs.jpg?auto=format"     srcset="https://web-dev.imgix.net/image/vgdbNJBYHma2o62ZqYmcnkq3j0o1/B2YsfJDYw8PRI6kJI7Bs.jpg?auto=format&w=200 200w,     https://web-dev.imgix.net/image/vgdbNJBYHma2o62ZqYmcnkq3j0o1/B2YsfJDYw8PRI6kJI7Bs.jpg?auto=format&w=228 228w,     https://web-dev.imgix.net/image/vgdbNJBYHma2o62ZqYmcnkq3j0o1/B2YsfJDYw8PRI6kJI7Bs.jpg?auto=format&w=260 260w,     https://web-dev.imgix.net/image/vgdbNJBYHma2o62ZqYmcnkq3j0o1/B2YsfJDYw8PRI6kJI7Bs.jpg?auto=format&w=296 296w,     https://web-dev.imgix.net/image/vgdbNJBYHma2o62ZqYmcnkq3j0o1/B2YsfJDYw8PRI6kJI7Bs.jpg?auto=format&w=338 338w,     https://web-dev.imgix.net/image/vgdbNJBYHma2o62ZqYmcnkq3j0o1/B2YsfJDYw8PRI6kJI7Bs.jpg?auto=format&w=385 385w,     https://web-dev.imgix.net/image/vgdbNJBYHma2o62ZqYmcnkq3j0o1/B2YsfJDYw8PRI6kJI7Bs.jpg?auto=format&w=439 439w,     https://web-dev.imgix.net/image/vgdbNJBYHma2o62ZqYmcnkq3j0o1/B2YsfJDYw8PRI6kJI7Bs.jpg?auto=format&w=500 500w,     https://web-dev.imgix.net/image/vgdbNJBYHma2o62ZqYmcnkq3j0o1/B2YsfJDYw8PRI6kJI7Bs.jpg?auto=format&w=571 571w,     https://web-dev.imgix.net/image/vgdbNJBYHma2o62ZqYmcnkq3j0o1/B2YsfJDYw8PRI6kJI7Bs.jpg?auto=format&w=650 650w,     https://web-dev.imgix.net/image/vgdbNJBYHma2o62ZqYmcnkq3j0o1/B2YsfJDYw8PRI6kJI7Bs.jpg?auto=format&w=741 741w,     https://web-dev.imgix.net/image/vgdbNJBYHma2o62ZqYmcnkq3j0o1/B2YsfJDYw8PRI6kJI7Bs.jpg?auto=format&w=845 845w,     https://web-dev.imgix.net/image/vgdbNJBYHma2o62ZqYmcnkq3j0o1/B2YsfJDYw8PRI6kJI7Bs.jpg?auto=format&w=964 964w,     https://web-dev.imgix.net/image/vgdbNJBYHma2o62ZqYmcnkq3j0o1/B2YsfJDYw8PRI6kJI7Bs.jpg?auto=format&w=1098 1098w,     https://web-dev.imgix.net/image/vgdbNJBYHma2o62ZqYmcnkq3j0o1/B2YsfJDYw8PRI6kJI7Bs.jpg?auto=format&w=1252 1252w,     https://web-dev.imgix.net/image/vgdbNJBYHma2o62ZqYmcnkq3j0o1/B2YsfJDYw8PRI6kJI7Bs.jpg?auto=format&w=1428 1428w,     https://web-dev.imgix.net/image/vgdbNJBYHma2o62ZqYmcnkq3j0o1/B2YsfJDYw8PRI6kJI7Bs.jpg?auto=format&w=1600 1600w"          width="800"   />
<figure class="compare flow" data-type="worse"><p class="compare__label">Blocked by CSP</p>
<web-copy-code><pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://example.org/foo.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://example.org/bar.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code></pre>
</web-copy-code><figcaption class="compare__caption">
<p>CSP will block these scripts since only inline-scripts can
be hashed.</p>
</figcaption>
</figure>
<figure class="compare flow" data-type="better"><p class="compare__label">Allowed by CSP</p>
<web-copy-code><pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript"><br><span class="token keyword">var</span> scripts <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token string">'https://example.org/foo.js'</span><span class="token punctuation">,</span> <span class="token string">'https://example.org/bar.js'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br>scripts<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">scriptUrl</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">var</span> s <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  s<span class="token punctuation">.</span>src <span class="token operator">=</span> scriptUrl<span class="token punctuation">;</span><br>  s<span class="token punctuation">.</span>async <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// to preserve execution order</span><br>  document<span class="token punctuation">.</span>head<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code></pre>
</web-copy-code><figcaption class="compare__caption">
<p>To allow execution of this script, the hash of the inline
script must be calculated and added to the CSP response header, replacing the
<code>{HASHED_INLINE_SCRIPT}</code> placeholder. To reduce the amount of hashes, you can
optionally merge all inline scripts into a single script. To see this in action
checkout the <a href="https://strict-csp-codelab.glitch.me/solution_hash_csp#" rel="noopener">example</a>
and examine the
<a href="https://glitch.com/edit/#!/strict-csp-codelab?path=demo%2Fsolution_hash_csp.html%3A1%3A" rel="noopener">code</a>.</p>
</figcaption>
</figure>
<aside class="aside flow bg-tertiary-box-bg color-tertiary-box-text">
<p class="cluster ">
<span class="aside__icon box-block "><svg width="24" height="24" viewBox="0 0 24 24" role="img" aria-label="Lightbulb" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
  <path d="M9 21c0 .55.45 1 1 1h4c.55 0 1-.45 1-1v-1H9v1zm3-19C8.14 2 5 5.14 5 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26c1.81-1.27 3-3.36 3-5.74 0-3.86-3.14-7-7-7zm2.85 11.1l-.85.6V16h-4v-2.3l-.85-.6A4.997 4.997 0 017 9c0-2.76 2.24-5 5-5s5 2.24 5 5c0 1.63-.8 3.16-2.15 4.1z" />
</svg></span>
<strong>Gotchas</strong></p>
<div class=" flow">
<p>When calculating a CSP hash for inline scripts, whitespace
characters between the opening and closing <code>&lt;script&gt;</code> tags matter. You can
calculate CSP hashes for inline scripts using this
<a href="https://strict-csp-codelab.glitch.me/csp_sha256_util.html" rel="noopener">tool</a>.</p>
</div></aside>
<details >
<summary>
  About <code>async = false</code> and script loading <code>async = false</code>
  <p class="text-base color-core-text gap-top-base">isn't blocking in this case, but use this with care.</p>
</summary>
<p>In the code snippet above, <code>s.async = false</code> is added to ensure that foo
executes before bar (even if bar loads first). <strong>In this snippet, <code>s.async = false</code> does not block the parser while the scripts load</strong>; that's because the
scripts are added dynamically. The parser will only stop as the scripts are
being executed, just like it would behave for <code>async</code> scripts. However, with
this snippet, keep in mind:</p>
<ul>
<li>One/both scripts may execute before the document has finished downloading. If
you want the document to be ready by the time the scripts execute, you need
to wait for the <a href="https://developer.mozilla.org/docs/Web/API/Window/DOMContentLoaded_event" rel="noopener"><code>DOMContentLoaded</code>
event</a>
before you append the scripts. If this causes a performance issue (because
the scripts don't start downloading early enough), you can use <a href="https://developer.mozilla.org/docs/Web/HTML/Preloading_content" rel="noopener">preload
tags</a>
earlier in the page.</li>
<li><code>defer = true</code> won't do anything. If you need that behaviour, you'll have to
manually run the script at the time you want to run it. </details></li>
</ul>
</details>
<h3 id="step-3:-refactor-html-templates-and-client-side-code-to-remove-patterns-incompatible-with-csp">Step 3:  Refactor HTML templates and client-side code to remove patterns incompatible with CSP <a class="w-headline-link" href="#step-3:-refactor-html-templates-and-client-side-code-to-remove-patterns-incompatible-with-csp">#</a></h3>
<p>Inline event handlers (such as <code>onclick=&quot;‚Ä¶&quot;</code>, <code>onerror=&quot;‚Ä¶&quot;</code>) and JavaScript URIs
(<code>&lt;a href=&quot;javascript:‚Ä¶&quot;&gt;</code>) can be used to run scripts. This means that an
attacker who finds an XSS bug could inject this kind of HTML and execute
malicious JavaScript. A nonce- or hash-based CSP disallows the use of such
markup. If your site makes use of any of the patterns described above, you'll
need to refactor them into safer alternatives.</p>
<p>If you enabled CSP in the previous step, you'll be able to see CSP violations in
the console every time CSP blocks an incompatible pattern.</p>
<img     alt="CSP violation reports in the Chrome developer console."     class="w-screenshot"     decoding="async"     height="235"          loading="lazy"     sizes="(min-width: 800px) 800px, calc(100vw - 48px)"     src="https://web-dev.imgix.net/image/vgdbNJBYHma2o62ZqYmcnkq3j0o1/mRWfNxAhQXzInOLCgtv8.jpg?auto=format"     srcset="https://web-dev.imgix.net/image/vgdbNJBYHma2o62ZqYmcnkq3j0o1/mRWfNxAhQXzInOLCgtv8.jpg?auto=format&w=200 200w,     https://web-dev.imgix.net/image/vgdbNJBYHma2o62ZqYmcnkq3j0o1/mRWfNxAhQXzInOLCgtv8.jpg?auto=format&w=228 228w,     https://web-dev.imgix.net/image/vgdbNJBYHma2o62ZqYmcnkq3j0o1/mRWfNxAhQXzInOLCgtv8.jpg?auto=format&w=260 260w,     https://web-dev.imgix.net/image/vgdbNJBYHma2o62ZqYmcnkq3j0o1/mRWfNxAhQXzInOLCgtv8.jpg?auto=format&w=296 296w,     https://web-dev.imgix.net/image/vgdbNJBYHma2o62ZqYmcnkq3j0o1/mRWfNxAhQXzInOLCgtv8.jpg?auto=format&w=338 338w,     https://web-dev.imgix.net/image/vgdbNJBYHma2o62ZqYmcnkq3j0o1/mRWfNxAhQXzInOLCgtv8.jpg?auto=format&w=385 385w,     https://web-dev.imgix.net/image/vgdbNJBYHma2o62ZqYmcnkq3j0o1/mRWfNxAhQXzInOLCgtv8.jpg?auto=format&w=439 439w,     https://web-dev.imgix.net/image/vgdbNJBYHma2o62ZqYmcnkq3j0o1/mRWfNxAhQXzInOLCgtv8.jpg?auto=format&w=500 500w,     https://web-dev.imgix.net/image/vgdbNJBYHma2o62ZqYmcnkq3j0o1/mRWfNxAhQXzInOLCgtv8.jpg?auto=format&w=571 571w,     https://web-dev.imgix.net/image/vgdbNJBYHma2o62ZqYmcnkq3j0o1/mRWfNxAhQXzInOLCgtv8.jpg?auto=format&w=650 650w,     https://web-dev.imgix.net/image/vgdbNJBYHma2o62ZqYmcnkq3j0o1/mRWfNxAhQXzInOLCgtv8.jpg?auto=format&w=741 741w,     https://web-dev.imgix.net/image/vgdbNJBYHma2o62ZqYmcnkq3j0o1/mRWfNxAhQXzInOLCgtv8.jpg?auto=format&w=845 845w,     https://web-dev.imgix.net/image/vgdbNJBYHma2o62ZqYmcnkq3j0o1/mRWfNxAhQXzInOLCgtv8.jpg?auto=format&w=964 964w,     https://web-dev.imgix.net/image/vgdbNJBYHma2o62ZqYmcnkq3j0o1/mRWfNxAhQXzInOLCgtv8.jpg?auto=format&w=1098 1098w,     https://web-dev.imgix.net/image/vgdbNJBYHma2o62ZqYmcnkq3j0o1/mRWfNxAhQXzInOLCgtv8.jpg?auto=format&w=1252 1252w,     https://web-dev.imgix.net/image/vgdbNJBYHma2o62ZqYmcnkq3j0o1/mRWfNxAhQXzInOLCgtv8.jpg?auto=format&w=1428 1428w,     https://web-dev.imgix.net/image/vgdbNJBYHma2o62ZqYmcnkq3j0o1/mRWfNxAhQXzInOLCgtv8.jpg?auto=format&w=1600 1600w"          width="800"   />
<p>In most cases, the fix is straightforward:</p>
<h4 id="to-refactor-inline-event-handlers-rewrite-them-to-be-added-from-a-javascript-block">To refactor inline event handlers, rewrite them to be added from a JavaScript block <a class="w-headline-link" href="#to-refactor-inline-event-handlers-rewrite-them-to-be-added-from-a-javascript-block">#</a></h4>
<figure class="compare flow" data-type="worse"><p class="compare__label">Blocked by CSP</p>
<web-copy-code><pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token special-attr"><span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript"><span class="token function">doThings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>A thing.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span></code></pre>
</web-copy-code><figcaption class="compare__caption">
<p>CSP will block inline event handlers.</p>
</figcaption>
</figure>
<figure class="compare flow" data-type="better"><p class="compare__label">Allowed by CSP</p>
<web-copy-code><pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>things<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>A thing.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">nonce</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>${nonce}<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript"><br>  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'things'</span><span class="token punctuation">)</span><br>          <span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> doThings<span class="token punctuation">)</span><span class="token punctuation">;</span><br></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code></pre>
</web-copy-code><figcaption class="compare__caption">
<p>CSP will allow event handlers that are registered via JavaScript.</p>
</figcaption>
</figure>
<h4 id="for-javascript:-uris-you-can-use-a-similar-pattern">For <code>javascript:</code> URIs, you can use a similar pattern <a class="w-headline-link" href="#for-javascript:-uris-you-can-use-a-similar-pattern">#</a></h4>
<figure class="compare flow" data-type="worse"><p class="compare__label">Blocked by CSP</p>
<web-copy-code><pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>javascript:linkClicked()<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>foo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span></code></pre>
</web-copy-code><figcaption class="compare__caption">
<p>CSP will block javascript: URIs.</p>
</figcaption>
</figure>
<figure class="compare flow" data-type="better"><p class="compare__label">Allowed by CSP</p>
<web-copy-code><pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>foo<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>foo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">nonce</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>${nonce}<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript"><br>  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span><br>          <span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> linkClicked<span class="token punctuation">)</span><span class="token punctuation">;</span><br></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code></pre>
</web-copy-code><figcaption class="compare__caption">
<p>CSP will allow event handlers that are registered via JavaScript.</p>
</figcaption>
</figure>
<h4 id="use-of-eval()-in-javascript">Use of <code>eval()</code> in JavaScript <a class="w-headline-link" href="#use-of-eval()-in-javascript">#</a></h4>
<p>If your application uses <code>eval()</code> to convert JSON string serializations into JS
objects, you should refactor such instances to <code>JSON.parse()</code>, which is also
<a href="https://v8.dev/blog/cost-of-javascript-2019#json" rel="noopener">faster</a>.</p>
<p>If you cannot remove all uses of <code>eval()</code>, you can still set a strict
nonce-based CSP, but you will have to use the <code>'unsafe-eval'</code> CSP keyword which
will make your policy slightly less secure.</p>
<p>You can find these and more examples of such refactoring in this strict CSP
Codelab:</p>
<div class="glitch-embed-wrap" style="height: 420px; width: 100%;">
  <iframe
    allow="camera; clipboard-read; clipboard-write; encrypted-media; geolocation; microphone; midi"
    loading="lazy"
    src="https://glitch.com/embed/#!/embed/strict-csp-codelab?attributionHidden=true&sidebarCollapsed=true&path=demo%2Fsolution_nonce_csp.html&highlights=14%2C20%2C28%2C39%2C40%2C41%2C42%2C43%2C44%2C45%2C54%2C55%2C56%2C57%2C58%2C59%2C60&previewSize=35"
    style="height: 100%; width: 100%; border: 0;"
    title="strict-csp-codelab on Glitch"
  ></iframe>
</div>
<h3 id="step-4:-add-fallbacks-to-support-safari-and-older-browsers">Step 4:  Add fallbacks to support Safari and older browsers <a class="w-headline-link" href="#step-4:-add-fallbacks-to-support-safari-and-older-browsers">#</a></h3>
<p>CSP is supported by all major browsers, but you'll need two fallbacks:</p>
<ul>
<li>
<p>Using <code>'strict-dynamic'</code> requires adding <code>https:</code> as a fallback for Safari,
the only major browser without support for <code>'strict-dynamic'</code>. By doing so:</p>
<ul>
<li>All browsers that support <code>'strict-dynamic'</code> will ignore the <code>https:</code>
fallback, so this won't reduce the strength of the policy.</li>
<li>In Safari, externally sourced scripts will be allowed to load only if they
come from an HTTPS origin. This is less secure than a strict CSP‚Äìit's a
fallback‚Äìbut would still prevent certain common XSS causes like injections
of <code>javascript:</code> URIs because <code>'unsafe-inline'</code> is not present or ignored
in presence of a hash or nonce.</li>
</ul>
</li>
<li>
<p>To ensure compatibility with very old browser versions (4+ years), you can add
<code>'unsafe-inline'</code> as a fallback. All recent browsers will ignore
<code>'unsafe-inline'</code> if a CSP nonce or hash is present.</p>
</li>
</ul>
<web-copy-code><pre class="language-text"><code class="language-text">Content-Security-Policy:<br>  script-src 'nonce-{random}' 'strict-dynamic' https: 'unsafe-inline';<br>  object-src 'none';<br>  base-uri 'none';</code></pre>
</web-copy-code><aside class="aside flow bg-state-info-bg color-state-info-text">
<div class=" flow">
<p><code>https:</code> and <code>unsafe-inline</code> don't make your policy less safe
because they will be ignored by browsers which support <code>strict-dynamic</code>.</p>
</div></aside>
<h3 id="step-5:-deploy-your-csp">Step 5:  Deploy your CSP <a class="w-headline-link" href="#step-5:-deploy-your-csp">#</a></h3>
<p>After confirming that no legitimate scripts are being blocked by CSP in your
local development environment, you can proceed with deploying your CSP to your
(staging, then) production environment:</p>
<ol>
<li>(Optional) Deploy your CSP in report-only mode using the
<code>Content-Security-Policy-Report-Only</code> header. Learn more about the <a href="https://developers.google.com/web/updates/2018/09/reportingapi" rel="noopener">Reporting
API</a>.
Report-only mode is handy to test a potentially breaking change like a new
CSP in production, before actually enforcing CSP restrictions. In report-only
mode, your CSP does not affect the behavior of your application (nothing will
actually break). But the browser will still generate console errors and
violation reports when patterns incompatible with CSP are encountered (so you
can see what would have broken for your end-users).</li>
<li>Once you're confident that your CSP won't induce breakage for your end-users,
deploy your CSP using the <code>Content-Security-Policy</code> response header. <strong>Only
once you've completed this step, will CSP begin to protect your application
from XSS</strong>. Setting your CSP via a HTTP header server-side is more secure
than setting it as a <code>&lt;meta&gt;</code> tag; use a header if you can.</li>
</ol>
<aside class="aside flow bg-tertiary-box-bg color-tertiary-box-text">
<p class="cluster ">
<span class="aside__icon box-block "><svg width="24" height="24" viewBox="0 0 24 24" role="img" aria-label="Lightbulb" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
  <path d="M9 21c0 .55.45 1 1 1h4c.55 0 1-.45 1-1v-1H9v1zm3-19C8.14 2 5 5.14 5 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26c1.81-1.27 3-3.36 3-5.74 0-3.86-3.14-7-7-7zm2.85 11.1l-.85.6V16h-4v-2.3l-.85-.6A4.997 4.997 0 017 9c0-2.76 2.24-5 5-5s5 2.24 5 5c0 1.63-.8 3.16-2.15 4.1z" />
</svg></span>
<strong>Gotchas</strong></p>
<div class=" flow">
<p>Make sure that the CSP you're using is &quot;strict&quot; by
checking it with the <a href="https://csp-evaluator.withgoogle.com" rel="noopener">CSP Evaluator</a> or
Lighthouse. This is very important, as even small changes to a policy can
significantly reduce its security.</p>
</div></aside>
<aside class="aside flow bg-state-bad-bg color-state-bad-text">
<p class="cluster color-state-bad-text">
<span class="aside__icon box-block "><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Error sign">
  <path fill-rule="evenodd" clip-rule="evenodd" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15v-2h2v2h-2zm0-10v6h2V7h-2z" />
</svg></span>
<strong>Caution</strong></p>
<div class=" flow">
<p>When enabling CSP for production traffic, you may see some
noise in the CSP violation reports due to browser extensions and malware.</p>
</div></aside>
<h2 id="limitations">Limitations <a class="w-headline-link" href="#limitations">#</a></h2>
<p>Generally speaking, a strict CSP provides a strong added layer of security that
helps to mitigate XSS. In most cases, CSP reduces the attack surface
significantly (dangerous patterns like <code>javascript:</code> URIs are completely turned
off). However, based on the type of CSP you're using (nonces, hashes, with or
without <code>'strict-dynamic'</code>), there are cases where CSP doesn't protect:</p>
<ul>
<li>If you nonce a script, but there's an injection directly into the body or into
the <code>src</code> parameter of that <code>&lt;script&gt;</code> element.</li>
<li>If there are injections into the locations of dynamically created scripts
(<code>document.createElement('script')</code>), including into any library functions
which create <code>script</code> DOM nodes based on the value of their arguments. This
includes some common APIs such as jQuery's <code>.html()</code>, as well as <code>.get()</code> and
<code>.post()</code> in jQuery &lt; 3.0.</li>
<li>If there are template injections in old AngularJS applications. An attacker
who can inject an AngularJS template can use it to <a href="https://sites.google.com/site/bughunteruniversity/nonvuln/angularjs-expression-sandbox-bypass" rel="noopener">execute arbitrary
JavaScript</a>.</li>
<li>If the policy contains <code>'unsafe-eval'</code>, injections into <code>eval()</code>,
<code>setTimeout()</code> and a few other rarely used APIs.</li>
</ul>
<p>Developers and security engineers should pay particular attention to such
patterns during code reviews and security audits. You can find more details on
the cases described above in <a href="https://static.sched.com/hosted_files/locomocosec2019/db/CSP%20-%20A%20Successful%20Mess%20Between%20Hardening%20and%20Mitigation%20%281%29.pdf#page=27" rel="noopener">this CSP
presentation</a>.</p>
<aside class="aside flow bg-state-info-bg color-state-info-text">
<div class=" flow">
<p>Trusted Types complements strict CSP very well and can efficiently
protect against some of the limitations listed above. Learn more about <a href="/trusted-types">how to
use Trusted Types at web.dev</a>.</p>
</div></aside>
<h2 id="further-reading">Further reading <a class="w-headline-link" href="#further-reading">#</a></h2>
<ul>
<li><a href="https://research.google/pubs/pub45542/" rel="noopener">CSP Is Dead, Long Live CSP! On the Insecurity of Whitelists and the Future of
Content Security Policy</a></li>
<li><a href="https://csp-evaluator.withgoogle.com/" rel="noopener">CSP Evaluator</a></li>
<li><a href="https://static.sched.com/hosted_files/locomocosec2019/db/CSP%20-%20A%20Successful%20Mess%20Between%20Hardening%20and%20Mitigation%20%281%29.pdf" rel="noopener">LocoMoco Conference: Content Security Policy - A successful mess between
hardening and
mitigation</a></li>
<li><a href="https://webappsec.dev/assets/pub/Google_IO-Securing_Web_Apps_with_Modern_Platform_Features.pdf" rel="noopener">Google I/O talk: Securing Web Apps with Modern Platform
Features</a></li>
</ul>


      

      <div class="cluster gutter-base flow-space-size-2" role="list" aria-label="tags">
        
          
        
          
        
          
            
            <a class="pill" href="/tags/security/">Security</a>
          
        
      </div>

      <div class="text-size-0 color-mid-text">
        <span>
          
          Last updated: <time>Mar 15, 2021</time>
          
        </span>
        ‚Äî
        <a
          href="https://github.com/GoogleChrome/web.dev/blob/main/src/site/content/en/blog/strict-csp/index.md"
        >
          Improve article
        </a>
      </div>

      

      
        
        
      

      
        <div class="flow-space-size-2">
          <a href="/blog" class="button" data-type="secondary">
            <svg xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>

            <span>Return to all articles</span>
          </a>
        </div>
      
      <div class="docked-actions flow flow-space-base">    
        <div>
          <share-action class="gc-analytics-event fab"
            authors="@we1x"
            data-category="web.dev"
            data-label="share"
            data-action="click"
            data-type="primary"
            data-icon="share"
            tabindex="0"
            role="button"
          >
            <svg xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 24 24"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M18 16.1c-.8 0-1.4.3-2 .8l-7.1-4.2c.1-.2.1-.5.1-.7s0-.5-.1-.7L16 7.2c.5.5 1.2.8 2 .8 1.7 0 3-1.3 3-3s-1.3-3-3-3-3 1.3-3 3c0 .2 0 .5.1.7L8 9.8C7.5 9.3 6.8 9 6 9c-1.7 0-3 1.3-3 3s1.3 3 3 3c.8 0 1.5-.3 2-.8l7.1 4.2c-.1.2-.1.4-.1.6 0 1.6 1.3 2.9 2.9 2.9s2.9-1.3 2.9-2.9-1.2-2.9-2.8-2.9z" fill="currentColor"/></svg>
 
            <span class="fab__label">Share</span>
          </share-action>
        </div>
        
      </div>
    </article>
  </div>
</div>


</main>
<footer class="site-footer" role="contentinfo">
  <nav class="site-footer__primary-nav auto-grid" aria-label="footer navigation">
    <div>
      <h3 class="text-size-2 color-mid-text">Contribute</h3>
      <ul class="w-footer__linkbox-list" role="list">
        <li>
          <a href="https://github.com/GoogleChrome/web.dev/issues/new?assignees=&labels=bug&template=bug_report.md&title="
            data-category="Site-Wide Custom Events" data-label="Footer Link (index 1)">
            File a bug
          </a>
        </li>
        <li>
          <a href="https://github.com/googlechrome/web.dev"
            data-category="Site-Wide Custom Events" data-label="Footer Link (index 2)">
            View source
          </a>
        </li>
      </ul>
    </div>
    <div>
      <h3 class="text-size-2 color-mid-text">Related content</h3>
      <ul class="w-footer__linkbox-list" role="list">
          <li>
          <a href="https://developer.chrome.com/"
            data-category="Site-Wide Custom Events" data-label="Footer Link (index 1)">
            developer.chrome.com
          </a>
        </li>
        <li>
          <a href="https://blog.chromium.org/"
            data-category="Site-Wide Custom Events" data-label="Footer Link (index 1)">
            Chrome updates
          </a>
        </li>
        <li>
          <a href="https://developers.google.com/web/fundamentals"
            data-category="Site-Wide Custom Events" data-label="Footer Link (index 2)">
            Web Fundamentals
          </a>
        </li>
        <li>
          <a href="/tags/case-study/"
            data-category="Site-Wide Custom Events" data-label="Footer Link (index 3)">
            Case studies
          </a>
        </li>
        <li>
          <a href="/podcasts/"
            data-category="Podcasts" data-label="Footer Link (index 5)">
            Podcasts
          </a>
        </li>
        <li>
          <a href="/shows/"
            data-category="Shows" data-label="Footer Link (index 6)">
            Shows
          </a>
        </li>
      </ul>
    </div>
    <div>
      <h3 class="text-size-2 color-mid-text">Connect</h3>
      <ul class="w-footer__linkbox-list" role="list">
        <li>
          <a href="https://www.twitter.com/ChromiumDev"
            data-category="Site-Wide Custom Events" data-label="Footer Link (index 1)">
            Twitter
          </a>
        </li>
        <li>
          <a href="https://www.youtube.com/user/ChromeDevelopers"
            data-category="Site-Wide Custom Events" data-label="Footer Link (index 2)">
            YouTube
          </a>
        </li>
      </ul>
    </div>
  </nav>
  <nav class="site-footer__brand-nav repel" aria-label="Google developers">
    <ul class="cluster" role="list">
      <li>
        <a href="https://developers.google.com/" data-category="Site-Wide Custom Events" data-label="Footer Google Developers Link">
          <img loading="lazy" width="185" height="33" class="w-footer__utility-logo" src="/images/lockup-color.png"
            alt="Google Developers" />
        </a>
      </li>
      <li>
        <a href="https://developer.chrome.com/"
          data-category="Site-Wide Custom Events" data-label="Footer Chrome Link">
          Chrome
        </a>
      </li>
      <li>
        <a href="https://firebase.google.com/" data-category="Site-Wide Custom Events"
          data-label="Footer Firebase Link">
          Firebase
        </a>
      </li>
      <li>
        <a href="https://cloud.google.com/" data-category="Site-Wide Custom Events"
          data-label="Footer Google Cloud Platform Link">
          Google Cloud Platform
        </a>
      </li>
      <li>
        <a href="https://developers.google.com/products"
          data-category="Site-Wide Custom Events" data-label="Footer All products Link">
          All products
        </a>
      </li>
    </ul>
    <web-language-select current="en"></web-language-select>
  </nav>
  <nav class="site-footer__misc-links" aria-label="terms and policies">
    <ul class="cluster" role="list">
      <li>
        <a href="https://policies.google.com/" data-category="Site-Wide Custom Events"
          data-label="Footer Terms and Privacy link">
          Terms &amp; Privacy
        </a>
      </li>
      <li>
        <a href="/community-guidelines/" data-category="Site-Wide Custom Events"
          data-label="Footer Community Guidelines link">
          Community Guidelines
        </a>
      </li>
    </ul>
  </nav>
  <p class="gap-top-size-2 text-size-0">
    Except as otherwise noted, the content of this page is licensed
    under the
    <a href="https://creativecommons.org/licenses/by/4.0/">
    Creative Commons Attribution 4.0 License</a>,
    and code samples are licensed under the
    <a href="https://www.apache.org/licenses/LICENSE-2.0">
    Apache 2.0 License</a>. For details, see the
    <a href="https://developers.google.com/terms/site-policies">
    Google Developers Site Policies</a>.
  </p>
</footer>


  </body>
</html>
