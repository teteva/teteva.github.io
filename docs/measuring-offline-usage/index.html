
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">


  
    
    <link rel="stylesheet" href="/css/main.css?v=b2e0b4f84209b">
  

  <link rel="preload" as="font" crossorigin href="/fonts/material-icons/regular.woff2">


<link rel="preload" as="font" crossorigin href="/fonts/google-sans/regular/latin.woff2">
<link rel="preload" as="font" crossorigin href="/fonts/google-sans/bold/latin.woff2">

<meta name="theme-color" content="#fff"/>




<title>Measuring offline usage</title>
<meta name="description" content="How to track offline usage of your site so that you can make a case as to why your site needs a better offline experience. " />

<link rel="canonical" href="https://web.dev/measuring-offline-usage/" />

<meta itemprop="name" content="Measuring offline usage" />
<meta itemprop="description" content="How to track offline usage of your site so that you can make a case as to why your site needs a better offline experience. " />
<meta itemprop="image" content="https://web-dev.imgix.net/image/admin/NvPzgpuXtjuz5oE54SWn.jpg?auto=format&fit=max&w=1200&fm=auto" />
<meta property="og:locale" content="en_US" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://web.dev/measuring-offline-usage/" />
<meta property="og:site_name" content="web.dev" />
<meta property="og:title" content="Measuring offline usage" />
<meta property="og:description" content="How to track offline usage of your site so that you can make a case as to why your site needs a better offline experience. " />
<meta property="og:image" content="https://web-dev.imgix.net/image/admin/NvPzgpuXtjuz5oE54SWn.jpg?auto=format&fit=max&w=1200&fm=auto" />
<meta property="og:image:alt" content="People on a subway." />
<meta property="tag" content="offline" />
<meta property="tag" content="network" />
<meta property="tag" content="service-worker" />
<meta property="tag" content="metrics" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="Measuring offline usage" />
<meta name="twitter:description" content="How to track offline usage of your site so that you can make a case as to why your site needs a better offline experience. " />
<meta name="twitter:image" content="https://web-dev.imgix.net/image/admin/NvPzgpuXtjuz5oE54SWn.jpg?auto=format&fit=max&w=1200&fm=auto" />
<link
  rel="alternate"
  href="/feed.xml"
  type="application/atom+xml"
  data-title="web.dev feed"
/>

<link rel="manifest" href="/manifest.webmanifest" />

<link rel="shortcut icon" href="/images/favicon.ico">
<link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
<link rel="mask-icon" color="#0054ff" href="/images/safari-pinned-tab.svg">



<script>
window.ga =
  window.ga ||
  function () {
    (ga.q = ga.q || []).push(arguments);
  };
ga.l = +new Date();
ga('create', 'UA-126406676-2');
ga('set', 'transport', 'beacon');
ga('set', 'anonymizeIp', true);
ga('set', 'page', window.location.pathname);
ga('set', 'dimension5', '4');
ga('send', 'pageview');
</script>







<script>
function loadScript(url, type) {
  const s = document.createElement('script');
  s.src = url;
  if (type) {
    s.type = type;
  }
  if (type === 'module') {
    s.async = false; // Preserve load order.
    const pre = document.createElement('link');
    pre.rel = 'modulepreload';
    pre.href = url;
    document.head.append(pre);
    // We use DOMContentLoaded as the loader script is running sync, and inserting a module script here doesn't defer. This brings back normal type="module" behavior.
    window.addEventListener('DOMContentLoaded', () => {
      document.head.append(s);
    });
  } else {
    document.head.append(s);
  }
}
loadScript('/js/app.js?v=dba9ea3bb2e3d', 'module');




  loadScript('/js/content.js?v=4d72b64877b83', 'module');


  loadScript('https://www.google-analytics.com/analytics.js', null);

</script>

  </head>
  <body class="unresolved">
    
    <web-snackbar-container></web-snackbar-container>

    



<web-header class="header-default" role="navigation">
  <button data-open-drawer-button class="w-button--svg w-button--round" aria-label="Open menu">
    








  










  <svg class="icon " role="img" aria-label="menu" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" height="24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>


    <span class="w-tooltip w-tooltip--left">Open menu</span>
  </button>

  <a
    href="/"
    class="header-default__logo-link gc-analytics-event"
    data-category="Site-Wide Custom Events"
    data-label="Site logo"
  >
    <img class="header-default__logo" width="125" height="23" src="/images/lockup.svg" alt="web.dev" />
  </a>

  <div class="header-default__middle">
    <div class="header-default__links">
      <a
        href="/learn/"
        class="header-default__link gc-analytics-event"
        data-category="Site-Wide Custom Events"
        data-label="Tab: Learn"
      >
        Learn
      </a>

      <a
        href="/measure/"
        class="header-default__link gc-analytics-event"
        data-category="Site-Wide Custom Events"
        data-label="Tab: Measure"
      >
        Measure
      </a>

      <a
        href="/blog/"
        class="header-default__link gc-analytics-event"
        data-category="Site-Wide Custom Events"
        data-label="Tab: Blog"
      >
        Blog
      </a>

      <a
        href="/about/"
        class="header-default__link gc-analytics-event"
        data-category="Site-Wide Custom Events"
        data-label="Tab: About"
      >
        About
      </a>
    </div>
    <web-search results-id="search-main-results" i18n="{&quot;search&quot;:{&quot;en&quot;:&quot;Search&quot;},&quot;open_search&quot;:{&quot;en&quot;:&quot;Open search&quot;},&quot;all_articles&quot;:{&quot;en&quot;:&quot;All articles&quot;},&quot;close_search&quot;:{&quot;en&quot;:&quot;Close search&quot;}}"></web-search>
    <web-search-results id="search-main-results"></web-search-results>
  </div>

  <web-profile-switcher-container></web-profile-switcher-container>
</web-header>



<web-navigation-drawer class="drawer-default" type="modal">
  <nav data-drawer-container>
    <div class="drawer-default__contents">
      <div class="drawer-default__header">
        <button
          data-drawer-close-button
          class="drawer-default__hide w-button--svg w-button--round"
          aria-label="Close"
        >
          








  










  <svg class="icon " role="img" aria-label="close" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" height="24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>


          <span class="w-tooltip">Close</span>
        </button>
        <a
          href="/"
          class="gc-analytics-event"
          data-category="Site-Wide Custom Events"
          data-label="Site logo"
        >
          <img
            width="125"
            height="30"
            class="drawer-default__logo"
            src="/images/lockup.svg"
            alt="web.dev"
          />
        </a>
      </div>
      <a
        href="/learn/"
        class="drawer-default__link gc-analytics-event"
        data-category="Site-Wide Custom Events"
        data-label="SideNav: Learn"
      >
        Learn
      </a>
      <a
        href="/measure/"
        class="drawer-default__link gc-analytics-event"
        data-category="Site-Wide Custom Events"
        data-label="SideNav: Measure"
      >
        Measure
      </a>
      <a
        href="/blog/"
        class="drawer-default__link gc-analytics-event"
        data-category="Site-Wide Custom Events"
        data-label="SideNav: Blog"
      >
        Blog
      </a>
      <a
        href="/about/"
        class="drawer-default__link gc-analytics-event"
        data-category="Site-Wide Custom Events"
        data-label="SideNav: About"
      >
        About
      </a>
    </div>
  </nav>
</web-navigation-drawer>

<main>
  <div id="content">
    
      
    
    


<div class="guide-landing-page">
  
    
    
    
  
  

  
    <img     alt="People on a subway."     class="w-hero w-hero--cover"     decoding="auto"     height="480"               sizes="100vw"     src="https://web-dev.imgix.net/image/admin/NvPzgpuXtjuz5oE54SWn.jpg?auto=format"     srcset="https://web-dev.imgix.net/image/admin/NvPzgpuXtjuz5oE54SWn.jpg?auto=format&w=200 200w,     https://web-dev.imgix.net/image/admin/NvPzgpuXtjuz5oE54SWn.jpg?auto=format&w=228 228w,     https://web-dev.imgix.net/image/admin/NvPzgpuXtjuz5oE54SWn.jpg?auto=format&w=260 260w,     https://web-dev.imgix.net/image/admin/NvPzgpuXtjuz5oE54SWn.jpg?auto=format&w=296 296w,     https://web-dev.imgix.net/image/admin/NvPzgpuXtjuz5oE54SWn.jpg?auto=format&w=338 338w,     https://web-dev.imgix.net/image/admin/NvPzgpuXtjuz5oE54SWn.jpg?auto=format&w=385 385w,     https://web-dev.imgix.net/image/admin/NvPzgpuXtjuz5oE54SWn.jpg?auto=format&w=439 439w,     https://web-dev.imgix.net/image/admin/NvPzgpuXtjuz5oE54SWn.jpg?auto=format&w=500 500w,     https://web-dev.imgix.net/image/admin/NvPzgpuXtjuz5oE54SWn.jpg?auto=format&w=571 571w,     https://web-dev.imgix.net/image/admin/NvPzgpuXtjuz5oE54SWn.jpg?auto=format&w=650 650w,     https://web-dev.imgix.net/image/admin/NvPzgpuXtjuz5oE54SWn.jpg?auto=format&w=741 741w,     https://web-dev.imgix.net/image/admin/NvPzgpuXtjuz5oE54SWn.jpg?auto=format&w=845 845w,     https://web-dev.imgix.net/image/admin/NvPzgpuXtjuz5oE54SWn.jpg?auto=format&w=964 964w,     https://web-dev.imgix.net/image/admin/NvPzgpuXtjuz5oE54SWn.jpg?auto=format&w=1098 1098w,     https://web-dev.imgix.net/image/admin/NvPzgpuXtjuz5oE54SWn.jpg?auto=format&w=1252 1252w,     https://web-dev.imgix.net/image/admin/NvPzgpuXtjuz5oE54SWn.jpg?auto=format&w=1428 1428w,     https://web-dev.imgix.net/image/admin/NvPzgpuXtjuz5oE54SWn.jpg?auto=format&w=1600 1600w"          width="1600"   />
  

  <web-table-of-contents>
    <h2 class="w-toc__header">
      <a href="#measuring-offline-usage" class="w-toc__header--link">
        Measuring offline usage
      </a>
    </h2>
    <div class="w-toc__list">
        <ul><li><a href="#the-pitfalls-of-the-online-and-offline-browser-events">The pitfalls of the online and offline browser events</a></li><li><a href="#a-better-approach:-the-service-worker">A better approach: the service worker</a></li><li><a href="#spas-and-lazy-loading">SPAs and lazy loading</a></li><li><a href="#next-steps">Next steps</a></li></ul></div>
  </web-table-of-contents>
  <web-table-of-contents-button></web-table-of-contents-button>

  
  <div class="w-actions">
    <share-action authors="Stephan Giesau | @martinschierle"
      class="gc-analytics-event w-actions__fab w-actions__fab--share"
      data-category="web.dev"
      data-label="share"
      data-action="click"
      data-icon="share"
      tabindex="0"
      role="button"
    >
      <span>Share</span>
    </share-action>
    
    
  </div>

  <div class="w-layout-container--narrow w-post-content">
    <header class="w-article-header">
      
        
        <div class="w-post-breadcrumbs">
          <ul class="w-breadcrumbs">
  <li class="w-breadcrumbs__crumb">
    <a
      class="w-breadcrumbs__link w-breadcrumbs__link--left-justify gc-analytics-event"
      data-category="web.dev"
      data-label="post, home breadcrumb"
      data-action="click"
      href="/"
    >
      Home
    </a>
  </li>

  <svg
    class="w-breadcrumbs__icon"
    xmlns="http://www.w3.org/2000/svg"
    height="24"
    viewBox="0 0 24 24"
    width="24"
    aria-hidden="true"
  >
    <path d="M0 0h24v24H0V0z" fill="none" />
    <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z" />
  </svg>

  <li class="w-breadcrumbs__crumb">
    <a
      class="w-breadcrumbs__link gc-analytics-event"
      data-category="web.dev"
      data-label="post, path breadcrumb"
      data-action="click"
      href=/blog
    >
      All articles
    </a>
  </li>
</ul>
        </div>
      

      <h1 id="measuring-offline-usage" class="w-article-header__headline">Measuring offline usage</h1>
      
        <p class="w-article-header__subhead w-mb--non">
          <p>How to track offline usage of your site so that you can make a case as to why your site needs a better offline experience.</p>

        </p>
      

      
        <div class="w-author__published">
          <time>Oct 28, 2020</time>
          
        </div>
      

      
      

      <div class="w-layout-container--narrow w-post-signpost">
  <span class="w-post-signpost__title">
    Appears in:
  </span>
  <a
          class="w-post-signpost__link"
          href="/reliable"
          >Network reliability</a
        >
</div>

      
        <div class="w-authors w-mt--xl w-pt--sm">
          
            <div class="w-author">
  <a href="/authors/giesau/"><img     alt="Stephan Giesau"     class="w-author__image"     decoding="async"     height="64"          loading="lazy"     sizes="(min-width: 64px) 64px, calc(100vw - 48px)"     src="https://web-dev.imgix.net/image/admin/smQwRPUSvlFH6IDe3TNX.jpg?auto=format&fit=crop&h=64&w=64"     srcset="https://web-dev.imgix.net/image/admin/smQwRPUSvlFH6IDe3TNX.jpg?fit=crop&h=64&w=64&auto=format&dpr=1&q=75 1x,     https://web-dev.imgix.net/image/admin/smQwRPUSvlFH6IDe3TNX.jpg?fit=crop&h=64&w=64&auto=format&dpr=2&q=50 2x,     https://web-dev.imgix.net/image/admin/smQwRPUSvlFH6IDe3TNX.jpg?fit=crop&h=64&w=64&auto=format&dpr=3&q=35 3x,     https://web-dev.imgix.net/image/admin/smQwRPUSvlFH6IDe3TNX.jpg?fit=crop&h=64&w=64&auto=format&dpr=4&q=23 4x,     https://web-dev.imgix.net/image/admin/smQwRPUSvlFH6IDe3TNX.jpg?fit=crop&h=64&w=64&auto=format&dpr=5&q=20 5x"          width="64"   /></a>
  <div
    class="w-author__info"
    style="display: flex; flex-direction: column; justify-content: center;"
  >
    <cite class="w-author__name">
      <a class="w-author__name-link" href="/authors/giesau/">Stephan Giesau</a>
    </cite>
    
  </div>
</div>
          
            <div class="w-author">
  <a href="/authors/martinschierle/"><img     alt="Martin Schierle"     class="w-author__image"     decoding="async"     height="64"          loading="lazy"     sizes="(min-width: 64px) 64px, calc(100vw - 48px)"     src="https://web-dev.imgix.net/image/admin/DheRfImH6FxRNajMslIk.jpg?auto=format&fit=crop&h=64&w=64"     srcset="https://web-dev.imgix.net/image/admin/DheRfImH6FxRNajMslIk.jpg?fit=crop&h=64&w=64&auto=format&dpr=1&q=75 1x,     https://web-dev.imgix.net/image/admin/DheRfImH6FxRNajMslIk.jpg?fit=crop&h=64&w=64&auto=format&dpr=2&q=50 2x,     https://web-dev.imgix.net/image/admin/DheRfImH6FxRNajMslIk.jpg?fit=crop&h=64&w=64&auto=format&dpr=3&q=35 3x,     https://web-dev.imgix.net/image/admin/DheRfImH6FxRNajMslIk.jpg?fit=crop&h=64&w=64&auto=format&dpr=4&q=23 4x,     https://web-dev.imgix.net/image/admin/DheRfImH6FxRNajMslIk.jpg?fit=crop&h=64&w=64&auto=format&dpr=5&q=20 5x"          width="64"   /></a>
  <div
    class="w-author__info"
    style="display: flex; flex-direction: column; justify-content: center;"
  >
    <cite class="w-author__name">
      <a class="w-author__name-link" href="/authors/martinschierle/">Martin Schierle</a>
    </cite>
    <ul class="w-author__link-list">
      <li class="w-author__link-listitem">
        <a class="w-author__link" href="https://twitter.com/martinschierle"
          >Twitter</a
        >
      </li>
      <li class="w-author__link-listitem">
        <a class="w-author__link" href="https://github.com/martinschierle">GitHub</a>
      </li>
      
      
    </ul>
  </div>
</div>
          
        </div>
      
    </header>

    

    <p>This article shows you how to track offline usage of your site to help you make a case for why your
site needs a better offline mode. It also explains pitfalls and problems to avoid when implementing
offline usage analytics.</p>
<h2 id="the-pitfalls-of-the-online-and-offline-browser-events">The pitfalls of the online and offline browser events <a class="w-headline-link" href="#the-pitfalls-of-the-online-and-offline-browser-events">#</a></h2>
<p>The obvious solution for tracking offline usage is to create event listeners for the
<a href="https://developer.mozilla.org/docs/Web/API/Window/online_event" rel="noopener"><code>online</code></a> and
<a href="https://developer.mozilla.org/docs/Web/API/Window/offline_event" rel="noopener"><code>offline</code></a> events (which
<a href="https://caniuse.com/#feat=online-status" rel="noopener">many browsers support</a>) and to put your analytics tracking
logic in those listeners. Unfortunately, there are several problems and limitations with this
approach:</p>
<ul>
<li>In general tracking every network connection status event might be excessive, and is
counter-productive in a privacy-centric world where as little data as possible should be
collected. Additionally the <code>online</code> and <code>offline</code> events can fire for just a split second of
network loss, which a user probably wouldn't even see or notice.</li>
<li>The analytics tracking of offline activity would never reach the analytics server because
the user is… well, offline.</li>
<li>Tracking a timestamp locally when a user goes offline and sending the offline activity to
the analytics server when the user goes back online depends on the user revisiting your site.
If the user drops off your site due to a lack of an offline mode and never revisits, you have
no way to track that. The ability to track offline drop-offs is critical data for building a
case about why your site needs a better offline mode.</li>
<li>The <code>online</code> event is not very reliable as it
<a href="https://developer.mozilla.org/docs/Web/API/NavigatorOnLine/onLine" rel="noopener">only knows about network access</a>,
not internet access. Therefore a user might still be offline, and sending the tracking ping can
still fail.</li>
<li>Even if the user still stays on the current page while being offline, none of the other
analytics events (e.g. scroll events, clicks, etc.) are tracked either, which might be the more
relevant and useful information.</li>
<li>Being offline in itself is also not too meaningful in general. As a website developer it may
be more important to know what kinds of resources failed to load. This is especially relevant
in the context of SPAs, where a dropped network connection might not lead to a browser offline
error page (which users understand) but more likely to random dynamic parts of the page failing
silently.</li>
</ul>
<p>You can still use this solution to gain a basic understanding of offline usage, but the many
drawbacks and limitations need to be considered carefully.</p>
<h2 id="a-better-approach:-the-service-worker">A better approach: the service worker <a class="w-headline-link" href="#a-better-approach:-the-service-worker">#</a></h2>
<p>The solution that enables offline mode turns out to be the better solution for tracking offline
usage.  The basic idea is to store analytics pings into IndexedDB as long as the user is offline,
and just resend them when the user goes online again. For Google Analytics this is already available
<a href="https://developers.google.com/web/tools/workbox/modules/workbox-google-analytics" rel="noopener">off-the-shelf through a Workbox module</a>,
but keep in mind that hits sent more than
<a href="https://developers.google.com/analytics/devguides/collection/protocol/v1/parameters#qt" rel="noopener">four hours deferred</a>
may not be processed. In its simplest form, it can be activated within a Workbox-based service
worker with these two lines:</p>
<web-copy-code><pre class="language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> googleAnalytics <span class="token keyword">from</span> <span class="token string">'workbox-google-analytics'</span><span class="token punctuation">;</span><br><br>googleAnalytics<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</web-copy-code><p>This tracks all existing events and pageview pings while being offline, but you wouldn't know that
they happened offline (as they are just replayed as-is). For this
<a href="https://developers.google.com/web/tools/workbox/modules/workbox-google-analytics#using_a_custom_dimension_to_track_online_vs_offline_interactions" rel="noopener">you can manipulate tracking requests with Workbox</a>
by adding an <code>offline</code> flag to the analytics ping, using a custom dimension (<code>cd1</code> in the code
sample below):</p>
<web-copy-code><pre class="language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> googleAnalytics <span class="token keyword">from</span> <span class="token string">'workbox-google-analytics'</span><span class="token punctuation">;</span><br><br>googleAnalytics<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>  parameterOverrides<span class="token operator">:</span> <span class="token punctuation">{</span><br>    cd1<span class="token operator">:</span> <span class="token string">'offline'</span><span class="token punctuation">,</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</web-copy-code><p>What if the user drops out of the page due to being offline, before an internet connection comes
back? Even though this normally puts the service worker to sleep (i.e. it's unable to send the data
when the connection comes back), the Workbox Google Analytics module uses the <a href="https://developers.google.com/web/updates/2015/12/background-sync" rel="noopener">Background Sync
API</a>, which sends the analytics
data later when the connection comes back, even if the user closes the tab or browser.</p>
<p>There is still a drawback: while this makes existing tracking offline-capable, you would most likely
not see much relevant data coming in until you implement a basic offline mode. Users would still
drop off your site quickly when the connection breaks away. But now you can at least measure and
quantify this, by comparing average session length and user engagement for users with the offline
dimension applied versus your regular users.</p>
<h2 id="spas-and-lazy-loading">SPAs and lazy loading <a class="w-headline-link" href="#spas-and-lazy-loading">#</a></h2>
<p>If users visiting a page built as a multi-page website go offline and try to navigate, the browser's
default offline page shows up, helping users understand what is happening. However, pages built as
single-page applications work differently. The user stays on the same page, and new content is
loaded dynamically through AJAX without any browser navigation. Users do not see the browser error
page when going offline. Instead, the dynamic parts of the page render with errors, go into
undefined states, or just stop being dynamic.</p>
<p>Similar effects can happen within multi-page websites due to lazy loading. For example, maybe the
initial load happened online, but the user went offline before scrolling. All lazy loaded content
below the fold will silently fail and be missing.</p>
<p>As these cases are really irritating to users, it makes sense to track them. Service workers are the
perfect spot to catch network errors, and eventually track them using analytics. With Workbox, a
<a href="https://developers.google.com/web/tools/workbox/guides/advanced-recipes#comprehensive_fallbacks" rel="noopener">global catch handler</a>
can be configured to inform the page about failed requests by sending a message event:</p>
<web-copy-code><pre class="language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> setCatchHandler <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'workbox-routing'</span><span class="token punctuation">;</span><br><br><span class="token function">setCatchHandler</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> event <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token comment">// https://developer.mozilla.org/docs/Web/API/Client/postMessage</span><br>  event<span class="token punctuation">.</span><span class="token function">waitUntil</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">// Exit early if we don't have access to the client.</span><br>    <span class="token comment">// Eg, if it's cross-origin.</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>event<span class="token punctuation">.</span>clientId<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span><br><br>    <span class="token comment">// Get the client.</span><br>    <span class="token keyword">const</span> client <span class="token operator">=</span> <span class="token keyword">await</span> clients<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>clientId<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token comment">// Exit early if we don't get the client.</span><br>    <span class="token comment">// Eg, if it closed.</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>client<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span><br><br>    <span class="token comment">// Send a message to the client.</span><br>    client<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>      action<span class="token operator">:</span> <span class="token string">"network_fail"</span><span class="token punctuation">,</span><br>      url<span class="token operator">:</span> event<span class="token punctuation">.</span>request<span class="token punctuation">.</span>url<span class="token punctuation">,</span><br>      destination<span class="token operator">:</span> event<span class="token punctuation">.</span>request<span class="token punctuation">.</span>destination<br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">return</span> Response<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</web-copy-code><p>Rather than listening to all failed requests, another way is to catch errors on specific routes
only. As an example, if we want to report errors happening on routes to <code>/products/*</code> only, we can
add a check in <code>setCatchHandler</code> which filters the URI with a regular expression.
A cleaner solution is to implement registerRoute with a custom handler. This encapsulates the
business logic into a separate route, with better maintainability in more complex service workers:</p>
<web-copy-code><pre class="language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> registerRoute <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'workbox-routing'</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> <span class="token punctuation">{</span> NetworkOnly <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'workbox-strategies'</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> networkOnly <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NetworkOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token function">registerRoute</span><span class="token punctuation">(</span><br>  <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token string">'https:\/\/example\.com\/products\/.+'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>  <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">params</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token keyword">try</span> <span class="token punctuation">{</span><br>      <span class="token comment">// Attempt a network request.</span><br>      <span class="token keyword">return</span> <span class="token keyword">await</span> networkOnly<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token comment">// If it fails, report the error.</span><br>      <span class="token keyword">const</span> event <span class="token operator">=</span> params<span class="token punctuation">.</span>event<span class="token punctuation">;</span><br>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>event<span class="token punctuation">.</span>clientId<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span><br>      <span class="token keyword">const</span> client <span class="token operator">=</span> <span class="token keyword">await</span> clients<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>clientId<span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>client<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span><br><br>      client<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>        action<span class="token operator">:</span> <span class="token string">"network_fail"</span><span class="token punctuation">,</span><br>        url<span class="token operator">:</span> event<span class="token punctuation">.</span>request<span class="token punctuation">.</span>url<span class="token punctuation">,</span><br>        destination<span class="token operator">:</span> <span class="token string">"products"</span><br>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>      <span class="token keyword">return</span> Response<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</web-copy-code><p>As a final step, the page needs to listen to the <code>message</code> event, and send out the analytics ping.
Again, make sure to buffer analytics requests that happen offline within the service worker. As
described before, initialize the <code>workbox-google-analytics</code> plugin for built-in Google Analytics
support.</p>
<p>The following example uses Google Analytics, but can be applied in the same way for other analytics
vendors.</p>
<web-copy-code><pre class="language-js"><code class="language-js"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"serviceWorker"</span> <span class="token keyword">in</span> navigator<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token comment">// ... SW registration here</span><br><br>  <span class="token comment">// track offline error events</span><br>  navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"message"</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>gtag <span class="token operator">&amp;&amp;</span> event<span class="token punctuation">.</span>data <span class="token operator">&amp;&amp;</span> event<span class="token punctuation">.</span>data<span class="token punctuation">.</span>action <span class="token operator">===</span> <span class="token string">"network_fail"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token function">gtag</span><span class="token punctuation">(</span><span class="token string">"event"</span><span class="token punctuation">,</span> <span class="token string">"network_fail"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><br>        event_category<span class="token operator">:</span> event<span class="token punctuation">.</span>data<span class="token punctuation">.</span>destination<span class="token punctuation">,</span><br>        <span class="token comment">// event_label: event.data.url,</span><br>        <span class="token comment">// value: event.data.value</span><br>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
</web-copy-code><p>This will track failed resource loads in Google Analytics, where they can be analyzed with
<a href="https://support.google.com/analytics/answer/1033068?hl=en" rel="noopener">reporting</a>. The derived insight can be
used to improve service worker caching and error handling in general, to make the page more robust
and reliable under unstable network conditions.</p>
<h2 id="next-steps">Next steps <a class="w-headline-link" href="#next-steps">#</a></h2>
<p>This article showed different ways of tracking offline usage with their advantages and shortcomings.
While this can help to quantify how many of your users go offline and run into problems due to it,
it's still just a start. As long as your website does not offer a well-built offline mode, you
obviously won't see much offline usage in analytics.</p>
<p>We recommend to get the full tracking in place, and then extend your offline capabilities in
iterations with an eye on tracking numbers. Start with a simple offline error page first–with
<a href="https://developers.google.com/web/tools/workbox/guides/advanced-recipes#offline_page_only" rel="noopener">Workbox it's trivial to
do</a>–and
should be considered a UX best practice similar to custom 404 pages anyway. Then work your way
<a href="https://developers.google.com/web/tools/workbox/guides/advanced-recipes#comprehensive_fallbacks" rel="noopener">towards more advanced offline fallbacks</a>
and finally towards real offline content. Make sure you advertise and explain this to your users
well, and you will see increasing usage. After all, everyone goes offline every once in a while.</p>
<p>Check out <a href="/how-to-report-metrics/">How to report metrics and build a performance culture</a>
and <a href="/fixing-website-speed-cross-functionally/">Fixing website speed cross-functionally</a> for tips
on persuading cross-functional stakeholders to invest more in your website. Although those posts
are focused on performance, they should help you get general ideas about how to engage
stakeholders.</p>
<p>Hero photo by <a href="https://unsplash.com/@jcgellidon?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener">JC Gellidon</a> on <a href="https://unsplash.com/s/photos/subway-people?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener">Unsplash</a>.</p>


    

    
  <div class="w-chips ">
    
      
    
      
    
      
        
        <a class="w-chip" href="/tags/offline/">Offline</a>
      
    
      
        
        <a class="w-chip" href="/tags/network/">Network</a>
      
    
      
        
        <a class="w-chip" href="/tags/service-worker/">Service Worker</a>
      
    
      
        
        <a class="w-chip" href="/tags/metrics/">Metrics</a>
      
    
  </div>


    <div class="w-post-github-link w-mt--l w-mb--l">
      <span class="w-mr--sm">
        
        Last updated: <time>Oct 28, 2020</time>
        
      </span>
      <a
        href="https://github.com/GoogleChrome/web.dev/blob/main/src/site/content/en/reliable/measuring-offline-usage/index.md"
      >
        Improve article
      </a>
       
    </div>

    
  </div>

  
    
    <nav class="w-article-navigation">
  <a
    class="w-article-navigation__link w-article-navigation__link--back
      w-article-navigation__link--single gc-analytics-event"
    data-category="web.dev"
    data-label="navigation, go back"
    data-action="click"
    href="/blog"
  >
    Return to all articles
  </a>
</nav>
  
</div>


  </div>
</main>
<footer class="w-footer">
  <nav class="w-footer__linkboxes">
    <ul class="w-footer__linkboxes-list">
      <li class="w-footer__linkbox">
        <h3 class="w-footer__linkbox-heading">Contribute</h3>
        <ul class="w-footer__linkbox-list">
          <li class="w-footer__linkbox-item">
            <a href="https://github.com/GoogleChrome/web.dev/issues/new?assignees=&labels=bug&template=bug_report.md&title="
              class="w-footer__linkbox-link" data-category="Site-Wide Custom Events" data-label="Footer Link (index 1)">
              File a bug
            </a>
          </li>
          <li class="w-footer__linkbox-item">
            <a href="https://github.com/googlechrome/web.dev" class="w-footer__linkbox-link"
              data-category="Site-Wide Custom Events" data-label="Footer Link (index 2)">
              View source
            </a>
          </li>
        </ul>
      </li>
      <li class="w-footer__linkbox">
        <h3 class="w-footer__linkbox-heading">Related content</h3>
        <ul class="w-footer__linkbox-list">
         <li class="w-footer__linkbox-item">
            <a href="https://developer.chrome.com/" class="w-footer__linkbox-link"
              data-category="Site-Wide Custom Events" data-label="Footer Link (index 1)">
              developer.chrome.com
            </a>
          </li>
          <li class="w-footer__linkbox-item">
            <a href="https://blog.chromium.org/" class="w-footer__linkbox-link"
              data-category="Site-Wide Custom Events" data-label="Footer Link (index 1)">
              Chrome updates
            </a>
          </li>
          <li class="w-footer__linkbox-item">
            <a href="https://developers.google.com/web/fundamentals" class="w-footer__linkbox-link"
              data-category="Site-Wide Custom Events" data-label="Footer Link (index 2)">
              Web Fundamentals
            </a>
          </li>
          <li class="w-footer__linkbox-item">
            <a href="https://developers.google.com/web/showcase/" class="w-footer__linkbox-link"
              data-category="Site-Wide Custom Events" data-label="Footer Link (index 3)">
              Case studies
            </a>
          </li>
          <li class="w-footer__linkbox-item">
            <a href="/podcasts/" class="w-footer__linkbox-link"
              data-category="Podcasts" data-label="Footer Link (index 5)">
              Podcasts
            </a>
          </li>
          <li class="w-footer__linkbox-item">
            <a href="/shows/" class="w-footer__linkbox-link"
              data-category="Shows" data-label="Footer Link (index 6)">
              Shows
            </a>
          </li>
        </ul>
      </li>
      <li class="w-footer__linkbox">
        <h3 class="w-footer__linkbox-heading">Connect</h3>
        <ul class="w-footer__linkbox-list">
          <li class="w-footer__linkbox-item">
            <a href="https://www.twitter.com/ChromiumDev" class="w-footer__linkbox-link"
              data-category="Site-Wide Custom Events" data-label="Footer Link (index 1)">
              Twitter
            </a>
          </li>
          <li class="w-footer__linkbox-item">
            <a href="https://www.youtube.com/user/ChromeDevelopers" class="w-footer__linkbox-link"
              data-category="Site-Wide Custom Events" data-label="Footer Link (index 2)">
              YouTube
            </a>
          </li>
        </ul>
      </li>
    </ul>
  </nav>

  <div class="w-footer__utility">
    <nav class="w-footer__utility-nav">
      <a href="https://developers.google.com/" class="w-footer__utility-logo-link"
        data-category="Site-Wide Custom Events" data-label="Footer Google Developers Link">
        <img loading="lazy" width="185" height="33" class="w-footer__utility-logo" src="/images/lockup-color.png"
          alt="Google Developers" />
      </a>
      <ul class="w-footer__utility-list">
        <li class="w-footer__utility-item">
          <a class="w-footer__utility-link" href="https://developer.chrome.com/"
            data-category="Site-Wide Custom Events" data-label="Footer Chrome Link">
            Chrome
          </a>
        </li>
        <li class="w-footer__utility-item">
          <a class="w-footer__utility-link" href="https://firebase.google.com/" data-category="Site-Wide Custom Events"
            data-label="Footer Firebase Link">
            Firebase
          </a>
        </li>
        <li class="w-footer__utility-item">
          <a class="w-footer__utility-link" href="https://cloud.google.com/" data-category="Site-Wide Custom Events"
            data-label="Footer Google Cloud Platform Link">
            Google Cloud Platform
          </a>
        </li>
        <li class="w-footer__utility-item">
          <a class="w-footer__utility-link" href="https://developers.google.com/products"
            data-category="Site-Wide Custom Events" data-label="Footer All products Link">
            All products
          </a>
        </li>
      </ul>
      <web-language-select current="en"></web-language-select>
    </nav>
    <nav class="w-footer__utility-nav">
      <ul class="w-footer__utility-list">
        <li class="w-footer__utility-item">
          <a class="w-footer__utility-link" href="https://policies.google.com/" data-category="Site-Wide Custom Events"
            data-label="Footer Terms and Privacy link">
            Terms &amp; Privacy
          </a>
        </li>
        <li class="w-footer__utility-item">
          <a class="w-footer__utility-link" href="/community-guidelines/" data-category="Site-Wide Custom Events"
            data-label="Footer Community Guidelines link">
            Community Guidelines
          </a>
        </li>
      </ul>
      <div class="w-footer__license">
        <p>
          Except as otherwise noted, the content of this page is licensed
          under the
          <a href="https://creativecommons.org/licenses/by/4.0/">
          Creative Commons Attribution 4.0 License</a>,
          and code samples are licensed under the
          <a href="https://www.apache.org/licenses/LICENSE-2.0">
          Apache 2.0 License</a>. For details, see the
          <a href="https://developers.google.com/terms/site-policies">
          Google Developers Site Policies</a>.
        </p>
      </div>
    </nav>
  </div>
</footer>

  </body>
</html>
