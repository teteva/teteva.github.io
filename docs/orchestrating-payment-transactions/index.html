
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">


  
    
    <link rel="stylesheet" href="/css/main.css?v=d2c8ea71282ec">
  

  <link rel="preload" as="font" crossorigin href="/fonts/material-icons/regular.woff2">


<link rel="preload" as="font" crossorigin href="/fonts/google-sans/regular/latin.woff2">
<link rel="preload" as="font" crossorigin href="/fonts/google-sans/bold/latin.woff2">

<meta name="theme-color" content="#fff"/>




<title>Orchestrating payment transactions with a service worker</title>
<meta name="description" content="Once a web-based payment app is registered, it's ready to accept payment requests from merchants. This article teaches you how to orchestrate a payment transaction from a service worker during runtime. " />

<link rel="canonical" href="https://web.dev/orchestrating-payment-transactions/" />

<meta itemprop="name" content="Orchestrating payment transactions with a service worker" />
<meta itemprop="description" content="Once a web-based payment app is registered, it's ready to accept payment requests from merchants. This article teaches you how to orchestrate a payment transaction from a service worker during runtime. " />
<meta itemprop="image" content="https://web-dev.imgix.net/image/tcFciHGuF3MxnTr1y5ue01OGLBn2/vU99HKzIf5EUPnzGVPf1.png?auto=format&fit=max&w=1200&fm=auto" />
<meta property="og:locale" content="en_US" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://web.dev/orchestrating-payment-transactions/" />
<meta property="og:site_name" content="web.dev" />
<meta property="og:title" content="Orchestrating payment transactions with a service worker" />
<meta property="og:description" content="Once a web-based payment app is registered, it's ready to accept payment requests from merchants. This article teaches you how to orchestrate a payment transaction from a service worker during runtime. " />
<meta property="og:image" content="https://web-dev.imgix.net/image/tcFciHGuF3MxnTr1y5ue01OGLBn2/vU99HKzIf5EUPnzGVPf1.png?auto=format&fit=max&w=1200&fm=auto" />
<meta property="og:image:alt" content="" />
<meta property="tag" content="payments" />
<meta property="tag" content="service-worker" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="Orchestrating payment transactions with a service worker" />
<meta name="twitter:description" content="Once a web-based payment app is registered, it's ready to accept payment requests from merchants. This article teaches you how to orchestrate a payment transaction from a service worker during runtime. " />
<meta name="twitter:image" content="https://web-dev.imgix.net/image/tcFciHGuF3MxnTr1y5ue01OGLBn2/vU99HKzIf5EUPnzGVPf1.png?auto=format&fit=max&w=1200&fm=auto" />
<link
  rel="alternate"
  href="/feed.xml"
  type="application/atom+xml"
  data-title="web.dev feed"
/>

<link rel="manifest" href="/manifest.webmanifest" />

<link rel="shortcut icon" href="/images/favicon.ico">
<link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
<link rel="mask-icon" color="#0054ff" href="/images/safari-pinned-tab.svg">



<script>
window.ga =
  window.ga ||
  function () {
    (ga.q = ga.q || []).push(arguments);
  };
ga.l = +new Date();
ga('create', 'UA-126406676-2');
ga('set', 'transport', 'beacon');
ga('set', 'anonymizeIp', true);
ga('set', 'page', window.location.pathname);
ga('set', 'dimension5', '4');
ga('send', 'pageview');
</script>







<script>
function loadScript(url, type) {
  const s = document.createElement('script');
  s.src = url;
  if (type) {
    s.type = type;
  }
  if (type === 'module') {
    s.async = false; // Preserve load order.
    const pre = document.createElement('link');
    pre.rel = 'modulepreload';
    pre.href = url;
    document.head.append(pre);
    // We use DOMContentLoaded as the loader script is running sync, and inserting a module script here doesn't defer. This brings back normal type="module" behavior.
    window.addEventListener('DOMContentLoaded', () => {
      document.head.append(s);
    });
  } else {
    document.head.append(s);
  }
}
loadScript('/js/app.js?v=74a51718f26d7', 'module');




  loadScript('/js/content.js?v=5d14fdf6f2a76', 'module');


  loadScript('https://www.google-analytics.com/analytics.js', null);

</script>

  </head>
  <body class="unresolved">
    
    <web-snackbar-container></web-snackbar-container>

    



<web-header class="header-default" role="navigation">
  <button data-open-drawer-button class="w-button--svg w-button--round" aria-label="Open menu">
    








  










  <svg class="icon " role="img" aria-label="menu" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" height="24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>


    <span class="w-tooltip w-tooltip--left">Open menu</span>
  </button>

  <a
    href="/"
    class="header-default__logo-link gc-analytics-event"
    data-category="Site-Wide Custom Events"
    data-label="Site logo"
  >
    <img class="header-default__logo" width="125" height="23" src="/images/lockup.svg" alt="web.dev" />
  </a>

  <div class="header-default__middle">
    <div class="header-default__links">
      <a
        href="/learn/"
        class="header-default__link gc-analytics-event"
        data-category="Site-Wide Custom Events"
        data-label="Tab: Learn"
      >
        Learn
      </a>

      <a
        href="/measure/"
        class="header-default__link gc-analytics-event"
        data-category="Site-Wide Custom Events"
        data-label="Tab: Measure"
      >
        Measure
      </a>

      <a
        href="/blog/"
        class="header-default__link gc-analytics-event"
        data-category="Site-Wide Custom Events"
        data-label="Tab: Blog"
      >
        Blog
      </a>

      <a
        href="/about/"
        class="header-default__link gc-analytics-event"
        data-category="Site-Wide Custom Events"
        data-label="Tab: About"
      >
        About
      </a>
    </div>
    <web-search results-id="search-main-results" i18n="{&quot;search&quot;:{&quot;en&quot;:&quot;Search&quot;},&quot;open_search&quot;:{&quot;en&quot;:&quot;Open search&quot;},&quot;all_articles&quot;:{&quot;en&quot;:&quot;All articles&quot;},&quot;close_search&quot;:{&quot;en&quot;:&quot;Close search&quot;}}"></web-search>
    <web-search-results id="search-main-results"></web-search-results>
  </div>

  <web-profile-switcher-container></web-profile-switcher-container>
</web-header>



<web-navigation-drawer class="drawer-default" type="modal">
  <nav data-drawer-container>
    <div class="drawer-default__contents">
      <div class="drawer-default__header">
        <button
          data-drawer-close-button
          class="drawer-default__hide w-button--svg w-button--round"
          aria-label="Close"
        >
          








  










  <svg class="icon " role="img" aria-label="close" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" height="24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>


          <span class="w-tooltip">Close</span>
        </button>
        <a
          href="/"
          class="gc-analytics-event"
          data-category="Site-Wide Custom Events"
          data-label="Site logo"
        >
          <img
            width="125"
            height="30"
            class="drawer-default__logo"
            src="/images/lockup.svg"
            alt="web.dev"
          />
        </a>
      </div>
      <a
        href="/learn/"
        class="drawer-default__link gc-analytics-event"
        data-category="Site-Wide Custom Events"
        data-label="SideNav: Learn"
      >
        Learn
      </a>
      <a
        href="/measure/"
        class="drawer-default__link gc-analytics-event"
        data-category="Site-Wide Custom Events"
        data-label="SideNav: Measure"
      >
        Measure
      </a>
      <a
        href="/blog/"
        class="drawer-default__link gc-analytics-event"
        data-category="Site-Wide Custom Events"
        data-label="SideNav: Blog"
      >
        Blog
      </a>
      <a
        href="/about/"
        class="drawer-default__link gc-analytics-event"
        data-category="Site-Wide Custom Events"
        data-label="SideNav: About"
      >
        About
      </a>
    </div>
  </nav>
</web-navigation-drawer>

<main>
  <div id="content">
    
      
    
    


<div class="guide-landing-page">
  
    
    
    
  
  

  

  <web-table-of-contents>
    <h2 class="w-toc__header">
      <a href="#orchestrating-payment-transactions-with-a-service-worker" class="w-toc__header--link">
        Orchestrating payment transactions with a service worker
      </a>
    </h2>
    <div class="w-toc__list">
        <ul><li><a href="#receive-payment-request-event">Receive a payment request event from the merchant</a></li><li><a href="#open-payment-handler-window">Open the payment handler window to display the web-based payment app frontend</a></li><li><a href="#exchange-information">Exchange information with the frontend</a><ol><li><a href="#receive-ready-signal">Receive the ready signal from the frontend</a></li><li><a href="#pass-details">Pass the transaction details to the frontend</a></li></ol></li><li><a href="#return-credentials">Return the customer's payment credentials</a></li><li><a href="#cancel-transaction">Cancel the payment transaction</a></li><li><a href="#sample-code">Sample code</a></li><li><a href="#next-steps">Next steps</a></li></ul></div>
  </web-table-of-contents>
  <web-table-of-contents-button></web-table-of-contents-button>

  
  <div class="w-actions">
    <share-action authors="@agektmr"
      class="gc-analytics-event w-actions__fab w-actions__fab--share"
      data-category="web.dev"
      data-label="share"
      data-action="click"
      data-icon="share"
      tabindex="0"
      role="button"
    >
      <span>Share</span>
    </share-action>
    
    
  </div>

  <div class="w-layout-container--narrow w-post-content">
    <header class="w-article-header">
      

      <h1 id="orchestrating-payment-transactions-with-a-service-worker" class="w-article-header__headline">Orchestrating payment transactions with a service worker</h1>
      
        <p class="w-article-header__subhead w-mb--non">
          <p>How to adapt your web-based payment app to Web Payments and provide a better user experience for customers.</p>

        </p>
      

      
        <div class="w-author__published">
          <time>Aug 31, 2020</time>
           <span class="w-author__separator">•</span> Updated <time>Sep 14, 2021</time> 
        </div>
      

      
      

      <div class="w-layout-container--narrow w-post-signpost">
  <span class="w-post-signpost__title">
    Appears in:
  </span>
  <a
          class="w-post-signpost__link"
          href="/payments"
          >Web Payments</a
        >
</div>

      
        <div class="w-authors w-mt--xl w-pt--sm">
          
            <div class="w-author">
  <a href="/authors/agektmr/"><img     alt="Eiji Kitamura"     class="w-author__image"     decoding="async"     height="64"          loading="lazy"     sizes="(min-width: 64px) 64px, calc(100vw - 48px)"     src="https://web-dev.imgix.net/image/admin/Mh9DRmQhjlroJM9JDqsu.jpg?auto=format&fit=crop&h=64&w=64"     srcset="https://web-dev.imgix.net/image/admin/Mh9DRmQhjlroJM9JDqsu.jpg?fit=crop&h=64&w=64&auto=format&dpr=1&q=75 1x,     https://web-dev.imgix.net/image/admin/Mh9DRmQhjlroJM9JDqsu.jpg?fit=crop&h=64&w=64&auto=format&dpr=2&q=50 2x,     https://web-dev.imgix.net/image/admin/Mh9DRmQhjlroJM9JDqsu.jpg?fit=crop&h=64&w=64&auto=format&dpr=3&q=35 3x,     https://web-dev.imgix.net/image/admin/Mh9DRmQhjlroJM9JDqsu.jpg?fit=crop&h=64&w=64&auto=format&dpr=4&q=23 4x,     https://web-dev.imgix.net/image/admin/Mh9DRmQhjlroJM9JDqsu.jpg?fit=crop&h=64&w=64&auto=format&dpr=5&q=20 5x"          width="64"   /></a>
  <div
    class="w-author__info"
    style="display: flex; flex-direction: column; justify-content: center;"
  >
    <cite class="w-author__name">
      <a class="w-author__name-link" href="/authors/agektmr/">Eiji Kitamura</a>
    </cite>
    <ul class="w-author__link-list">
      <li class="w-author__link-listitem">
        <a class="w-author__link" href="https://twitter.com/agektmr"
          >Twitter</a
        >
      </li>
      <li class="w-author__link-listitem">
        <a class="w-author__link" href="https://github.com/agektmr">GitHub</a>
      </li>
      
      <li class="w-author__link-listitem">
        <a class="w-author__link" href="https://blog.agektmr.com">Blog</a>
      </li>
    </ul>
  </div>
</div>
          
        </div>
      
    </header>

    

    <p>Once <a href="/registering-a-web-based-payment-app/">the payment app is registered</a>, you
are ready to accept payment requests from merchants. This post explains how to
orchestrate a payment transaction from a service worker during runtime (i.e.
when a window is displayed and the user is interacting with it).</p>
<figure class="w-figure">
  <img     alt="Orchestrating payment transactions with a service worker"     class="w-screenshot"     decoding="async"     height="945"          loading="lazy"     sizes="(min-width: 800px) 800px, calc(100vw - 48px)"     src="https://web-dev.imgix.net/image/tcFciHGuF3MxnTr1y5ue01OGLBn2/b0Pz24lmWMepSM6tboa1.png?auto=format"     srcset="https://web-dev.imgix.net/image/tcFciHGuF3MxnTr1y5ue01OGLBn2/b0Pz24lmWMepSM6tboa1.png?auto=format&w=200 200w,     https://web-dev.imgix.net/image/tcFciHGuF3MxnTr1y5ue01OGLBn2/b0Pz24lmWMepSM6tboa1.png?auto=format&w=228 228w,     https://web-dev.imgix.net/image/tcFciHGuF3MxnTr1y5ue01OGLBn2/b0Pz24lmWMepSM6tboa1.png?auto=format&w=260 260w,     https://web-dev.imgix.net/image/tcFciHGuF3MxnTr1y5ue01OGLBn2/b0Pz24lmWMepSM6tboa1.png?auto=format&w=296 296w,     https://web-dev.imgix.net/image/tcFciHGuF3MxnTr1y5ue01OGLBn2/b0Pz24lmWMepSM6tboa1.png?auto=format&w=338 338w,     https://web-dev.imgix.net/image/tcFciHGuF3MxnTr1y5ue01OGLBn2/b0Pz24lmWMepSM6tboa1.png?auto=format&w=385 385w,     https://web-dev.imgix.net/image/tcFciHGuF3MxnTr1y5ue01OGLBn2/b0Pz24lmWMepSM6tboa1.png?auto=format&w=439 439w,     https://web-dev.imgix.net/image/tcFciHGuF3MxnTr1y5ue01OGLBn2/b0Pz24lmWMepSM6tboa1.png?auto=format&w=500 500w,     https://web-dev.imgix.net/image/tcFciHGuF3MxnTr1y5ue01OGLBn2/b0Pz24lmWMepSM6tboa1.png?auto=format&w=571 571w,     https://web-dev.imgix.net/image/tcFciHGuF3MxnTr1y5ue01OGLBn2/b0Pz24lmWMepSM6tboa1.png?auto=format&w=650 650w,     https://web-dev.imgix.net/image/tcFciHGuF3MxnTr1y5ue01OGLBn2/b0Pz24lmWMepSM6tboa1.png?auto=format&w=741 741w,     https://web-dev.imgix.net/image/tcFciHGuF3MxnTr1y5ue01OGLBn2/b0Pz24lmWMepSM6tboa1.png?auto=format&w=845 845w,     https://web-dev.imgix.net/image/tcFciHGuF3MxnTr1y5ue01OGLBn2/b0Pz24lmWMepSM6tboa1.png?auto=format&w=964 964w,     https://web-dev.imgix.net/image/tcFciHGuF3MxnTr1y5ue01OGLBn2/b0Pz24lmWMepSM6tboa1.png?auto=format&w=1098 1098w,     https://web-dev.imgix.net/image/tcFciHGuF3MxnTr1y5ue01OGLBn2/b0Pz24lmWMepSM6tboa1.png?auto=format&w=1252 1252w,     https://web-dev.imgix.net/image/tcFciHGuF3MxnTr1y5ue01OGLBn2/b0Pz24lmWMepSM6tboa1.png?auto=format&w=1428 1428w,     https://web-dev.imgix.net/image/tcFciHGuF3MxnTr1y5ue01OGLBn2/b0Pz24lmWMepSM6tboa1.png?auto=format&w=1600 1600w"          width="800"   />
  <figcaption class="w-figcaption">
    Orchestrating payment transactions with a service worker
  </figcaption>
</figure>
<p>&quot;Runtime payment parameter changes&quot; refer to a set of events that allows the
merchant and payment handler to exchange messages while the user is interacting
with the payment handler. Learn more in <a href="/handling-optional-payment-information">Handling optional payment information
with a service worker</a>.</p>
<h2 id="receive-payment-request-event">Receive a payment request event from the merchant <a class="w-headline-link" href="#receive-payment-request-event">#</a></h2>
<p>When a customer chooses to pay with your web-based payment app and <a href="/life-of-a-payment-transaction/#">the merchant
invokes
<code>PaymentRequest.show()</code></a>,
your service worker will receive a <code>paymentrequest</code> event. Add an event listener
to the service worker to capture the event and prepare for the next action.</p>
<p class="w-label"> [payment handler] service-worker.js: </p>
<web-copy-code><pre class="language-js"><code class="language-js">…<br><span class="token keyword">let</span> payment_request_event<span class="token punctuation">;</span><br><span class="token keyword">let</span> resolver<span class="token punctuation">;</span><br><span class="token keyword">let</span> client<span class="token punctuation">;</span><br><br><span class="token comment">// `self` is the global object in service worker</span><br>self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'paymentrequest'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token parameter">e</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>payment_request_event<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">// If there's an ongoing payment transaction, reject it.</span><br>    resolver<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br>  <span class="token comment">// Preserve the event for future use</span><br>  payment_request_event <span class="token operator">=</span> e<span class="token punctuation">;</span><br>…</code></pre>
</web-copy-code><div class="w-aside w-aside--caution">
<p><strong>Caution</strong>:
Remember that a service worker is a single instance across different tabs and
windows in the same browser. Global variables are shared across all tabs and
windows.</p>
</div>
<p>The preserved <code>PaymentRequestEvent</code> contains important information about this
transaction:</p>
<div class="w-table-wrapper">
  <table>
    <thead>
      <tr>
        <th>Property name</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
      <tr>
      <td><code>topOrigin</code></td>
        <td>
          A string that indicates the origin of the top-level web page (usually the payee merchant). Use this to identify the merchant origin.
        </td>
      </tr>
      <tr>
        <td><code>paymentRequestOrigin</code></td>
        <td>
          A string that indicates the origin of the invoker. This can be the same as <code>topOrigin</code> when the merchant invokes the Payment Request API directly, but may be different if the API is invoked from within an iframe by a third party such as a payment gateway.
        </td>
      </tr>
      <tr>
        <td><code>paymentRequestId</code></td>
        <td>
          The <code>id</code> property of the <code><a href="https://w3c.github.io/payment-request/#paymentdetailsinit-dictionary">PaymentDetailsInit</a></code> provided to the Payment Request API. If the merchant omits, the browser will provide an auto-generated ID.
        </td>
      </tr>
      <tr>
        <td><code>methodData</code></td>
        <td>
          The payment-method-specific data provided by the merchant as part of <code><a href="https://w3c.github.io/payment-request/#dom-paymentmethoddata">PaymentMethodData</a></code>.
Use this to determine the payment transaction details.
        </td>
      </tr>
      <tr>
        <td><code>total</code></td>
        <td>
          The total amount provided by the merchant as part of <code><a href="https://w3c.github.io/payment-request/#dom-paymentdetailsinit">PaymentDetailsInit</a></code>.
Use this to construct a UI to let the customer know the total amount to pay.
        </td>
      </tr>
      <tr>
        <td><code>instrumentKey</code></td>
        <td>
          The instrument key selected by the user. This reflects the <code><a href="https://w3c.github.io/payment-handler/#paymentinstruments-interface">instrumentKey</a></code> you provided in advance. An empty string indicates that the user did not specify any instruments.
        </td>
      </tr>
    </tbody>
  </table>
</div>
<h2 id="open-payment-handler-window">Open the payment handler window to display the web-based payment app frontend <a class="w-headline-link" href="#open-payment-handler-window">#</a></h2>
<p>When a <code>paymentrequest</code> event is received, the payment app can open a payment
handler window by calling <code>PaymentRequestEvent.openWindow()</code>. The payment
handler window will present the customers your payment app's interface where
they can authenticate, choose shipping address and options, and authorize the
payment. We'll cover how to write the frontend code in <em>Handling payments on the
payment frontend</em> (coming soon).</p>
<figure class="w-figure" style="width:300px; margin:auto;">
  <video controls autoplay loop muted class="w-screenshot">
    <source src="https://storage.googleapis.com/web-dev-assets/payments/web-based-payment-app.webm" type="video/webm">
    <source src="https://storage.googleapis.com/web-dev-assets/payments/web-based-payment-app.mp4" type="video/mp4">
  </video>
  <figcaption class="w-figcaption">
    Checkout flow with a web-based payment app.
  </figcaption>
</figure>
<p>Pass a preserved promise to <code>PaymentRequestEvent.respondWith()</code> so that you can
resolve it with a payment result in the future.</p>
<p class="w-label"> [payment handler] service-worker.js: </p>
<web-copy-code><pre class="language-js"><code class="language-js">…<br>self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'paymentrequest'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token parameter">e</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>…<br>  <span class="token comment">// Retain a promise for future resolution</span><br>  <span class="token comment">// Polyfill for PromiseResolver is provided below.</span><br>  resolver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PromiseResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token comment">// Pass a promise that resolves when payment is done.</span><br>  e<span class="token punctuation">.</span><span class="token function">respondWith</span><span class="token punctuation">(</span>resolver<span class="token punctuation">.</span>promise<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token comment">// Open the checkout page.</span><br>  <span class="token keyword">try</span> <span class="token punctuation">{</span><br>    <span class="token comment">// Open the window and preserve the client</span><br>    client <span class="token operator">=</span> <span class="token keyword">await</span> e<span class="token punctuation">.</span><span class="token function">openWindow</span><span class="token punctuation">(</span>checkoutURL<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>client<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token comment">// Reject if the window fails to open</span><br>      <span class="token keyword">throw</span> <span class="token string">'Failed to open window'</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">// Reject the promise on failure</span><br>    resolver<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>…</code></pre>
</web-copy-code><div class="w-aside w-aside--note">
<p>Use a convenient <code>PromiseResolver</code> polyfill to resolve a promise at arbitrary timing.</p>
<web-copy-code><pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">PromiseResolver</span> <span class="token punctuation">{</span><br>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span>promise_ <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>      <span class="token keyword">this</span><span class="token punctuation">.</span>resolve_ <span class="token operator">=</span> resolve<span class="token punctuation">;</span><br>      <span class="token keyword">this</span><span class="token punctuation">.</span>reject_ <span class="token operator">=</span> reject<span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><br>  <span class="token punctuation">}</span><br>  <span class="token keyword">get</span> <span class="token function">promise</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>promise_ <span class="token punctuation">}</span><br>  <span class="token keyword">get</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>resolve_ <span class="token punctuation">}</span><br>  <span class="token keyword">get</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>reject_ <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
</web-copy-code></div>
<div class="w-aside w-aside--note">
<p>For security reasons, the frontend page opened in the payment handler window
must have valid HTTPS certificates and no <a href="https://developers.google.com/web/fundamentals/security/prevent-mixed-content/what-is-mixed-content" rel="noopener">mixed
content</a>;
otherwise the payment request will be cancelled by Chrome. Learn more at
<a href="/registering-a-web-based-payment-app/#debugging-a-web-based-payment-app">Debugging a web-based payment
app</a>.</p>
</div>
<h2 id="exchange-information">Exchange information with the frontend <a class="w-headline-link" href="#exchange-information">#</a></h2>
<p>The payment app's service worker can exchange messages with the payment app's
frontend through <code>ServiceWorkerController.postMessage()</code>. To receive messages
from the frontend, listen to <code>message</code> events.</p>
<p class="w-label"> [payment handler] service-worker.js: </p>
<web-copy-code><pre class="language-js"><code class="language-js"><span class="token comment">// Define a convenient `postMessage()` method</span><br><span class="token keyword">const</span> <span class="token function-variable function">postMessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> contents <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>client<span class="token punctuation">)</span> client<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">,</span> <span class="token operator">...</span>contents <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
</web-copy-code><h3 id="receive-ready-signal">Receive the ready signal from the frontend <a class="w-headline-link" href="#receive-ready-signal">#</a></h3>
<p>Once the payment handler window is opened, the service worker should wait for a
ready-state signal from the payment app frontend. The service worker can pass
important information to the frontend when it is ready.</p>
<p class="w-label"> [payment handler] frontend: </p>
<web-copy-code><pre class="language-js"><code class="language-js">navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span>controller<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>  type<span class="token operator">:</span> <span class="token string">'WINDOW_IS_READY'</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</web-copy-code><p class="w-label"> [payment handler] service-worker.js: </p>
<web-copy-code><pre class="language-js"><code class="language-js">…<br><span class="token comment">// Received a message from the frontend</span><br>self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token parameter">e</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">let</span> details<span class="token punctuation">;</span><br>  <span class="token keyword">try</span> <span class="token punctuation">{</span><br>    <span class="token keyword">switch</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>data<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token comment">// `WINDOW_IS_READY` is a frontend's ready state signal</span><br>      <span class="token keyword">case</span> <span class="token string">'WINDOW_IS_READY'</span><span class="token operator">:</span><br>        <span class="token keyword">const</span> <span class="token punctuation">{</span> total <span class="token punctuation">}</span> <span class="token operator">=</span> payment_request_event<span class="token punctuation">;</span><br>…</code></pre>
</web-copy-code><h3 id="pass-details">Pass the transaction details to the frontend <a class="w-headline-link" href="#pass-details">#</a></h3>
<p>Now send the payment details back. In this case you're only sending the total of
the payment request, but you can pass more details if you like.</p>
<p class="w-label"> [payment handler] service-worker.js: </p>
<web-copy-code><pre class="language-js"><code class="language-js">…<br>        <span class="token comment">// Pass the payment details to the frontend</span><br>        <span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'PAYMENT_IS_READY'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> total <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">break</span><span class="token punctuation">;</span><br>…</code></pre>
</web-copy-code><p class="w-label"> [payment handler] frontend: </p>
<web-copy-code><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> total<span class="token punctuation">;</span><br><br>navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token parameter">e</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">switch</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>data<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token keyword">case</span> <span class="token string">'PAYMENT_IS_READY'</span><span class="token operator">:</span><br>        <span class="token punctuation">(</span><span class="token punctuation">{</span> total <span class="token punctuation">}</span> <span class="token operator">=</span> e<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token comment">// Update the UI</span><br>        <span class="token function">renderHTML</span><span class="token punctuation">(</span>total<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">break</span><span class="token punctuation">;</span><br>…</code></pre>
</web-copy-code><h2 id="return-credentials">Return the customer's payment credentials <a class="w-headline-link" href="#return-credentials">#</a></h2>
<p>When the customer authorizes the payment, the frontend can send a post message
to the service worker to proceed. You can resolve the promise passed to
<code>PaymentRequestEvent.respondWith()</code> to send the result back to the merchant.
Pass a
<a href="https://w3c.github.io/payment-handler/#dom-paymenthandlerresponse" rel="noopener"><code>PaymentHandlerResponse</code></a>
object.</p>
<div class="w-table-wrapper">
  <table>
    <thead>
      <tr>
        <th>Property name</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
      <tr>
      <td><code>methodName</code></td>
        <td>
          The payment method identifier used to make payment.
        </td>
      </tr>
      <tr>
        <td><code>details</code></td>
        <td>
          The payment method specific data that provides necessary information for the merchant to process payment.
        </td>
      </tr>
    </tbody>
  </table>
</div>
<p class="w-label"> [payment handler] frontend: </p>
<web-copy-code><pre class="language-js"><code class="language-js">  <span class="token keyword">const</span> paymentMethod <span class="token operator">=</span> …<br><br>  <span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'PAYMENT_AUTHORIZED'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><br>    paymentMethod<span class="token punctuation">,</span>              <span class="token comment">// Payment method identifier</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</web-copy-code><p class="w-label"> [payment handler] service-worker.js: </p>
<web-copy-code><pre class="language-js"><code class="language-js">…<br><span class="token comment">// Received a message from the frontend</span><br>self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token parameter">e</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">let</span> details<span class="token punctuation">;</span><br>  <span class="token keyword">try</span> <span class="token punctuation">{</span><br>    <span class="token keyword">switch</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>data<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      …<br>      <span class="token keyword">case</span> <span class="token string">'PAYMENT_AUTHORIZED'</span><span class="token operator">:</span><br>        <span class="token comment">// Resolve the payment request event promise</span><br>        <span class="token comment">// with a payment response object</span><br>        <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token punctuation">{</span><br>          methodName<span class="token operator">:</span> e<span class="token punctuation">.</span>data<span class="token punctuation">.</span>paymentMethod<span class="token punctuation">,</span><br>          details<span class="token operator">:</span> <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token string">'put payment credential here'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>        <span class="token punctuation">}</span><br>        resolver<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token comment">// Don't forget to initialize.</span><br>        payment_request_event <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><br>        <span class="token keyword">break</span><span class="token punctuation">;</span><br>      …</code></pre>
</web-copy-code><h2 id="cancel-transaction">Cancel the payment transaction <a class="w-headline-link" href="#cancel-transaction">#</a></h2>
<p>To allow the customer to cancel the transaction, the frontend can send a post
message to the service worker to do so. The service worker can then resolve the
promise passed to <code>PaymentRequestEvent.respondWith()</code> with <code>null</code> to indicate to
the merchant that the transaction has been cancelled.</p>
<p class="w-label"> [payment handler] frontend: </p>
<web-copy-code><pre class="language-js"><code class="language-js">  <span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'CANCEL_PAYMENT'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</web-copy-code><p class="w-label"> [payment handler] service-worker.js: </p>
<web-copy-code><pre class="language-js"><code class="language-js">…<br><span class="token comment">// Received a message from the frontend</span><br>self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token parameter">e</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">let</span> details<span class="token punctuation">;</span><br>  <span class="token keyword">try</span> <span class="token punctuation">{</span><br>    <span class="token keyword">switch</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>data<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      …<br>      <span class="token keyword">case</span> <span class="token string">'CANCEL_PAYMENT'</span><span class="token operator">:</span><br>        <span class="token comment">// Resolve the payment request event promise</span><br>        <span class="token comment">// with null</span><br>        resolver<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token comment">// Don't forget to initialize.</span><br>        payment_request_event <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><br>        <span class="token keyword">break</span><span class="token punctuation">;</span><br>      …</code></pre>
</web-copy-code><h2 id="sample-code">Sample code <a class="w-headline-link" href="#sample-code">#</a></h2>
<p>All sample codes you saw in this document were excerpts from the following
working sample app:</p>
<p><a href="https://paymenthandler-demo.glitch.me" rel="noopener">https://paymenthandler-demo.glitch.me</a></p>
<p class="w-label"> [payment handler] service worker </p>
<div class="glitch-embed-wrap" style="height: 420px; width: 100%;">
  <iframe
    allow="camera; clipboard-read; clipboard-write; encrypted-media; geolocation; microphone; midi"
    loading="lazy"
    src="https://glitch.com/embed/#!/embed/paymenthandler-demo?attributionHidden=true&sidebarCollapsed=true&path=public%2Fservice-worker.js&previewSize=0"
    style="height: 100%; width: 100%; border: 0;"
    title="paymenthandler-demo on Glitch"
  ></iframe>
</div>
<p class="w-label"> [payment handler] frontend </p>
<div class="glitch-embed-wrap" style="height: 420px; width: 100%;">
  <iframe
    allow="camera; clipboard-read; clipboard-write; encrypted-media; geolocation; microphone; midi"
    loading="lazy"
    src="https://glitch.com/embed/#!/embed/paymenthandler-demo?attributionHidden=true&sidebarCollapsed=true&path=public%2Fpay.js&previewSize=0"
    style="height: 100%; width: 100%; border: 0;"
    title="paymenthandler-demo on Glitch"
  ></iframe>
</div>
<p>To try it out:</p>
<ol>
<li>Go to <a href="https://paymentrequest-demo.glitch.me/" rel="noopener">https://paymentrequest-demo.glitch.me/</a>.</li>
<li>Go to the bottom of the page.</li>
<li>Press <strong>Add a payment button</strong>.</li>
<li>Enter <code>https://paymenthandler-demo.glitch.me</code> to the <strong>Payment Method Identifier</strong> field.</li>
<li>Press <strong>Pay</strong> button next to the field.</li>
</ol>
<h2 id="next-steps">Next steps <a class="w-headline-link" href="#next-steps">#</a></h2>
<p>In this article, we learned how to orchestrate a payment transaction from a
service worker. The next step is to learn how to add some more advanced features
to the service worker.</p>
<ul>
<li><a href="/handling-optional-payment-information">Handling optional payment information with a service worker</a></li>
</ul>


    

    
  <div class="w-chips ">
    
      
    
      
        
        <a class="w-chip" href="/tags/payments/">Payments</a>
      
    
      
        
        <a class="w-chip" href="/tags/service-worker/">Service Worker</a>
      
    
  </div>


    <div class="w-post-github-link w-mt--l w-mb--l">
      <span class="w-mr--sm">
        
        Last updated: <time>Sep 14, 2021</time>
        
      </span>
      <a
        href="https://github.com/GoogleChrome/web.dev/blob/main/src/site/content/en/payments/orchestrating-payment-transactions/index.md"
      >
        Improve article
      </a>
       
    </div>

    
  </div>

  
    
    <nav class="w-article-navigation">
  <a
    class="w-article-navigation__link w-article-navigation__link--back
      w-article-navigation__link--single gc-analytics-event"
    data-category="web.dev"
    data-label="navigation, go back"
    data-action="click"
    href="/payments"
  >
    Return to all articles
  </a>
</nav>
  
</div>


  </div>
</main>
<footer class="w-footer">
  <nav class="w-footer__linkboxes">
    <ul class="w-footer__linkboxes-list">
      <li class="w-footer__linkbox">
        <h3 class="w-footer__linkbox-heading">Contribute</h3>
        <ul class="w-footer__linkbox-list">
          <li class="w-footer__linkbox-item">
            <a href="https://github.com/GoogleChrome/web.dev/issues/new?assignees=&labels=bug&template=bug_report.md&title="
              class="w-footer__linkbox-link" data-category="Site-Wide Custom Events" data-label="Footer Link (index 1)">
              File a bug
            </a>
          </li>
          <li class="w-footer__linkbox-item">
            <a href="https://github.com/googlechrome/web.dev" class="w-footer__linkbox-link"
              data-category="Site-Wide Custom Events" data-label="Footer Link (index 2)">
              View source
            </a>
          </li>
        </ul>
      </li>
      <li class="w-footer__linkbox">
        <h3 class="w-footer__linkbox-heading">Related content</h3>
        <ul class="w-footer__linkbox-list">
         <li class="w-footer__linkbox-item">
            <a href="https://developer.chrome.com/" class="w-footer__linkbox-link"
              data-category="Site-Wide Custom Events" data-label="Footer Link (index 1)">
              developer.chrome.com
            </a>
          </li>
          <li class="w-footer__linkbox-item">
            <a href="https://blog.chromium.org/" class="w-footer__linkbox-link"
              data-category="Site-Wide Custom Events" data-label="Footer Link (index 1)">
              Chrome updates
            </a>
          </li>
          <li class="w-footer__linkbox-item">
            <a href="https://developers.google.com/web/fundamentals" class="w-footer__linkbox-link"
              data-category="Site-Wide Custom Events" data-label="Footer Link (index 2)">
              Web Fundamentals
            </a>
          </li>
          <li class="w-footer__linkbox-item">
            <a href="https://developers.google.com/web/showcase/" class="w-footer__linkbox-link"
              data-category="Site-Wide Custom Events" data-label="Footer Link (index 3)">
              Case studies
            </a>
          </li>
          <li class="w-footer__linkbox-item">
            <a href="/podcasts/" class="w-footer__linkbox-link"
              data-category="Podcasts" data-label="Footer Link (index 5)">
              Podcasts
            </a>
          </li>
          <li class="w-footer__linkbox-item">
            <a href="/shows/" class="w-footer__linkbox-link"
              data-category="Shows" data-label="Footer Link (index 6)">
              Shows
            </a>
          </li>
        </ul>
      </li>
      <li class="w-footer__linkbox">
        <h3 class="w-footer__linkbox-heading">Connect</h3>
        <ul class="w-footer__linkbox-list">
          <li class="w-footer__linkbox-item">
            <a href="https://www.twitter.com/ChromiumDev" class="w-footer__linkbox-link"
              data-category="Site-Wide Custom Events" data-label="Footer Link (index 1)">
              Twitter
            </a>
          </li>
          <li class="w-footer__linkbox-item">
            <a href="https://www.youtube.com/user/ChromeDevelopers" class="w-footer__linkbox-link"
              data-category="Site-Wide Custom Events" data-label="Footer Link (index 2)">
              YouTube
            </a>
          </li>
        </ul>
      </li>
    </ul>
  </nav>

  <div class="w-footer__utility">
    <nav class="w-footer__utility-nav">
      <a href="https://developers.google.com/" class="w-footer__utility-logo-link"
        data-category="Site-Wide Custom Events" data-label="Footer Google Developers Link">
        <img loading="lazy" width="185" height="33" class="w-footer__utility-logo" src="/images/lockup-color.png"
          alt="Google Developers" />
      </a>
      <ul class="w-footer__utility-list">
        <li class="w-footer__utility-item">
          <a class="w-footer__utility-link" href="https://developer.chrome.com/"
            data-category="Site-Wide Custom Events" data-label="Footer Chrome Link">
            Chrome
          </a>
        </li>
        <li class="w-footer__utility-item">
          <a class="w-footer__utility-link" href="https://firebase.google.com/" data-category="Site-Wide Custom Events"
            data-label="Footer Firebase Link">
            Firebase
          </a>
        </li>
        <li class="w-footer__utility-item">
          <a class="w-footer__utility-link" href="https://cloud.google.com/" data-category="Site-Wide Custom Events"
            data-label="Footer Google Cloud Platform Link">
            Google Cloud Platform
          </a>
        </li>
        <li class="w-footer__utility-item">
          <a class="w-footer__utility-link" href="https://developers.google.com/products"
            data-category="Site-Wide Custom Events" data-label="Footer All products Link">
            All products
          </a>
        </li>
      </ul>
      <web-language-select current="en"></web-language-select>
    </nav>
    <nav class="w-footer__utility-nav">
      <ul class="w-footer__utility-list">
        <li class="w-footer__utility-item">
          <a class="w-footer__utility-link" href="https://policies.google.com/" data-category="Site-Wide Custom Events"
            data-label="Footer Terms and Privacy link">
            Terms &amp; Privacy
          </a>
        </li>
        <li class="w-footer__utility-item">
          <a class="w-footer__utility-link" href="/community-guidelines/" data-category="Site-Wide Custom Events"
            data-label="Footer Community Guidelines link">
            Community Guidelines
          </a>
        </li>
      </ul>
      <div class="w-footer__license">
        <p>
          Except as otherwise noted, the content of this page is licensed
          under the
          <a href="https://creativecommons.org/licenses/by/4.0/">
          Creative Commons Attribution 4.0 License</a>,
          and code samples are licensed under the
          <a href="https://www.apache.org/licenses/LICENSE-2.0">
          Apache 2.0 License</a>. For details, see the
          <a href="https://developers.google.com/terms/site-policies">
          Google Developers Site Policies</a>.
        </p>
      </div>
    </nav>
  </div>
</footer>

  </body>
</html>
