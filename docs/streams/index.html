
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">


  
<script>
  // A global function that the theme toggle can use to apply the current theme.
  window.applyThemeSetting = function(override) {
    const currentSetting = override || localStorage.getItem('user-color-scheme');
    const currentAttribute = document.documentElement.getAttribute('data-user-theme');

    if (currentSetting && currentSetting !== currentAttribute) {
      document.documentElement.setAttribute('data-user-theme', currentSetting);
    }
  };
window.applyThemeSetting();
</script>

  
  <link rel="stylesheet" href="/css/next.css?v=d5c2aa039fbed">
  <link rel="stylesheet" href="/css/legacy-rollout.css?v=b486a7d69ee8a">
  <link rel="preload" as="font" crossorigin href="/fonts/material-icons/regular.woff2">


<link rel="preload" as="font" crossorigin href="/fonts/google-sans/regular/latin.woff2">
<link rel="preload" as="font" crossorigin href="/fonts/google-sans/bold/latin.woff2">

<meta name="theme-color" content="#fff"/>




<title>Streams—The definitive guide</title>
<meta name="description" content="The Streams API allows JavaScript to programmatically access streams of data received over the network and process them as desired. " />

<link rel="canonical" href="https://web.dev/streams/" />

<meta itemprop="name" content="Streams—The definitive guide" />
<meta itemprop="description" content="The Streams API allows JavaScript to programmatically access streams of data received over the network and process them as desired. " />
<meta itemprop="image" content="https://web-dev.imgix.net/image/8WbTDNrhLsU0El80frMBGE4eMCD3/TuciUuOQOd3u7uMgDZBi.jpg?auto=format&fit=max&w=1200&fm=auto" />
<meta property="og:locale" content="en_US" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://web.dev/streams/" />
<meta property="og:site_name" content="web.dev" />
<meta property="og:title" content="Streams—The definitive guide" />
<meta property="og:description" content="The Streams API allows JavaScript to programmatically access streams of data received over the network and process them as desired. " />
<meta property="og:image" content="https://web-dev.imgix.net/image/8WbTDNrhLsU0El80frMBGE4eMCD3/TuciUuOQOd3u7uMgDZBi.jpg?auto=format&fit=max&w=1200&fm=auto" />
<meta property="og:image:alt" content="A forest stream with colored fallen leaves." />
<meta property="tag" content="capabilities" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="Streams—The definitive guide" />
<meta name="twitter:description" content="The Streams API allows JavaScript to programmatically access streams of data received over the network and process them as desired. " />
<meta name="twitter:image" content="https://web-dev.imgix.net/image/8WbTDNrhLsU0El80frMBGE4eMCD3/TuciUuOQOd3u7uMgDZBi.jpg?auto=format&fit=max&w=1200&fm=auto" />
<link
  rel="alternate"
  href="/feed.xml"
  type="application/atom+xml"
  data-title="web.dev feed"
/>

<link rel="manifest" href="/manifest.webmanifest" />

<link rel="shortcut icon" href="/images/favicon.ico">
<link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
<link rel="mask-icon" color="#0054ff" href="/images/safari-pinned-tab.svg">



<script>
window.ga =
  window.ga ||
  function () {
    (ga.q = ga.q || []).push(arguments);
  };
ga.l = +new Date();
ga('create', 'UA-126406676-2');
ga('set', 'transport', 'beacon');
ga('set', 'anonymizeIp', true);
ga('set', 'page', window.location.pathname);
ga('set', 'dimension5', '4');
ga('send', 'pageview');
</script>







<script>
function loadScript(url, type) {
  const s = document.createElement('script');
  s.src = url;
  if (type) {
    s.type = type;
  }
  if (type === 'module') {
    s.async = false; // Preserve load order.
    const pre = document.createElement('link');
    pre.rel = 'modulepreload';
    pre.href = url;
    document.head.append(pre);
    // We use DOMContentLoaded as the loader script is running sync, and inserting a module script here doesn't defer. This brings back normal type="module" behavior.
    window.addEventListener('DOMContentLoaded', () => {
      document.head.append(s);
    });
  } else {
    document.head.append(s);
  }
}
loadScript('/js/app.js?v=6b111414aa529', 'module');




  loadScript('/js/content.js?v=793da74d54f6b', 'module');


  loadScript('https://www.google-analytics.com/analytics.js', null);

</script>

  </head>
  <body class="unresolved">
    
    <web-snackbar-container></web-snackbar-container>

    
<a href="#main" class="skip-link button" data-type="primary">Skip to content</a>


<web-header role="banner" class="site-header">
  <div class="cluster gutter-base">
    <button class="icon-button tooltip color-core-text md:hidden-yes" data-open-drawer-button data-alignment="right">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" height="24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
      <span class="tooltip__content">Open menu</span>
    </button>
    <a href="/" class="site-header__brand brand">
      


  <svg role="img" aria-label="web.dev" xmlns="http://www.w3.org/2000/svg" width="119.79" height="22.32" viewBox="0 0 119.79 22.32"><path class="brand__text" d="M114.99 19.32h-2.2l-4.8-11.9h2.4l3.5 9.2 3.5-9.2h2.4Zm-16.8-7.3h6.8a3.17 3.17 0 0 0-3.4-2.9 3.42 3.42 0 0 0-3.4 2.9Zm3.6 7.7a6 6 0 0 1-6-6.3c0-3.6 2.5-6.3 5.9-6.3s5.8 2.4 5.8 6.5v.2h-9.3a3.88 3.88 0 0 0 3.8 3.9 3.56 3.56 0 0 0 3.3-2.1l2 1a6.22 6.22 0 0 1-5.5 3.1Zm-14 0c-3.1 0-5.7-2.8-5.7-6.3s2.6-6.3 5.7-6.3a5 5 0 0 1 4.1 2h.1l-.1-1.6v-5.5h2.2v17.3h-2.1v-1.6h-.1a5.12 5.12 0 0 1-4.1 2Zm.3-2c2.2 0 3.8-1.7 3.8-4.3s-1.6-4.3-3.8-4.3a4 4 0 0 0-3.8 4.3 4 4 0 0 0 3.8 4.3Zm-6.8.1a1.61 1.61 0 0 1-1.7 1.6 1.74 1.74 0 0 1-1.7-1.6 1.67 1.67 0 0 1 1.7-1.6 1.61 1.61 0 0 1 1.7 1.6Zm-10.5-.1a4 4 0 0 0 3.8-4.3 4 4 0 0 0-3.8-4.3c-2.2 0-3.8 1.8-3.8 4.3s1.6 4.3 3.8 4.3Zm.4 2a5 5 0 0 1-4.1-2h-.1v1.6h-2.1V2.02h2.2v5.5l-.1 1.6h.1a4.84 4.84 0 0 1 4.1-2c3.1 0 5.7 2.8 5.7 6.3s-2.6 6.3-5.7 6.3Zm-17.4-7.7h6.8a3.17 3.17 0 0 0-3.4-2.9 3.42 3.42 0 0 0-3.4 2.9Zm3.6 7.7a6 6 0 0 1-6-6.3c0-3.6 2.5-6.3 5.9-6.3s5.8 2.4 5.8 6.5v.2h-9.3a3.88 3.88 0 0 0 3.8 3.9 3.67 3.67 0 0 0 3.3-2.1l2 1a6.22 6.22 0 0 1-5.5 3.1Zm-6.3-12.2-3.8 11.9h-2.3l-3-9.1-2.9 9.1h-2.3l-3.9-11.9h2.3l2.6 9 2.9-9h2.3l2.9 9 2.6-9Z" fill="#5f6368" fill-rule="evenodd"/><path d="M0 19.28a3 3 0 0 1 3-3h16.27a3.045 3.045 0 0 1 0 6.09H3.04A3 3 0 0 1 0 19.28Z" fill="#6cf"/><path d="M.89.9a3 3 0 0 1 4.3 0l8.12 8.11a3.05 3.05 0 0 1 0 4.3l-8.12 8.12a3.04 3.04 0 1 1-4.3-4.3l5.6-5.61a.51.51 0 0 0 0-.72L.89 5.22A3 3 0 0 1 .89.9Z" fill="#06f" fill-rule="evenodd"/><path d="m10.39 16.22-5.2 5.2a3.04 3.04 0 1 1-4.3-4.3l.89-.9Z" fill="#c6f"/><circle cx="19.27" cy="19.27" r="3.04" fill="#06f"/></svg>


    </a>
  </div>
  <web-navigation-drawer type="standard">
    <nav class="site-header__nav" aria-label="main navigation" data-drawer-container>
      <a
        class="site-header__link"
        href="/learn/" data-category="Site-Wide Custom Events"
        data-label="Tab: Learn"
        >
          Learn
      </a>
      <a
        class="site-header__link"
        href="/measure/"
        data-category="Site-Wide Custom Events"
        data-label="Tab: Measure"
        >
        Measure
      </a>
      <a
        class="site-header__link"
        href="/blog/"
        data-category="Site-Wide Custom Events"
        data-label="Tab: Blog"
        >
        Blog
      </a>
      <a
        class="site-header__link"
        href="/tags/case-study/"
        data-category="Site-Wide Custom Events"
        data-label="Tab: Case Studies"
        >
        Case studies
      </a>
      <a
        class="site-header__link"
        href="/about/"
        data-category="Site-Wide Custom Events"
        data-label="Tab: About" >
        About
      </a>
      <button class="icon-button tooltip color-core-text md:hidden-yes" data-drawer-close-button>
        








  










  <svg class="icon " role="img" aria-label="close" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" height="24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>


        <span class="tooltip__content">Close</span>
      </button>
    </nav>
  </web-navigation-drawer>
  <div class="site-header__actions cluster">
    <div class="site-header__search">
      <web-search results-id="search-main-results" i18n="{&quot;search&quot;:{&quot;en&quot;:&quot;Search&quot;},&quot;open_search&quot;:{&quot;en&quot;:&quot;Open search&quot;},&quot;all_articles&quot;:{&quot;en&quot;:&quot;All articles&quot;},&quot;close_search&quot;:{&quot;en&quot;:&quot;Close search&quot;}}"></web-search>
      <web-search-results id="search-main-results"></web-search-results>
    </div>
  </div>
</web-header>

<main id="main">
  
    
  
  





  <img     alt="A forest stream with colored fallen leaves."     class="hero-image"     decoding="async"     height="480"               sizes="100vw"     src="https://web-dev.imgix.net/image/8WbTDNrhLsU0El80frMBGE4eMCD3/TuciUuOQOd3u7uMgDZBi.jpg?auto=format"     srcset="https://web-dev.imgix.net/image/8WbTDNrhLsU0El80frMBGE4eMCD3/TuciUuOQOd3u7uMgDZBi.jpg?auto=format&w=200 200w,     https://web-dev.imgix.net/image/8WbTDNrhLsU0El80frMBGE4eMCD3/TuciUuOQOd3u7uMgDZBi.jpg?auto=format&w=228 228w,     https://web-dev.imgix.net/image/8WbTDNrhLsU0El80frMBGE4eMCD3/TuciUuOQOd3u7uMgDZBi.jpg?auto=format&w=260 260w,     https://web-dev.imgix.net/image/8WbTDNrhLsU0El80frMBGE4eMCD3/TuciUuOQOd3u7uMgDZBi.jpg?auto=format&w=296 296w,     https://web-dev.imgix.net/image/8WbTDNrhLsU0El80frMBGE4eMCD3/TuciUuOQOd3u7uMgDZBi.jpg?auto=format&w=338 338w,     https://web-dev.imgix.net/image/8WbTDNrhLsU0El80frMBGE4eMCD3/TuciUuOQOd3u7uMgDZBi.jpg?auto=format&w=385 385w,     https://web-dev.imgix.net/image/8WbTDNrhLsU0El80frMBGE4eMCD3/TuciUuOQOd3u7uMgDZBi.jpg?auto=format&w=439 439w,     https://web-dev.imgix.net/image/8WbTDNrhLsU0El80frMBGE4eMCD3/TuciUuOQOd3u7uMgDZBi.jpg?auto=format&w=500 500w,     https://web-dev.imgix.net/image/8WbTDNrhLsU0El80frMBGE4eMCD3/TuciUuOQOd3u7uMgDZBi.jpg?auto=format&w=571 571w,     https://web-dev.imgix.net/image/8WbTDNrhLsU0El80frMBGE4eMCD3/TuciUuOQOd3u7uMgDZBi.jpg?auto=format&w=650 650w,     https://web-dev.imgix.net/image/8WbTDNrhLsU0El80frMBGE4eMCD3/TuciUuOQOd3u7uMgDZBi.jpg?auto=format&w=741 741w,     https://web-dev.imgix.net/image/8WbTDNrhLsU0El80frMBGE4eMCD3/TuciUuOQOd3u7uMgDZBi.jpg?auto=format&w=845 845w,     https://web-dev.imgix.net/image/8WbTDNrhLsU0El80frMBGE4eMCD3/TuciUuOQOd3u7uMgDZBi.jpg?auto=format&w=964 964w,     https://web-dev.imgix.net/image/8WbTDNrhLsU0El80frMBGE4eMCD3/TuciUuOQOd3u7uMgDZBi.jpg?auto=format&w=1098 1098w,     https://web-dev.imgix.net/image/8WbTDNrhLsU0El80frMBGE4eMCD3/TuciUuOQOd3u7uMgDZBi.jpg?auto=format&w=1252 1252w,     https://web-dev.imgix.net/image/8WbTDNrhLsU0El80frMBGE4eMCD3/TuciUuOQOd3u7uMgDZBi.jpg?auto=format&w=1428 1428w,     https://web-dev.imgix.net/image/8WbTDNrhLsU0El80frMBGE4eMCD3/TuciUuOQOd3u7uMgDZBi.jpg?auto=format&w=1600 1600w"          width="1600"   />


<div class="post wrapper" data-flush>
  
    
    
    
  
  

  <div class="sidebar region flex-align-start flex-dir-rev flex-wrap-no">
    

  <nav class="course__toc toc over-scroll hidden-yes xl:hidden-no" data-type="side" aria-label="On this page">
    <div class="course-toc__heading font-google-sans weight-medium">On this page</div>
    <web-scroll-spy>
      <div class="toc__wrapper flow-recursive">
        <ul class="toc__list"><li class="toc__listitem"><a class="toc__anchor" href="#core-concepts">Core concepts</a><ul class="toc__list"><li class="toc__listitem"><a class="toc__anchor" href="#chunks">Chunks</a></li><li class="toc__listitem"><a class="toc__anchor" href="#readable-streams">Readable streams</a></li><li class="toc__listitem"><a class="toc__anchor" href="#writable-streams">Writable streams</a></li><li class="toc__listitem"><a class="toc__anchor" href="#transform-streams">Transform streams</a></li><li class="toc__listitem"><a class="toc__anchor" href="#pipe-chains">Pipe chains</a></li><li class="toc__listitem"><a class="toc__anchor" href="#backpressure">Backpressure</a></li><li class="toc__listitem"><a class="toc__anchor" href="#teeing">Teeing</a></li></ul></li><li class="toc__listitem"><a class="toc__anchor" href="#the-mechanics-of-a-readable-stream">The mechanics of a readable stream</a><ul class="toc__list"><li class="toc__listitem"><a class="toc__anchor" href="#creating-a-readable-stream">Creating a readable stream</a></li><li class="toc__listitem"><a class="toc__anchor" href="#readable-stream-code-samples">Readable stream code samples</a></li><li class="toc__listitem"><a class="toc__anchor" href="#asynchronous-iteration">Asynchronous iteration</a></li><li class="toc__listitem"><a class="toc__anchor" href="#teeing-a-readable-stream">Teeing a readable stream</a></li></ul></li><li class="toc__listitem"><a class="toc__anchor" href="#readable-byte-streams">Readable byte streams</a><ul class="toc__list"><li class="toc__listitem"><a class="toc__anchor" href="#creating-a-readable-byte-stream">Creating a readable byte stream</a></li><li class="toc__listitem"><a class="toc__anchor" href="#the-queuingstrategy-2">The queuingStrategy</a></li></ul></li><li class="toc__listitem"><a class="toc__anchor" href="#the-mechanics-of-a-writable-stream">The mechanics of a writable stream</a><ul class="toc__list"><li class="toc__listitem"><a class="toc__anchor" href="#creating-a-writable-stream">Creating a writable stream</a></li><li class="toc__listitem"><a class="toc__anchor" href="#writable-stream-code-sample">Writable stream code sample</a></li><li class="toc__listitem"><a class="toc__anchor" href="#piping-a-readable-stream-to-a-writable-stream">Piping a readable stream to a writable stream</a></li></ul></li><li class="toc__listitem"><a class="toc__anchor" href="#creating-a-transform-stream">Creating a transform stream</a><ul class="toc__list"><li class="toc__listitem"><a class="toc__anchor" href="#the-transformer">The transformer</a></li><li class="toc__listitem"><a class="toc__anchor" href="#the-writablestrategy-and-readablestrategy-queueing-strategies">The writableStrategy and readableStrategy queueing strategies</a></li><li class="toc__listitem"><a class="toc__anchor" href="#transform-stream-code-sample">Transform stream code sample</a></li><li class="toc__listitem"><a class="toc__anchor" href="#piping-a-readable-stream-through-a-transform-stream">Piping a readable stream through a transform stream</a></li></ul></li><li class="toc__listitem"><a class="toc__anchor" href="#browser-support-and-polyfill">Browser support and polyfill</a></li><li class="toc__listitem"><a class="toc__anchor" href="#demo">Demo</a></li><li class="toc__listitem"><a class="toc__anchor" href="#useful-streams-available-in-the-browser">Useful streams available in the browser</a></li><li class="toc__listitem"><a class="toc__anchor" href="#useful-resources">Useful resources</a></li><li class="toc__listitem"><a class="toc__anchor" href="#acknowledgements">Acknowledgements</a></li></ul>
      </div>
    </web-scroll-spy>
  </nav>


    
    <article class="prose legacy-rollout">
      <header class="flow gap-bottom-size-3">
        
          <nav class="breadcrumbs" aria-label="breadcrumbs">
            <ul class="breadcrumbs__list" role="list">
              <li>
                <a
                  class="gc-analytics-event"
                  data-category="web.dev"
                  data-label="post, home breadcrumb"
                  data-action="click"
                  href="/"
                >
                  Home
                </a>
              </li>
              
              <li>
                <a
                  class="gc-analytics-event"
                  data-category="web.dev"
                  data-label="post, path breadcrumb"
                  data-action="click"
                  href="/blog"
                >
                  All articles
                </a>
              </li>
              
            </ul>
          </nav>
        

        <h1 id="streamsthe-definitive-guide">Streams—The definitive guide</h1>
        
          <p class="color-mid-text flow-space-base">
            Learn how to use readable, writable, and transform streams with the Streams API.
          </p>
        

        
          <div class="flow-space-size-1 color-mid-text text-size-0">
            <time>Feb 19, 2021</time>
             — Updated <time>Feb 25, 2021</time> 
          </div>
        

        
        

        

        
          <div class="cluster flow-space-size-2">
            
              <div class="author">
  <a class="avatar" href="/authors/thomassteiner/"> <img     alt="Thomas Steiner"     class="w-author__image"     decoding="async"     height="64"          loading="lazy"     sizes="(min-width: 64px) 64px, calc(100vw - 48px)"     src="https://web-dev.imgix.net/image/admin/8PLpVmFef6mj72MVWeiN.jpg?auto=format&fit=crop&h=64&w=64"     srcset="https://web-dev.imgix.net/image/admin/8PLpVmFef6mj72MVWeiN.jpg?fit=crop&h=64&w=64&auto=format&dpr=1&q=75 1x,     https://web-dev.imgix.net/image/admin/8PLpVmFef6mj72MVWeiN.jpg?fit=crop&h=64&w=64&auto=format&dpr=2&q=50 2x,     https://web-dev.imgix.net/image/admin/8PLpVmFef6mj72MVWeiN.jpg?fit=crop&h=64&w=64&auto=format&dpr=3&q=35 3x,     https://web-dev.imgix.net/image/admin/8PLpVmFef6mj72MVWeiN.jpg?fit=crop&h=64&w=64&auto=format&dpr=4&q=23 4x,     https://web-dev.imgix.net/image/admin/8PLpVmFef6mj72MVWeiN.jpg?fit=crop&h=64&w=64&auto=format&dpr=5&q=20 5x"          width="64"   /> </a>
  <div class="flow">
    <cite class="author__name">
      <a href="/authors/thomassteiner/">Thomas Steiner</a>
    </cite>
    <div class="author__links cluster">
               <a href="https://twitter.com/tomayac">Twitter</a>
               <a href="https://github.com/tomayac">GitHub</a>
               <a href="https://glitch.com/@tomayac">Glitch</a>
               <a href="https://blog.tomayac.com/">Homepage</a>
             </div>
  </div>
</div>
            
          </div>
        
      </header>

      

      

  

  <div class="xl:hidden-yes flow-space-size-1">
    <details data-type="inner" role="navigation" aria-label="On this page">
      <summary>
        On this page
      </summary>
      <div class="toc"><ul class="toc__list"><li class="toc__listitem"><a class="toc__anchor" href="#core-concepts">Core concepts</a><ul class="toc__list"><li class="toc__listitem"><a class="toc__anchor" href="#chunks">Chunks</a></li><li class="toc__listitem"><a class="toc__anchor" href="#readable-streams">Readable streams</a></li><li class="toc__listitem"><a class="toc__anchor" href="#writable-streams">Writable streams</a></li><li class="toc__listitem"><a class="toc__anchor" href="#transform-streams">Transform streams</a></li><li class="toc__listitem"><a class="toc__anchor" href="#pipe-chains">Pipe chains</a></li><li class="toc__listitem"><a class="toc__anchor" href="#backpressure">Backpressure</a></li><li class="toc__listitem"><a class="toc__anchor" href="#teeing">Teeing</a></li></ul></li><li class="toc__listitem"><a class="toc__anchor" href="#the-mechanics-of-a-readable-stream">The mechanics of a readable stream</a><ul class="toc__list"><li class="toc__listitem"><a class="toc__anchor" href="#creating-a-readable-stream">Creating a readable stream</a></li><li class="toc__listitem"><a class="toc__anchor" href="#readable-stream-code-samples">Readable stream code samples</a></li><li class="toc__listitem"><a class="toc__anchor" href="#asynchronous-iteration">Asynchronous iteration</a></li><li class="toc__listitem"><a class="toc__anchor" href="#teeing-a-readable-stream">Teeing a readable stream</a></li></ul></li><li class="toc__listitem"><a class="toc__anchor" href="#readable-byte-streams">Readable byte streams</a><ul class="toc__list"><li class="toc__listitem"><a class="toc__anchor" href="#creating-a-readable-byte-stream">Creating a readable byte stream</a></li><li class="toc__listitem"><a class="toc__anchor" href="#the-queuingstrategy-2">The queuingStrategy</a></li></ul></li><li class="toc__listitem"><a class="toc__anchor" href="#the-mechanics-of-a-writable-stream">The mechanics of a writable stream</a><ul class="toc__list"><li class="toc__listitem"><a class="toc__anchor" href="#creating-a-writable-stream">Creating a writable stream</a></li><li class="toc__listitem"><a class="toc__anchor" href="#writable-stream-code-sample">Writable stream code sample</a></li><li class="toc__listitem"><a class="toc__anchor" href="#piping-a-readable-stream-to-a-writable-stream">Piping a readable stream to a writable stream</a></li></ul></li><li class="toc__listitem"><a class="toc__anchor" href="#creating-a-transform-stream">Creating a transform stream</a><ul class="toc__list"><li class="toc__listitem"><a class="toc__anchor" href="#the-transformer">The transformer</a></li><li class="toc__listitem"><a class="toc__anchor" href="#the-writablestrategy-and-readablestrategy-queueing-strategies">The writableStrategy and readableStrategy queueing strategies</a></li><li class="toc__listitem"><a class="toc__anchor" href="#transform-stream-code-sample">Transform stream code sample</a></li><li class="toc__listitem"><a class="toc__anchor" href="#piping-a-readable-stream-through-a-transform-stream">Piping a readable stream through a transform stream</a></li></ul></li><li class="toc__listitem"><a class="toc__anchor" href="#browser-support-and-polyfill">Browser support and polyfill</a></li><li class="toc__listitem"><a class="toc__anchor" href="#demo">Demo</a></li><li class="toc__listitem"><a class="toc__anchor" href="#useful-streams-available-in-the-browser">Useful streams available in the browser</a></li><li class="toc__listitem"><a class="toc__anchor" href="#useful-resources">Useful resources</a></li><li class="toc__listitem"><a class="toc__anchor" href="#acknowledgements">Acknowledgements</a></li></ul></div>
    </details>
  </div>



      <p>The Streams API allows you to programmatically access streams of data received over the network
or created by whatever means locally and
process them with JavaScript. Streaming involves breaking down a resource that you want to receive, send, or transform
into small chunks, and then processing these chunks bit by bit. While streaming is something
browsers do anyway when receiving assets like HTML or videos to be shown on webpages, this
capability has never been available to JavaScript before <code>fetch</code> with streams was introduced in 2015.</p>
<aside class="aside flow bg-state-info-bg color-state-info-text">
<div class=" flow">
<p>Streaming was technically possible with <code>XMLHttpRequest</code>, but it
<a href="https://gist.github.com/igrigorik/5736866" rel="noopener">really was not pretty</a>.</p>
</div></aside>
<p>Previously, if you wanted to process a resource of some kind (be it a video, or a text file, etc.),
you would have to download the entire file, wait for it to be deserialized into a suitable format,
and then process it. With streams being available to
JavaScript, this all changes. You can now process raw data with JavaScript progressively as
soon as it is available on the client, without needing to generate a buffer, string, or blob.
This unlocks a number of use cases, some of which I list below:</p>
<ul>
<li><strong>Video effects:</strong> piping a readable video stream through a transform stream that applies effects
in real time.</li>
<li><strong>Data (de)compression:</strong> piping a file stream through a transform stream that selectively
(de)compresses it.</li>
<li><strong>Image decoding:</strong> piping an HTTP response stream through a transform stream that decodes bytes
into bitmap data, and then through another transform stream that translates bitmaps into PNGs. If
installed inside the <code>fetch</code> handler of a service worker, this allows you to transparently polyfill
new image formats like AVIF.</li>
</ul>
<h2 id="core-concepts">Core concepts <a class="w-headline-link" href="#core-concepts">#</a></h2>
<p>Before I go into details on the various types of streams, let me introduce some core concepts.</p>
<h3 id="chunks">Chunks <a class="w-headline-link" href="#chunks">#</a></h3>
<p>A chunk is a <strong>single piece of data</strong> that is written to or read from a stream. It can be of any
type; streams can even contain chunks of different types. Most of the time, a chunk will not be the most atomic
unit of data for a given stream. For example, a byte stream might contain chunks consisting of 16
KiB <code>Uint8Array</code> units, instead of single bytes.</p>
<h3 id="readable-streams">Readable streams <a class="w-headline-link" href="#readable-streams">#</a></h3>
<p>A readable stream represents a source of data from which you can read. In other words, data <strong>comes
out</strong> of a readable stream. Concretely, a readable stream is an instance of the <code>ReadableStream</code>
class.</p>
<h3 id="writable-streams">Writable streams <a class="w-headline-link" href="#writable-streams">#</a></h3>
<p>A writable stream represents a destination for data into which you can write. In other words, data
<strong>goes in</strong> to a writable stream. Concretely, a writable stream is an instance of the
<code>WritableStream</code> class.</p>
<h3 id="transform-streams">Transform streams <a class="w-headline-link" href="#transform-streams">#</a></h3>
<p>A transform stream consists of a <strong>pair of streams</strong>: a writable stream, known as its writable side,
and a readable stream, known as its readable side.
A real-world metaphor for this would be a
<a href="https://en.wikipedia.org/wiki/Simultaneous_interpretation" rel="noopener">simultaneous interpreter</a>
who translates from one language to another on-the-fly.
In a manner specific to the transform stream, writing
to the writable side results in new data being made available for reading from the
readable side. Concretely, any object with a <code>writable</code> property and a <code>readable</code> property can serve
as a transform stream. However, the standard <code>TransformStream</code> class makes it easier to create
such a pair that is properly entangled.</p>
<h3 id="pipe-chains">Pipe chains <a class="w-headline-link" href="#pipe-chains">#</a></h3>
<p>Streams are primarily used by <strong>piping</strong> them to each other. A readable stream can be piped directly
to a writable stream, using the readable stream's <code>pipeTo()</code> method, or it can be piped through one
or more transform streams first, using the readable stream's <code>pipeThrough()</code> method. A <strong>set of
streams piped together</strong> in this way is referred to as a pipe chain.</p>
<h3 id="backpressure">Backpressure <a class="w-headline-link" href="#backpressure">#</a></h3>
<p>Once a pipe chain is constructed, it will propagate signals regarding how fast chunks should flow
through it. If any step in the chain cannot yet accept chunks, it propagates a signal backwards
through the pipe chain, until eventually the original source is told to stop producing chunks so
fast. This process of <strong>normalizing flow</strong> is called backpressure.</p>
<h3 id="teeing">Teeing <a class="w-headline-link" href="#teeing">#</a></h3>
<p>A readable stream can be teed (named after the shape of an uppercase 'T') using its <code>tee()</code> method.
This will <strong>lock</strong> the stream, that is, make it no longer directly usable; however, it will create <strong>two new
streams</strong>, called branches, which can be consumed independently.
Teeing also is important because streams cannot be rewound or restarted, more about this later.</p>
<figure class="w-figure">
  <!-- Original source file located at https://drive.google.com/file/d/17apgoyo6E5RAA_nwwM5Xg4FGiMr8y3mk/view?usp=sharing -->
  <img     alt="Diagram of a pipe chain consisting of a readable stream coming from a call to the fetch API that is then piped through a transform stream whose output is teed and then sent to the browser for the first resulting readable stream and to the service worker cache for the second resulting readable stream."          decoding="async"     height="430"          loading="lazy"          src="https://web-dev.imgix.net/image/8WbTDNrhLsU0El80frMBGE4eMCD3/M70SLIvXhMkYfxDm5b98.svg"               width="800"   />
  <figcaption class="w-figcaption">A pipe chain.</figcaption>
</figure>
<h2 id="the-mechanics-of-a-readable-stream">The mechanics of a readable stream <a class="w-headline-link" href="#the-mechanics-of-a-readable-stream">#</a></h2>
<p>A readable stream is a data source represented in JavaScript by a
<a href="https://developer.mozilla.org/docs/Web/API/ReadableStream" rel="noopener"><code>ReadableStream</code></a> object that
flows from an underlying source. The
<a href="https://developer.mozilla.org/docs/Web/API/ReadableStream/ReadableStream" rel="noopener"><code>ReadableStream()</code></a>
constructor creates and returns a readable stream object from the given handlers. There are two
types of underlying source:</p>
<ul>
<li><strong>Push sources</strong> constantly push data at you when you have accessed them, and it is up to you to
start, pause, or cancel access to the stream. Examples include live video streams, server-sent events,
or WebSockets.</li>
<li><strong>Pull sources</strong> require you to explicitly request data from them once connected to. Examples
include HTTP operations via <code>fetch()</code> or <code>XMLHttpRequest</code> calls.</li>
</ul>
<p>Stream data is read sequentially in small pieces called <strong>chunks</strong>.
The chunks placed in a stream are said to be <strong>enqueued</strong>. This means they are waiting in a queue
ready to be read. An <strong>internal queue</strong> keeps track of the chunks that have not yet been read.</p>
<p>A <strong>queuing strategy</strong> is an object that determines how a stream should signal backpressure based on
the state of its internal queue. The queuing strategy assigns a size to each chunk, and compares the
total size of all chunks in the queue to a specified number, known as the <strong>high water mark</strong>.</p>
<p>The chunks inside the stream are read by a <strong>reader</strong>. This reader retrieves the data one chunk at a
time, allowing you to do whatever kind of operation you want to do on it. The reader plus the other
processing code that goes along with it is called a <strong>consumer</strong>.</p>
<p>The next construct in this context is called a <strong>controller</strong>. Each readable stream has an associated
controller that, as the name suggests, allows you to control the stream.</p>
<p>Only one reader can read a stream at a time; when a reader is created and starts reading a stream
(that is, becomes an <strong>active reader</strong>), it is <strong>locked</strong> to it. If you want another reader to take over
reading your stream, you typically need to <strong>release</strong> the first reader before you do anything else
(although you can <strong>tee</strong> streams).</p>
<h3 id="creating-a-readable-stream">Creating a readable stream <a class="w-headline-link" href="#creating-a-readable-stream">#</a></h3>
<p>You create a readable stream by calling its constructor
<a href="https://developer.mozilla.org/docs/Web/API/ReadableStream/ReadableStream" rel="noopener"><code>ReadableStream()</code></a>.
The constructor has an optional argument <code>underlyingSource</code>, which represents an object
with methods and properties that define how the constructed stream instance will behave.</p>
<h4 id="the-underlyingsource">The <code>underlyingSource</code> <a class="w-headline-link" href="#the-underlyingsource">#</a></h4>
<p>This can use the following optional, developer-defined methods:</p>
<ul>
<li><code>start(controller)</code>: Called immediately when the object is constructed. The
method can access the stream source, and do anything else
required to set up the stream functionality. If this process is to be done asynchronously, the method can
return a promise to signal success or failure. The <code>controller</code> parameter passed to this method is
a
<a href="https://developer.mozilla.org/docs/Web/API/ReadableStreamDefaultController" rel="noopener"><code>ReadableStreamDefaultController</code></a>.</li>
<li><code>pull(controller)</code>: Can be used to control the stream as more chunks are fetched. It
is called repeatedly as long as the stream's internal queue of chunks is not full, up until the queue
reaches its high water mark. If the result of calling <code>pull()</code> is a promise,
<code>pull()</code> will not be called again until said  promise fulfills.
If the promise rejects, the stream will become errored.</li>
<li><code>cancel(reason)</code>: Called when the stream consumer cancels the stream.</li>
</ul>
<web-copy-code><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> readableStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReadableStream</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>  <span class="token function">start</span><span class="token punctuation">(</span><span class="token parameter">controller</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">/* … */</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br><br>  <span class="token function">pull</span><span class="token punctuation">(</span><span class="token parameter">controller</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">/* … */</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br><br>  <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">/* … */</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</web-copy-code><p>The <code>ReadableStreamDefaultController</code> supports the following methods:</p>
<ul>
<li><a href="https://developer.mozilla.org/docs/Web/API/ReadableStreamDefaultController/close" rel="noopener"><code>ReadableStreamDefaultController.close()</code></a>
closes the associated stream.</li>
<li><a href="https://developer.mozilla.org/docs/Web/API/ReadableStreamDefaultController/enqueue" rel="noopener"><code>ReadableStreamDefaultController.enqueue()</code></a>
enqueues a given chunk in the associated stream.</li>
<li><a href="https://developer.mozilla.org/docs/Web/API/ReadableStreamDefaultController/error" rel="noopener"><code>ReadableStreamDefaultController.error()</code></a>
causes any future interactions with the associated stream to error.</li>
</ul>
<web-copy-code><pre class="language-js"><code class="language-js"><span class="token comment">/* … */</span><br><span class="token function">start</span><span class="token punctuation">(</span><span class="token parameter">controller</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  controller<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span><span class="token string">'The first chunk!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">,</span><br><span class="token comment">/* … */</span></code></pre>
</web-copy-code><h4 id="the-queuingstrategy">The <code>queuingStrategy</code> <a class="w-headline-link" href="#the-queuingstrategy">#</a></h4>
<p>The second, likewise optional, argument of the <code>ReadableStream()</code> constructor is <code>queuingStrategy</code>.
It is an object that optionally defines a queuing strategy for the stream, which takes two
parameters:</p>
<ul>
<li><code>highWaterMark</code>: A non-negative number indicating the high water mark of the stream using this queuing strategy.</li>
<li><code>size(chunk)</code>: A function that computes and returns the finite non-negative size of the given chunk value.
The result is used to determine backpressure, manifesting via the appropriate <code>ReadableStreamDefaultController.desiredSize</code> property.
It also governs when the underlying source's <code>pull()</code> method is called.</li>
</ul>
<web-copy-code><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> readableStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReadableStream</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>    <span class="token comment">/* … */</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token punctuation">{</span><br>    highWaterMark<span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span><br>    <span class="token function">size</span><span class="token punctuation">(</span><span class="token parameter">chunk</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token keyword">return</span> chunk<span class="token punctuation">.</span>length<span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</web-copy-code><aside class="aside flow bg-state-info-bg color-state-info-text">
<div class=" flow">
<p>You could define your own custom <code>queuingStrategy</code>, or use an instance of
<a href="https://developer.mozilla.org/docs/Web/API/ByteLengthQueuingStrategy" rel="noopener"><code>ByteLengthQueuingStrategy</code></a>
or <a href="https://developer.mozilla.org/docs/Web/API/CountQueuingStrategy" rel="noopener"><code>CountQueuingStrategy</code></a>
for this object's value. If no <code>queuingStrategy</code> is supplied, the default used is the same as a
<code>CountQueuingStrategy</code> with a <code>highWaterMark</code> of <code>1</code>.</p>
</div></aside>
<h4 id="the-getreader()-and-read()-methods">The <code>getReader()</code> and <code>read()</code> methods <a class="w-headline-link" href="#the-getreader()-and-read()-methods">#</a></h4>
<p>To read from a readable stream, you need a reader, which will be a
<a href="https://developer.mozilla.org/docs/Web/API/ReadableStreamDefaultReader" rel="noopener"><code>ReadableStreamDefaultReader</code></a>.
The <code>getReader()</code> method of the <code>ReadableStream</code> interface creates a reader and locks the stream to
it. While the stream is locked, no other reader can be acquired until this one is released.</p>
<p>The <a href="https://developer.mozilla.org/docs/Web/API/ReadableStreamDefaultReader/read" rel="noopener"><code>read()</code></a>
method of the <code>ReadableStreamDefaultReader</code> interface returns a promise providing access to the next
chunk in the stream's internal queue. It fulfills or rejects with a result depending on the state of
the stream. The different possibilities are as follows:</p>
<ul>
<li>If a chunk is available, the promise will be fulfilled with an object of the form<br>
<code>{ value: chunk, done: false }</code>.</li>
<li>If the stream becomes closed, the promise will be fulfilled with an object of the form<br>
<code>{ value: undefined, done: true }</code>.</li>
<li>If the stream becomes errored, the promise will be rejected with the relevant error.</li>
</ul>
<web-copy-code><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> reader <span class="token operator">=</span> readableStream<span class="token punctuation">.</span><span class="token function">getReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token punctuation">{</span> done<span class="token punctuation">,</span> value <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> reader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'The stream is done.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">break</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Just read a chunk:'</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
</web-copy-code><h4 id="the-locked-property">The <code>locked</code> property <a class="w-headline-link" href="#the-locked-property">#</a></h4>
<p>You can check if a readable stream is locked by accessing its
<a href="https://developer.mozilla.org/docs/Web/API/ReadableStream/locked" rel="noopener"><code>ReadableStream.locked</code></a>
property.</p>
<web-copy-code><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> locked <span class="token operator">=</span> readableStream<span class="token punctuation">.</span>locked<span class="token punctuation">;</span><br>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">The stream is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>locked <span class="token operator">?</span> <span class="token string">'indeed'</span> <span class="token operator">:</span> <span class="token string">'not'</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> locked.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</web-copy-code><h3 id="readable-stream-code-samples">Readable stream code samples <a class="w-headline-link" href="#readable-stream-code-samples">#</a></h3>
<p>The code sample below shows all the steps in action. You first create a <code>ReadableStream</code> that in its
<code>underlyingSource</code> argument (that is, the <code>TimestampSource</code> class) defines a <code>start()</code> method.
This method tells the stream's <code>controller</code> to
<code>enqueue()</code> a timestamp every second during ten seconds.
Finally, it tells the controller to <code>close()</code> the stream. You consume this
stream by creating a reader via the <code>getReader()</code> method and calling <code>read()</code> until the stream is
<code>done</code>.</p>
<web-copy-code><pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">TimestampSource</span> <span class="token punctuation">{</span><br>  #interval<br><br>  <span class="token function">start</span><span class="token punctuation">(</span><span class="token parameter">controller</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span>#interval <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>      <span class="token keyword">const</span> string <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLocaleTimeString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token comment">// Add the string to the stream.</span><br>      controller<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span>string<span class="token punctuation">)</span><span class="token punctuation">;</span><br>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Enqueued </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>string<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1_000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>      <span class="token function">clearInterval</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>#interval<span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token comment">// Close the stream after 10s.</span><br>      controller<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">10_000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">// This is called if the reader cancels.</span><br>    <span class="token function">clearInterval</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>#interval<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">const</span> stream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReadableStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TimestampSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">concatStringStream</span><span class="token punctuation">(</span><span class="token parameter">stream</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> reader <span class="token operator">=</span> stream<span class="token punctuation">.</span><span class="token function">getReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">// The `read()` method returns a promise that</span><br>    <span class="token comment">// resolves when a value has been received.</span><br>    <span class="token keyword">const</span> <span class="token punctuation">{</span> done<span class="token punctuation">,</span> value <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> reader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token comment">// Result objects contain two properties:</span><br>    <span class="token comment">// `done`  - `true` if the stream has already given you all its data.</span><br>    <span class="token comment">// `value` - Some data. Always `undefined` when `done` is `true`.</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>done<span class="token punctuation">)</span> <span class="token keyword">return</span> result<span class="token punctuation">;</span><br>    result <span class="token operator">+=</span> value<span class="token punctuation">;</span><br>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Read </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>result<span class="token punctuation">.</span>length<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> characters so far</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Most recently read chunk: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>value<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><span class="token function">concatStringStream</span><span class="token punctuation">(</span>stream<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">result</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Stream complete'</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</web-copy-code><h3 id="asynchronous-iteration">Asynchronous iteration <a class="w-headline-link" href="#asynchronous-iteration">#</a></h3>
<p>Checking upon each <code>read()</code> loop iteration if the stream is <code>done</code> may not be the most convenient API.
Luckily there will soon be a better way to do this: asynchronous iteration.</p>
<web-copy-code><pre class="language-js"><code class="language-js"><span class="token keyword">for</span> <span class="token keyword">await</span> <span class="token punctuation">(</span><span class="token keyword">const</span> chunk <span class="token keyword">of</span> stream<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
</web-copy-code><aside class="aside flow bg-state-bad-bg color-state-bad-text">
<p class="cluster color-state-bad-text">
<span class="aside__icon box-block "><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Error sign">
  <path fill-rule="evenodd" clip-rule="evenodd" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15v-2h2v2h-2zm0-10v6h2V7h-2z" />
</svg></span>
<strong>Caution</strong></p>
<div class=" flow">
<p>Asynchronous iteration is not yet implemented in any browser.</p>
</div></aside>
<p>A workaround to use asynchronous iteration today is to implement the behavior with a helper
function. This allows you to use the feature in your code as shown in the snippet below.</p>
<web-copy-code><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">streamAsyncIterator</span><span class="token punctuation">(</span><span class="token parameter">stream</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token comment">// Get a lock on the stream:</span><br>  <span class="token keyword">const</span> reader <span class="token operator">=</span> stream<span class="token punctuation">.</span><span class="token function">getReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">return</span> <span class="token punctuation">{</span><br>    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token comment">// Stream reads already resolve with {done, value}, so</span><br>      <span class="token comment">// we can just call read:</span><br>      <span class="token keyword">return</span> reader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">,</span><br>    <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token comment">// Release the lock if the iterator terminates.</span><br>      reader<span class="token punctuation">.</span><span class="token function">releaseLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">,</span><br>    <span class="token comment">// for-await calls this on whatever it's passed, so</span><br>    <span class="token comment">// iterators tend to return themselves.</span><br>    <span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>asyncIterator<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">example</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">for</span> <span class="token keyword">await</span> <span class="token punctuation">(</span><span class="token keyword">const</span> chunk <span class="token keyword">of</span> <span class="token function">streamAsyncIterator</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
</web-copy-code><h3 id="teeing-a-readable-stream">Teeing a readable stream <a class="w-headline-link" href="#teeing-a-readable-stream">#</a></h3>
<p>The <a href="https://developer.mozilla.org/docs/Web/API/ReadableStream/tee" rel="noopener"><code>tee()</code></a> method of the
<code>ReadableStream</code> interface tees the current readable stream, returning a two-element array
containing the two resulting branches as new <code>ReadableStream</code> instances. This allows
two readers to read a stream simultaneously. You might do this, for example, in a service worker if
you want to fetch a response from the server and stream it to the browser, but also stream it to the
service worker cache. Since a response body cannot be consumed more than once, you need two copies
to do this. To cancel the stream, you then need to cancel both resulting branches. Teeing a stream
will generally lock it for the duration, preventing other readers from locking it.</p>
<web-copy-code><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> readableStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReadableStream</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>  <span class="token function">start</span><span class="token punctuation">(</span><span class="token parameter">controller</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">// Called by constructor.</span><br>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[start]'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    controller<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    controller<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span><span class="token string">'b'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    controller<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span><span class="token string">'c'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token function">pull</span><span class="token punctuation">(</span><span class="token parameter">controller</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">// Called `read()` when the controller's queue is empty.</span><br>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[pull]'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    controller<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span><span class="token string">'d'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    controller<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">// Called when the stream is canceled.</span><br>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[cancel]'</span><span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">// Create two `ReadableStream`s.</span><br><span class="token keyword">const</span> <span class="token punctuation">[</span>streamA<span class="token punctuation">,</span> streamB<span class="token punctuation">]</span> <span class="token operator">=</span> readableStream<span class="token punctuation">.</span><span class="token function">tee</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">// Read streamA iteratively one by one. Typically, you</span><br><span class="token comment">// would not do it this way, but you certainly can.</span><br><span class="token keyword">const</span> readerA <span class="token operator">=</span> streamA<span class="token punctuation">.</span><span class="token function">getReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[A]'</span><span class="token punctuation">,</span> <span class="token keyword">await</span> readerA<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//=> {value: "a", done: false}</span><br>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[A]'</span><span class="token punctuation">,</span> <span class="token keyword">await</span> readerA<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//=> {value: "b", done: false}</span><br>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[A]'</span><span class="token punctuation">,</span> <span class="token keyword">await</span> readerA<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//=> {value: "c", done: false}</span><br>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[A]'</span><span class="token punctuation">,</span> <span class="token keyword">await</span> readerA<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//=> {value: "d", done: false}</span><br>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[A]'</span><span class="token punctuation">,</span> <span class="token keyword">await</span> readerA<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//=> {value: undefined, done: true}</span><br><br><span class="token comment">// Read streamB in a loop. This is the more common way</span><br><span class="token comment">// to read data from the stream.</span><br><span class="token keyword">const</span> readerB <span class="token operator">=</span> streamB<span class="token punctuation">.</span><span class="token function">getReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> readerB<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>done<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[B]'</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
</web-copy-code><h2 id="readable-byte-streams">Readable byte streams <a class="w-headline-link" href="#readable-byte-streams">#</a></h2>
<p>For streams representing bytes, an extended version of the readable stream is provided to handle
bytes efficiently, in particular by minimizing copies. Byte streams allow for bring-your-own-buffer
(BYOB) readers to be acquired. The default implementation can give a range of different outputs such
as strings or array buffers in the case of WebSockets, whereas byte streams guarantee byte output.
In addition, BYOB readers have stability benefits. This is
because if a buffer detaches, it can guarantee that one does not write into the same buffer twice,
hence avoiding race conditions. BYOB readers can reduce the number of times the browser needs to run
garbage collection, because it can reuse buffers.</p>
<h3 id="creating-a-readable-byte-stream">Creating a readable byte stream <a class="w-headline-link" href="#creating-a-readable-byte-stream">#</a></h3>
<p>You can create a readable byte stream by passing an additional <code>type</code> parameter to the
<code>ReadableStream()</code> constructor.</p>
<web-copy-code><pre class="language-js"><code class="language-js"><span class="token keyword">new</span> <span class="token class-name">ReadableStream</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">'bytes'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</web-copy-code><h4 id="the-underlyingsource-2">The <code>underlyingSource</code> <a class="w-headline-link" href="#the-underlyingsource-2">#</a></h4>
<p>The underlying source of a readable byte stream is given a <code>ReadableByteStreamController</code> to
manipulate. Its <code>ReadableByteStreamController.enqueue()</code> method takes a <code>chunk</code> argument whose value
is an <code>ArrayBufferView</code>. The property <code>ReadableByteStreamController.byobRequest</code> returns the current
BYOB pull request, or null if there is none. Finally, the <code>ReadableByteStreamController.desiredSize</code>
property returns the desired size to fill the controlled stream's internal queue.</p>
<h3 id="the-queuingstrategy-2">The <code>queuingStrategy</code> <a class="w-headline-link" href="#the-queuingstrategy-2">#</a></h3>
<p>The second, likewise optional, argument of the <code>ReadableStream()</code> constructor is <code>queuingStrategy</code>.
It is an object that optionally defines a queuing strategy for the stream, which takes one
parameter:</p>
<ul>
<li><code>highWaterMark</code>: A non-negative number of bytes indicating the high water mark of the stream using this queuing strategy.
This is used to determine backpressure, manifesting via the appropriate <code>ReadableByteStreamController.desiredSize</code> property.
It also governs when the underlying source's <code>pull()</code> method is called.</li>
</ul>
<aside class="aside flow bg-state-info-bg color-state-info-text">
<div class=" flow">
<p>Unlike queuing strategies for other stream types, a queuing strategy for a readable byte stream
does not have a <code>size(chunk)</code> function. The size of each chunk is always determined by its
<code>byteLength</code> property.</p>
</div></aside>
<aside class="aside flow bg-state-info-bg color-state-info-text">
<div class=" flow">
<p>If no <code>queuingStrategy</code> is supplied, the default used is one with a <code>highWaterMark</code> of <code>0</code>.</p>
</div></aside>
<h4 id="the-getreader()-and-read()-methods-2">The <code>getReader()</code> and <code>read()</code> methods <a class="w-headline-link" href="#the-getreader()-and-read()-methods-2">#</a></h4>
<p>You can then get access to a <code>ReadableStreamBYOBReader</code> by setting the <code>mode</code> parameter accordingly:
<code>ReadableStream.getReader({ mode: &quot;byob&quot; })</code>. This allows for more precise control over buffer
allocation in order to avoid copies. To read from the byte stream, you need to call
<code>ReadableStreamBYOBReader.read(view)</code>, where <code>view</code> is an
<a href="https://developer.mozilla.org/docs/Web/API/ArrayBufferView" rel="noopener"><code>ArrayBufferView</code></a>.</p>
<h4 id="readable-byte-stream-code-sample">Readable byte stream code sample <a class="w-headline-link" href="#readable-byte-stream-code-sample">#</a></h4>
<web-copy-code><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> reader <span class="token operator">=</span> readableStream<span class="token punctuation">.</span><span class="token function">getReader</span><span class="token punctuation">(</span><span class="token punctuation">{</span> mode<span class="token operator">:</span> <span class="token string">"byob"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">let</span> startingAB <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBuffer</span><span class="token punctuation">(</span><span class="token number">1_024</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> buffer <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">readInto</span><span class="token punctuation">(</span>startingAB<span class="token punctuation">)</span><span class="token punctuation">;</span><br>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"The first 1024 bytes, or less:"</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">readInto</span><span class="token punctuation">(</span><span class="token parameter">buffer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">let</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">while</span> <span class="token punctuation">(</span>offset <span class="token operator">&lt;</span> buffer<span class="token punctuation">.</span>byteLength<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> <span class="token punctuation">{</span> value<span class="token operator">:</span> view<span class="token punctuation">,</span> done <span class="token punctuation">}</span> <span class="token operator">=</span><br>        <span class="token keyword">await</span> reader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> buffer<span class="token punctuation">.</span>byteLength <span class="token operator">-</span> offset<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    buffer <span class="token operator">=</span> view<span class="token punctuation">.</span>buffer<span class="token punctuation">;</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token keyword">break</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>    offset <span class="token operator">+=</span> view<span class="token punctuation">.</span>byteLength<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token keyword">return</span> buffer<span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
</web-copy-code><p>The following function returns readable byte streams that allow for efficient zero-copy reading of a
randomly generated array. Instead of using a predetermined chunk size of 1,024, it attempts to fill
the developer-supplied buffer, allowing for full control.</p>
<web-copy-code><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token constant">DEFAULT_CHUNK_SIZE</span> <span class="token operator">=</span> <span class="token number">1_024</span><span class="token punctuation">;</span><br><br><span class="token keyword">function</span> <span class="token function">makeReadableByteStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ReadableStream</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>    type<span class="token operator">:</span> <span class="token string">'bytes'</span><span class="token punctuation">,</span><br><br>    <span class="token function">pull</span><span class="token punctuation">(</span><span class="token parameter">controller</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token comment">// Even when the consumer is using the default reader,</span><br>      <span class="token comment">// the auto-allocation feature allocates a buffer and</span><br>      <span class="token comment">// passes it to us via `byobRequest`.</span><br>      <span class="token keyword">const</span> view <span class="token operator">=</span> controller<span class="token punctuation">.</span>byobRequest<span class="token punctuation">.</span>view<span class="token punctuation">;</span><br>      view <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">getRandomValues</span><span class="token punctuation">(</span>view<span class="token punctuation">)</span><span class="token punctuation">;</span><br>      controller<span class="token punctuation">.</span>byobRequest<span class="token punctuation">.</span><span class="token function">respond</span><span class="token punctuation">(</span>view<span class="token punctuation">.</span>byteLength<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">,</span><br><br>    autoAllocateChunkSize<span class="token operator">:</span> <span class="token constant">DEFAULT_CHUNK_SIZE</span><span class="token punctuation">,</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
</web-copy-code><h2 id="the-mechanics-of-a-writable-stream">The mechanics of a writable stream <a class="w-headline-link" href="#the-mechanics-of-a-writable-stream">#</a></h2>
<p>A writable stream is a destination into which you can write data, represented in JavaScript by a
<a href="https://developer.mozilla.org/docs/Web/API/WritableStream" rel="noopener"><code>WritableStream</code></a> object. This
serves as an abstraction over the top of an <strong>underlying sink</strong>—a lower-level I/O sink into which
raw data is written.</p>
<p>The data is written to the stream via a <strong>writer</strong>, one chunk at a time. A chunk can take a
multitude of forms, just like the chunks in a reader. You can use whatever code you like to produce
the chunks ready for writing; the writer plus the associated code is called a <strong>producer</strong>.</p>
<p>When a writer is created and starts writing to a stream (an <strong>active writer</strong>), it is said to be
<strong>locked</strong> to it. Only one writer can write to a writable stream at one time. If you want another
writer to start writing to your stream, you typically need to release it, before you then attach
another writer to it.</p>
<p>An <strong>internal queue</strong> keeps track of the chunks that have been written to the stream but not yet
been processed by the underlying sink.</p>
<p>A <strong>queuing strategy</strong> is an object that determines how a stream should signal backpressure based on
the state of its internal queue. The queuing strategy assigns a size to each chunk, and compares the
total size of all chunks in the queue to a specified number, known as the <strong>high water mark</strong>.</p>
<p>The final construct is called a <strong>controller</strong>. Each writable stream has an associated controller that
allows you to control the stream (for example, to abort it).</p>
<h3 id="creating-a-writable-stream">Creating a writable stream <a class="w-headline-link" href="#creating-a-writable-stream">#</a></h3>
<p>The <a href="https://developer.mozilla.org/docs/Web/API/WritableStream" rel="noopener"><code>WritableStream</code></a> interface of
the Streams API provides a standard abstraction for writing streaming data to a destination, known
as a sink. This object comes with built-in backpressure and queuing. You create a writable stream by
calling its constructor
<a href="https://developer.mozilla.org/docs/Web/API/WritableStream/WritableStream" rel="noopener"><code>WritableStream()</code></a>.
It has an optional <code>underlyingSink</code> parameter, which represents an object
with methods and properties that define how the constructed stream instance will behave.</p>
<h4 id="the-underlyingsink">The <code>underlyingSink</code> <a class="w-headline-link" href="#the-underlyingsink">#</a></h4>
<p>The <code>underlyingSink</code> can include the following optional, developer-defined methods. The <code>controller</code>
parameter passed to some of the methods is a
<a href="https://developer.mozilla.org/docs/Web/API/WritableStreamDefaultController" rel="noopener"><code>WritableStreamDefaultController</code></a>.</p>
<ul>
<li><code>start(controller)</code>: This method is called immediately when the object is constructed. The
contents of this method should aim to get access to the underlying sink. If this process is to be
done asynchronously, it can return a promise to signal success or failure.</li>
<li><code>write(chunk, controller)</code>: This method will be called when a new chunk of data (specified in the
<code>chunk</code> parameter) is ready to be written to the underlying sink. It can return a promise to
signal success or failure of the write operation. This method will be called only after previous
writes have succeeded, and never after the stream is closed or aborted.</li>
<li><code>close(controller)</code>: This method will be called if the app signals that it has finished writing
chunks to the stream. The contents should do whatever is necessary to finalize writes to the
underlying sink, and release access to it. If this process is asynchronous, it can return a
promise to signal success or failure. This method will be called only after all queued-up writes
have succeeded.</li>
<li><code>abort(reason)</code>: This method will be called if the app signals that it wishes to abruptly close
the stream and put it in an errored state. It can clean up any held resources, much like
<code>close()</code>, but <code>abort()</code> will be called even if writes are queued up. Those chunks will be thrown
away. If this process is asynchronous, it can return a promise to signal success or failure. The
<code>reason</code> parameter contains a <code>DOMString</code> describing why the stream was aborted.</li>
</ul>
<web-copy-code><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> writableStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WritableStream</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>  <span class="token function">start</span><span class="token punctuation">(</span><span class="token parameter">controller</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">/* … */</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br><br>  <span class="token function">write</span><span class="token punctuation">(</span><span class="token parameter">chunk<span class="token punctuation">,</span> controller</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">/* … */</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br><br>  <span class="token function">close</span><span class="token punctuation">(</span><span class="token parameter">controller</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">/* … */</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br><br>  <span class="token function">abort</span><span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">/* … */</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</web-copy-code><p>The
<a href="https://developer.mozilla.org/docs/Web/API/WritableStreamDefaultController" rel="noopener"><code>WritableStreamDefaultController</code></a>
interface of the Streams API represents a controller allowing control of a <code>WritableStream</code>'s state
during set up, as more chunks are submitted for writing, or at the end of writing. When constructing
a <code>WritableStream</code>, the underlying sink is given a corresponding <code>WritableStreamDefaultController</code>
instance to manipulate. The <code>WritableStreamDefaultController</code> has only one method:
<a href="https://developer.mozilla.org/docs/Web/API/WritableStreamDefaultController/error" rel="noopener"><code>WritableStreamDefaultController.error()</code></a>,
which causes any future interactions with the associated stream to error.</p>
<web-copy-code><pre class="language-js"><code class="language-js"><span class="token comment">/* … */</span><br><span class="token function">write</span><span class="token punctuation">(</span><span class="token parameter">chunk<span class="token punctuation">,</span> controller</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">try</span> <span class="token punctuation">{</span><br>    <span class="token comment">// Try to do something dangerous with `chunk`.</span><br>  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    controller<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><span class="token punctuation">,</span><br><span class="token comment">/* … */</span></code></pre>
</web-copy-code><h4 id="the-queuingstrategy-3">The <code>queuingStrategy</code> <a class="w-headline-link" href="#the-queuingstrategy-3">#</a></h4>
<p>The second, likewise optional, argument of the <code>WritableStream()</code> constructor is <code>queuingStrategy</code>.
It is an object that optionally defines a queuing strategy for the stream, which takes two
parameters:</p>
<ul>
<li><code>highWaterMark</code>: A non-negative number indicating the high water mark of the stream using this queuing strategy.</li>
<li><code>size(chunk)</code>: A function that computes and returns the finite non-negative size of the given chunk value.
The result is used to determine backpressure, manifesting via the appropriate <code>WritableStreamDefaultWriter.desiredSize</code> property.</li>
</ul>
<aside class="aside flow bg-state-info-bg color-state-info-text">
<div class=" flow">
<p>You could define your own custom <code>queuingStrategy</code>, or use an instance of
<a href="https://developer.mozilla.org/docs/Web/API/ByteLengthQueuingStrategy" rel="noopener"><code>ByteLengthQueuingStrategy</code></a>
or <a href="https://developer.mozilla.org/docs/Web/API/CountQueuingStrategy" rel="noopener"><code>CountQueuingStrategy</code></a>
for this object value. If no <code>queuingStrategy</code> is supplied, the default used is the same as a
<code>CountQueuingStrategy</code> with a <code>highWaterMark</code> of <code>1</code>.</p>
</div></aside>
<h4 id="the-getwriter()-and-write()-methods">The <code>getWriter()</code> and <code>write()</code> methods <a class="w-headline-link" href="#the-getwriter()-and-write()-methods">#</a></h4>
<p>To write to a writable stream, you need a writer, which will be a
<code>WritableStreamDefaultWriter</code>. The <code>getWriter()</code> method of the <code>WritableStream</code> interface returns a
new instance of <code>WritableStreamDefaultWriter</code> and locks the stream to that instance. While the
stream is locked, no other writer can be acquired until the current one is released.</p>
<p>The <a href="https://developer.mozilla.org/docs/Web/API/WritableStreamDefaultWriter/write" rel="noopener"><code>write()</code></a>
method of the
<a href="https://developer.mozilla.org/docs/Web/API/WritableStreamDefaultWriter" rel="noopener"><code>WritableStreamDefaultWriter</code></a>
interface writes a passed chunk of data to a <code>WritableStream</code> and its underlying sink, then returns
a promise that resolves to indicate the success or failure of the write operation. Note that what
&quot;success&quot; means is up to the underlying sink; it might indicate that the chunk has been accepted,
and not necessarily that it is safely saved to its ultimate destination.</p>
<web-copy-code><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> writer <span class="token operator">=</span> writableStream<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> resultPromise <span class="token operator">=</span> writer<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">'The first chunk!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</web-copy-code><h4 id="the-locked-property-2">The <code>locked</code> property <a class="w-headline-link" href="#the-locked-property-2">#</a></h4>
<p>You can check if a writable stream is locked by accessing its
<a href="https://developer.mozilla.org/docs/Web/API/WritableStream/locked" rel="noopener"><code>WritableStream.locked</code></a>
property.</p>
<web-copy-code><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> locked <span class="token operator">=</span> writableStream<span class="token punctuation">.</span>locked<span class="token punctuation">;</span><br>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">The stream is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>locked <span class="token operator">?</span> <span class="token string">'indeed'</span> <span class="token operator">:</span> <span class="token string">'not'</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> locked.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</web-copy-code><h3 id="writable-stream-code-sample">Writable stream code sample <a class="w-headline-link" href="#writable-stream-code-sample">#</a></h3>
<p>The code sample below shows all steps in action.</p>
<web-copy-code><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> writableStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WritableStream</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>  <span class="token function">start</span><span class="token punctuation">(</span><span class="token parameter">controller</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[start]'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token keyword">async</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token parameter">chunk<span class="token punctuation">,</span> controller</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[write]'</span><span class="token punctuation">,</span> chunk<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token comment">// Wait for next write.</span><br>    <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>      document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>textContent <span class="token operator">+=</span> chunk<span class="token punctuation">;</span><br>      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1_000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token function">close</span><span class="token punctuation">(</span><span class="token parameter">controller</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[close]'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token function">abort</span><span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[abort]'</span><span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> writer <span class="token operator">=</span> writableStream<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> start <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> char <span class="token keyword">of</span> <span class="token string">'abcdefghijklmnopqrstuvwxyz'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token comment">// Wait to add to the write queue.</span><br>  <span class="token keyword">await</span> writer<span class="token punctuation">.</span>ready<span class="token punctuation">;</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[ready]'</span><span class="token punctuation">,</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">,</span> <span class="token string">'ms'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token comment">// The Promise is resolved after the write finishes.</span><br>  writer<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>char<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><span class="token keyword">await</span> writer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</web-copy-code><h3 id="piping-a-readable-stream-to-a-writable-stream">Piping a readable stream to a writable stream <a class="w-headline-link" href="#piping-a-readable-stream-to-a-writable-stream">#</a></h3>
<p>A readable stream can be piped to a writable stream through the readable stream's
<a href="https://developer.mozilla.org/docs/Web/API/ReadableStream/pipeTo" rel="noopener"><code>pipeTo()</code></a> method.
<code>ReadableStream.pipeTo()</code> pipes the current <code>ReadableStream</code>to a given <code>WritableStream</code> and returns a
promise that fulfills when the piping process completes successfully, or rejects if any errors were
encountered.</p>
<web-copy-code><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> readableStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReadableStream</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>  <span class="token function">start</span><span class="token punctuation">(</span><span class="token parameter">controller</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">// Called by constructor.</span><br>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[start readable]'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    controller<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    controller<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span><span class="token string">'b'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    controller<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span><span class="token string">'c'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token function">pull</span><span class="token punctuation">(</span><span class="token parameter">controller</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">// Called when controller's queue is empty.</span><br>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[pull]'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    controller<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span><span class="token string">'d'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    controller<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">// Called when the stream is canceled.</span><br>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[cancel]'</span><span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> writableStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WritableStream</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>  <span class="token function">start</span><span class="token punctuation">(</span><span class="token parameter">controller</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">// Called by constructor</span><br>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[start writable]'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token keyword">async</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token parameter">chunk<span class="token punctuation">,</span> controller</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">// Called upon writer.write()</span><br>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[write]'</span><span class="token punctuation">,</span> chunk<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token comment">// Wait for next write.</span><br>    <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>      document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>textContent <span class="token operator">+=</span> chunk<span class="token punctuation">;</span><br>      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1_000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token function">close</span><span class="token punctuation">(</span><span class="token parameter">controller</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[close]'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token function">abort</span><span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[abort]'</span><span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">await</span> readableStream<span class="token punctuation">.</span><span class="token function">pipeTo</span><span class="token punctuation">(</span>writableStream<span class="token punctuation">)</span><span class="token punctuation">;</span><br>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[finished]'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</web-copy-code><h2 id="creating-a-transform-stream">Creating a transform stream <a class="w-headline-link" href="#creating-a-transform-stream">#</a></h2>
<p>The <code>TransformStream</code> interface of the Streams API represents a set of transformable data. You
create a transform stream by calling its constructor <code>TransformStream()</code>, which creates and returns
a transform stream object from the given handlers. The <code>TransformStream()</code> constructor accepts as
its first argument an optional JavaScript object representing the <code>transformer</code>. Such objects can
contain any of the following methods:</p>
<h3 id="the-transformer">The <code>transformer</code> <a class="w-headline-link" href="#the-transformer">#</a></h3>
<ul>
<li><code>start(controller)</code>: This method is called immediately when the object is constructed. Typically
this is used to enqueue prefix chunks, using <code>controller.enqueue()</code>. Those chunks will be read
from the readable side but do not depend on any writes to the writable side. If this initial
process is asynchronous, for example because it takes some effort to acquire the prefix chunks,
the function can return a promise to signal success or failure; a rejected promise will error the
stream. Any thrown exceptions will be re-thrown by the <code>TransformStream()</code> constructor.</li>
<li><code>transform(chunk, controller)</code>: This method is called when a new chunk originally written to the
writable side is ready to be transformed. The stream implementation guarantees that this function
will be called only after previous transforms have succeeded, and never before <code>start()</code> has
completed or after <code>flush()</code> has been called. This function performs the actual transformation
work of the transform stream. It can enqueue the results using <code>controller.enqueue()</code>. This
permits a single chunk written to the writable side to result in zero or multiple chunks on the
readable side, depending on how many times <code>controller.enqueue()</code> is called. If the process of
transforming is asynchronous, this function can return a promise to signal success or failure of
the transformation. A rejected promise will error both the readable and writable sides of the
transform stream. If no <code>transform()</code> method is supplied, the identity transform is used, which
enqueues chunks unchanged from the writable side to the readable side.</li>
<li><code>flush(controller)</code>: This method is called after all chunks written to the writable side have been
transformed by successfully passing through <code>transform()</code>, and the writable side is about to be
closed. Typically this is used to enqueue suffix chunks to the readable side, before that too
becomes closed. If the flushing process is asynchronous, the function can return a promise to
signal success or failure; the result will be communicated to the caller of
<code>stream.writable.write()</code>. Additionally, a rejected promise will error both the readable and
writable sides of the stream. Throwing an exception is treated the same as returning a rejected
promise.</li>
</ul>
<web-copy-code><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> transformStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransformStream</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>  <span class="token function">start</span><span class="token punctuation">(</span><span class="token parameter">controller</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">/* … */</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br><br>  <span class="token function">transform</span><span class="token punctuation">(</span><span class="token parameter">chunk<span class="token punctuation">,</span> controller</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">/* … */</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br><br>  <span class="token function">flush</span><span class="token punctuation">(</span><span class="token parameter">controller</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">/* … */</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</web-copy-code><h3 id="the-writablestrategy-and-readablestrategy-queueing-strategies">The <code>writableStrategy</code> and <code>readableStrategy</code> queueing strategies <a class="w-headline-link" href="#the-writablestrategy-and-readablestrategy-queueing-strategies">#</a></h3>
<p>The second and third optional parameters of the <code>TransformStream()</code> constructor are optional
<code>writableStrategy</code> and <code>readableStrategy</code> queueing strategies. They are defined as outlined in the
<a href="#the-queuingstrategy">readable</a> and the <a href="#the-queuingstrategy-3">writable</a> stream
sections respectively.</p>
<h3 id="transform-stream-code-sample">Transform stream code sample <a class="w-headline-link" href="#transform-stream-code-sample">#</a></h3>
<p>The following code sample shows a simple transform stream in action.</p>
<web-copy-code><pre class="language-js"><code class="language-js"><span class="token comment">// Note that `TextEncoderStream` and `TextDecoderStream` exist now.</span><br><span class="token comment">// This example shows how you would have done it before.</span><br><span class="token keyword">const</span> textEncoderStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransformStream</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>  <span class="token function">transform</span><span class="token punctuation">(</span><span class="token parameter">chunk<span class="token punctuation">,</span> controller</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[transform]'</span><span class="token punctuation">,</span> chunk<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    controller<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TextEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token function">flush</span><span class="token punctuation">(</span><span class="token parameter">controller</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[flush]'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    controller<span class="token punctuation">.</span><span class="token function">terminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> readStream <span class="token operator">=</span> textEncoderStream<span class="token punctuation">.</span>readable<span class="token punctuation">;</span><br>  <span class="token keyword">const</span> writeStream <span class="token operator">=</span> textEncoderStream<span class="token punctuation">.</span>writable<span class="token punctuation">;</span><br><br>  <span class="token keyword">const</span> writer <span class="token operator">=</span> writeStream<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> char <span class="token keyword">of</span> <span class="token string">'abc'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    writer<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>char<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br>  writer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">const</span> reader <span class="token operator">=</span> readStream<span class="token punctuation">.</span><span class="token function">getReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token keyword">await</span> reader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">!</span>result<span class="token punctuation">.</span>done<span class="token punctuation">;</span> result <span class="token operator">=</span> <span class="token keyword">await</span> reader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[value]'</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</web-copy-code><h3 id="piping-a-readable-stream-through-a-transform-stream">Piping a readable stream through a transform stream <a class="w-headline-link" href="#piping-a-readable-stream-through-a-transform-stream">#</a></h3>
<p>The <a href="https://developer.mozilla.org/docs/Web/API/ReadableStream/pipeThrough" rel="noopener"><code>pipeThrough()</code></a>
method of the <code>ReadableStream</code> interface provides a chainable way of piping the current stream
through a transform stream or any other writable/readable pair. Piping a stream will generally lock
it for the duration of the pipe, preventing other readers from locking it.</p>
<web-copy-code><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> transformStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransformStream</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>  <span class="token function">transform</span><span class="token punctuation">(</span><span class="token parameter">chunk<span class="token punctuation">,</span> controller</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[transform]'</span><span class="token punctuation">,</span> chunk<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    controller<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TextEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token function">flush</span><span class="token punctuation">(</span><span class="token parameter">controller</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[flush]'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    controller<span class="token punctuation">.</span><span class="token function">terminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> readableStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReadableStream</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>  <span class="token function">start</span><span class="token punctuation">(</span><span class="token parameter">controller</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">// called by constructor</span><br>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[start]'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    controller<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    controller<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span><span class="token string">'b'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    controller<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span><span class="token string">'c'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token function">pull</span><span class="token punctuation">(</span><span class="token parameter">controller</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">// called read when controller's queue is empty</span><br>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[pull]'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    controller<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span><span class="token string">'d'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    controller<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// or controller.error();</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">// called when rs.cancel(reason)</span><br>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[cancel]'</span><span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> reader <span class="token operator">=</span> readableStream<span class="token punctuation">.</span><span class="token function">pipeThrough</span><span class="token punctuation">(</span>transformStream<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token keyword">await</span> reader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">!</span>result<span class="token punctuation">.</span>done<span class="token punctuation">;</span> result <span class="token operator">=</span> <span class="token keyword">await</span> reader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[value]'</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</web-copy-code><p>The next code sample (a bit contrived) shows how you could implement a &quot;shouting&quot; version of <code>fetch()</code>
that uppercases all text by consuming the returned response promise
<a href="https://developer.mozilla.org/docs/Web/API/Streams_API/Using_readable_streams#consuming_a_fetch_as_a_stream" rel="noopener">as a stream</a>
and uppercasing chunk by chunk. The advantage of this approach is that you do not need to wait for
the whole document to be downloaded, which can make a huge difference when dealing with large files.</p>
<web-copy-code><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">upperCaseStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">TransformStream</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>    <span class="token function">transform</span><span class="token punctuation">(</span><span class="token parameter">chunk<span class="token punctuation">,</span> controller</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      controller<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span>chunk<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">function</span> <span class="token function">appendToDOMStream</span><span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">WritableStream</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>    <span class="token function">write</span><span class="token punctuation">(</span><span class="token parameter">chunk</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      el<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'./lorem-ipsum.txt'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token operator">=></span><br>  response<span class="token punctuation">.</span>body<br>    <span class="token punctuation">.</span><span class="token function">pipeThrough</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TextDecoderStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">pipeThrough</span><span class="token punctuation">(</span><span class="token function">upperCaseStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">pipeTo</span><span class="token punctuation">(</span><span class="token function">appendToDOMStream</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">)</span><br><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</web-copy-code><h2 id="browser-support-and-polyfill">Browser support and polyfill <a class="w-headline-link" href="#browser-support-and-polyfill">#</a></h2>
<p>Support for the Streams API in browsers varies. Be sure to check
<a href="https://caniuse.com/streams" rel="noopener">Can I use</a> for detailed compatibility data. Note that some browsers only
have partial implementations of certain features, so be sure to check the data thoroughly.</p>
<p>The good news is that there is a
<a href="https://github.com/whatwg/streams/tree/master/reference-implementation" rel="noopener">reference implementation</a>
available and a <a href="https://github.com/MattiasBuelens/web-streams-polyfill" rel="noopener">polyfill</a> targeted at
production use.</p>
<aside class="aside flow bg-tertiary-box-bg color-tertiary-box-text">
<p class="cluster ">
<span class="aside__icon box-block "><svg width="24" height="24" viewBox="0 0 24 24" role="img" aria-label="Lightbulb" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
  <path d="M9 21c0 .55.45 1 1 1h4c.55 0 1-.45 1-1v-1H9v1zm3-19C8.14 2 5 5.14 5 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26c1.81-1.27 3-3.36 3-5.74 0-3.86-3.14-7-7-7zm2.85 11.1l-.85.6V16h-4v-2.3l-.85-.6A4.997 4.997 0 017 9c0-2.76 2.24-5 5-5s5 2.24 5 5c0 1.63-.8 3.16-2.15 4.1z" />
</svg></span>
<strong>Gotchas</strong></p>
<div class=" flow">
<p>If possible, load the polyfill conditionally and only if the built-in feature is not available.</p>
</div></aside>
<h2 id="demo">Demo <a class="w-headline-link" href="#demo">#</a></h2>
<p>The demo below shows readable, writable, and transform streams in action. It also includes examples
of <code>pipeThrough()</code> and <code>pipeTo()</code> pipe chains, and also demonstrates <code>tee()</code>. You can optionally run
the <a href="https://streams-demo.glitch.me/" rel="noopener">demo</a> in its own window or view the
<a href="https://glitch.com/edit/#!/streams-demo?path=script.js" rel="noopener">source code</a>.</p>
<div class="glitch-embed-wrap" style="height: 420px; width: 100%;">
  <iframe
    allow="camera; clipboard-read; clipboard-write; encrypted-media; geolocation; microphone; midi"
    loading="lazy"
    src="https://glitch.com/embed/#!/embed/streams-demo?attributionHidden=true&sidebarCollapsed=true&previewSize=100"
    style="height: 100%; width: 100%; border: 0;"
    title="streams-demo on Glitch"
  ></iframe>
</div>
<h2 id="useful-streams-available-in-the-browser">Useful streams available in the browser <a class="w-headline-link" href="#useful-streams-available-in-the-browser">#</a></h2>
<p>There are a number of useful streams built right into the browser. You can easily create a
<code>ReadableStream</code> from a blob. The <a href="https://developer.mozilla.org/docs/Web/API/Blob" rel="noopener"><code>Blob</code></a>
interface's <a href="https://developer.mozilla.org/docs/Web/API/Blob/stream" rel="noopener">stream()</a> method returns
a <code>ReadableStream</code> which upon reading returns the data contained within the blob. Also recall that a
<a href="https://developer.mozilla.org/docs/Web/API/File" rel="noopener"><code>File</code></a> object is a specific kind of a
<code>Blob</code>, and can be used in any context that a blob can.</p>
<web-copy-code><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> readableStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Blob</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'hello world'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">'text/plain'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</web-copy-code><p>The streaming variants of <code>TextDecoder.decode()</code> and <code>TextEncoder.encode()</code> are called
<a href="https://encoding.spec.whatwg.org/#interface-textdecoderstream" rel="noopener"><code>TextDecoderStream</code></a> and
<a href="https://encoding.spec.whatwg.org/#interface-textencoderstream" rel="noopener"><code>TextEncoderStream</code></a> respectively.</p>
<web-copy-code><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://streams.spec.whatwg.org/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> decodedStream <span class="token operator">=</span> response<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">pipeThrough</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TextDecoderStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</web-copy-code><p>Compressing or decompressing a file is easy with the
<a href="https://wicg.github.io/compression/#compression-stream" rel="noopener"><code>CompressionStream</code></a> and
<a href="https://wicg.github.io/compression/#decompression-stream" rel="noopener"><code>DecompressionStream</code></a> transform streams
respectively. The code sample below shows how you can download the Streams spec, compress (gzip) it
right in the browser, and write the compressed file directly to disk.</p>
<web-copy-code><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://streams.spec.whatwg.org/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> readableStream <span class="token operator">=</span> response<span class="token punctuation">.</span>body<span class="token punctuation">;</span><br><span class="token keyword">const</span> compressedStream <span class="token operator">=</span> readableStream<span class="token punctuation">.</span><span class="token function">pipeThrough</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CompressionStream</span><span class="token punctuation">(</span><span class="token string">'gzip'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> fileHandle <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">showSaveFilePicker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> writableStream <span class="token operator">=</span> <span class="token keyword">await</span> fileHandle<span class="token punctuation">.</span><span class="token function">createWritable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>compressedStream<span class="token punctuation">.</span><span class="token function">pipeTo</span><span class="token punctuation">(</span>writableStream<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</web-copy-code><p>The <a href="/file-system-access/">File System Access API</a>'s
<a href="https://wicg.github.io/file-system-access/#filesystemwritablefilestream" rel="noopener"><code>FileSystemWritableFileStream</code></a>
and the experimental <a href="/fetch-upload-streaming/#writable-streams"><code>fetch()</code> request streams</a> are
examples of writable streams in the wild.</p>
<p>The <a href="/serial/">Serial API</a> makes heavy use of both readable and writable streams.</p>
<web-copy-code><pre class="language-js"><code class="language-js"><span class="token comment">// Prompt user to select any serial port.</span><br><span class="token keyword">const</span> port <span class="token operator">=</span> <span class="token keyword">await</span> navigator<span class="token punctuation">.</span>serial<span class="token punctuation">.</span><span class="token function">requestPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token comment">// Wait for the serial port to open.</span><br><span class="token keyword">await</span> port<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">{</span> baudRate<span class="token operator">:</span> <span class="token number">9_600</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> reader <span class="token operator">=</span> port<span class="token punctuation">.</span>readable<span class="token punctuation">.</span><span class="token function">getReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">// Listen to data coming from the serial device.</span><br><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token punctuation">{</span> value<span class="token punctuation">,</span> done <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> reader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">// Allow the serial port to be closed later.</span><br>    reader<span class="token punctuation">.</span><span class="token function">releaseLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">break</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br>  <span class="token comment">// value is a Uint8Array.</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token comment">// Write to the serial port.</span><br><span class="token keyword">const</span> writer <span class="token operator">=</span> port<span class="token punctuation">.</span>writable<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">104</span><span class="token punctuation">,</span> <span class="token number">101</span><span class="token punctuation">,</span> <span class="token number">108</span><span class="token punctuation">,</span> <span class="token number">108</span><span class="token punctuation">,</span> <span class="token number">111</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// hello</span><br><span class="token keyword">await</span> writer<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token comment">// Allow the serial port to be closed later.</span><br>writer<span class="token punctuation">.</span><span class="token function">releaseLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</web-copy-code><p>Finally, the <a href="/websocketstream/"><code>WebSocketStream</code></a> API integrates streams with the WebSocket API.</p>
<web-copy-code><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> wss <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocketStream</span><span class="token punctuation">(</span><span class="token constant">WSS_URL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> <span class="token punctuation">{</span> readable<span class="token punctuation">,</span> writable <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> wss<span class="token punctuation">.</span>connection<span class="token punctuation">;</span><br><span class="token keyword">const</span> reader <span class="token operator">=</span> readable<span class="token punctuation">.</span><span class="token function">getReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> writer <span class="token operator">=</span> writable<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token punctuation">{</span> value<span class="token punctuation">,</span> done <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> reader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">break</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br>  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">process</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">await</span> writer<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
</web-copy-code><h2 id="useful-resources">Useful resources <a class="w-headline-link" href="#useful-resources">#</a></h2>
<ul>
<li><a href="https://streams.spec.whatwg.org/" rel="noopener">Streams specification</a></li>
<li><a href="https://streams.spec.whatwg.org/demos/" rel="noopener">Accompanying demos</a></li>
<li><a href="https://github.com/MattiasBuelens/web-streams-polyfill" rel="noopener">Streams polyfill</a></li>
<li><a href="https://jakearchibald.com/2016/streams-ftw/" rel="noopener">2016—the year of web streams</a></li>
<li><a href="https://jakearchibald.com/2017/async-iterators-and-generators/" rel="noopener">Async iterators and generators</a></li>
<li><a href="https://surma.dev/lab/whatwg-stream-visualizer/lab.html" rel="noopener">Stream Visualizer</a></li>
</ul>
<h2 id="acknowledgements">Acknowledgements <a class="w-headline-link" href="#acknowledgements">#</a></h2>
<p>This article was reviewed by
<a href="https://jakearchibald.com/" rel="noopener">Jake Archibald</a>,
<a href="https://github.com/beaufortfrancois" rel="noopener">François Beaufort</a>,
<a href="https://samdutton.com/" rel="noopener">Sam Dutton</a>,
<a href="https://github.com/MattiasBuelens" rel="noopener">Mattias Buelens</a>,
<a href="https://surma.dev/" rel="noopener">Surma</a>,
<a href="https://github.com/jpmedley" rel="noopener">Joe Medley</a>, and
<a href="https://github.com/ricea" rel="noopener">Adam Rice</a>.
<a href="https://jakearchibald.com/" rel="noopener">Jake Archibald</a>'s blog posts have helped me a lot in understanding
streams. Some of the code samples are inspired by GitHub user
<a href="https://gist.github.com/bellbind/f6a7ba88e9f1a9d749fec4c9289163ac" rel="noopener">@bellbind</a>'s explorations and
parts of the prose build heavily on the
<a href="https://developer.mozilla.org/docs/Web/API/Streams_API" rel="noopener">MDN Web Docs on Streams</a>. The
<a href="https://streams.spec.whatwg.org/" rel="noopener">Streams Standard</a>'s
<a href="https://github.com/whatwg/streams/graphs/contributors" rel="noopener">authors</a> have done a tremendous job on
writing this spec. Hero image by <a href="https://unsplash.com/@ryanlara" rel="noopener">Ryan Lara</a> on
<a href="https://unsplash.com/" rel="noopener">Unsplash</a>.</p>


      

      <div class="cluster gutter-base flow-space-size-2" role="list" aria-label="tags">
        
          
        
          
        
          
            
            <a class="pill" href="/tags/capabilities/">Capabilities</a>
          
        
      </div>

      <div class="text-size-0 color-mid-text">
        <span>
          
          Last updated: <time>Feb 25, 2021</time>
          
        </span>
        —
        <a
          href="https://github.com/GoogleChrome/web.dev/blob/main/src/site/content/en/blog/streams/index.md"
        >
          Improve article
        </a>
      </div>

      

      
        
        
      

      
        <div class="flow-space-size-2">
          <a href="/blog" class="button" data-type="secondary">
            <svg xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>

            <span>Return to all articles</span>
          </a>
        </div>
      
      <div class="docked-actions flow flow-space-base">    
        <div>
          <share-action class="gc-analytics-event fab"
            authors="@tomayac"
            data-category="web.dev"
            data-label="share"
            data-action="click"
            data-type="primary"
            data-icon="share"
            tabindex="0"
            role="button"
          >
            <svg xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 24 24"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M18 16.1c-.8 0-1.4.3-2 .8l-7.1-4.2c.1-.2.1-.5.1-.7s0-.5-.1-.7L16 7.2c.5.5 1.2.8 2 .8 1.7 0 3-1.3 3-3s-1.3-3-3-3-3 1.3-3 3c0 .2 0 .5.1.7L8 9.8C7.5 9.3 6.8 9 6 9c-1.7 0-3 1.3-3 3s1.3 3 3 3c.8 0 1.5-.3 2-.8l7.1 4.2c-.1.2-.1.4-.1.6 0 1.6 1.3 2.9 2.9 2.9s2.9-1.3 2.9-2.9-1.2-2.9-2.8-2.9z" fill="currentColor"/></svg>
 
            <span class="fab__label">Share</span>
          </share-action>
        </div>
        
      </div>
    </article>
  </div>
</div>


</main>
<footer class="site-footer" role="contentinfo">
  <nav class="site-footer__primary-nav auto-grid" aria-label="footer navigation">
    <div>
      <h3 class="text-size-2 color-mid-text">Contribute</h3>
      <ul class="w-footer__linkbox-list" role="list">
        <li>
          <a href="https://github.com/GoogleChrome/web.dev/issues/new?assignees=&labels=bug&template=bug_report.md&title="
            data-category="Site-Wide Custom Events" data-label="Footer Link (index 1)">
            File a bug
          </a>
        </li>
        <li>
          <a href="https://github.com/googlechrome/web.dev"
            data-category="Site-Wide Custom Events" data-label="Footer Link (index 2)">
            View source
          </a>
        </li>
      </ul>
    </div>
    <div>
      <h3 class="text-size-2 color-mid-text">Related content</h3>
      <ul class="w-footer__linkbox-list" role="list">
          <li>
          <a href="https://developer.chrome.com/"
            data-category="Site-Wide Custom Events" data-label="Footer Link (index 1)">
            developer.chrome.com
          </a>
        </li>
        <li>
          <a href="https://blog.chromium.org/"
            data-category="Site-Wide Custom Events" data-label="Footer Link (index 1)">
            Chrome updates
          </a>
        </li>
        <li>
          <a href="https://developers.google.com/web/fundamentals"
            data-category="Site-Wide Custom Events" data-label="Footer Link (index 2)">
            Web Fundamentals
          </a>
        </li>
        <li>
          <a href="/tags/case-study/"
            data-category="Site-Wide Custom Events" data-label="Footer Link (index 3)">
            Case studies
          </a>
        </li>
        <li>
          <a href="/podcasts/"
            data-category="Podcasts" data-label="Footer Link (index 5)">
            Podcasts
          </a>
        </li>
        <li>
          <a href="/shows/"
            data-category="Shows" data-label="Footer Link (index 6)">
            Shows
          </a>
        </li>
      </ul>
    </div>
    <div>
      <h3 class="text-size-2 color-mid-text">Connect</h3>
      <ul class="w-footer__linkbox-list" role="list">
        <li>
          <a href="https://www.twitter.com/ChromiumDev"
            data-category="Site-Wide Custom Events" data-label="Footer Link (index 1)">
            Twitter
          </a>
        </li>
        <li>
          <a href="https://www.youtube.com/user/ChromeDevelopers"
            data-category="Site-Wide Custom Events" data-label="Footer Link (index 2)">
            YouTube
          </a>
        </li>
      </ul>
    </div>
  </nav>
  <nav class="site-footer__brand-nav repel" aria-label="Google developers">
    <ul class="cluster" role="list">
      <li>
        <a href="https://developers.google.com/" data-category="Site-Wide Custom Events" data-label="Footer Google Developers Link">
          <img loading="lazy" width="185" height="33" class="w-footer__utility-logo" src="/images/lockup-color.png"
            alt="Google Developers" />
        </a>
      </li>
      <li>
        <a href="https://developer.chrome.com/"
          data-category="Site-Wide Custom Events" data-label="Footer Chrome Link">
          Chrome
        </a>
      </li>
      <li>
        <a href="https://firebase.google.com/" data-category="Site-Wide Custom Events"
          data-label="Footer Firebase Link">
          Firebase
        </a>
      </li>
      <li>
        <a href="https://cloud.google.com/" data-category="Site-Wide Custom Events"
          data-label="Footer Google Cloud Platform Link">
          Google Cloud Platform
        </a>
      </li>
      <li>
        <a href="https://developers.google.com/products"
          data-category="Site-Wide Custom Events" data-label="Footer All products Link">
          All products
        </a>
      </li>
    </ul>
    <web-language-select current="en"></web-language-select>
  </nav>
  <nav class="site-footer__misc-links" aria-label="terms and policies">
    <ul class="cluster" role="list">
      <li>
        <a href="https://policies.google.com/" data-category="Site-Wide Custom Events"
          data-label="Footer Terms and Privacy link">
          Terms &amp; Privacy
        </a>
      </li>
      <li>
        <a href="/community-guidelines/" data-category="Site-Wide Custom Events"
          data-label="Footer Community Guidelines link">
          Community Guidelines
        </a>
      </li>
    </ul>
  </nav>
  <p class="gap-top-size-2 text-size-0">
    Except as otherwise noted, the content of this page is licensed
    under the
    <a href="https://creativecommons.org/licenses/by/4.0/">
    Creative Commons Attribution 4.0 License</a>,
    and code samples are licensed under the
    <a href="https://www.apache.org/licenses/LICENSE-2.0">
    Apache 2.0 License</a>. For details, see the
    <a href="https://developers.google.com/terms/site-policies">
    Google Developers Site Policies</a>.
  </p>
</footer>


  </body>
</html>
