
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">


  
    
    <link rel="stylesheet" href="/css/main.css?v=6078b0afad71">
  

  <link rel="preload" as="font" crossorigin href="/fonts/material-icons/regular.woff2">


<link rel="preload" as="font" crossorigin href="/fonts/google-sans/regular/latin.woff2">
<link rel="preload" as="font" crossorigin href="/fonts/google-sans/bold/latin.woff2">

<meta name="theme-color" content="#fff"/>




<title>Life of a payment transaction</title>
<meta name="description" content="Learn how merchants integrate payment apps, how payment transactions work with the Payment Request API, and what's possible in Web Payments. " />

<link rel="canonical" href="https://web.dev/life-of-a-payment-transaction/" />

<meta itemprop="name" content="Life of a payment transaction" />
<meta itemprop="description" content="Learn how merchants integrate payment apps, how payment transactions work with the Payment Request API, and what's possible in Web Payments. " />
<meta itemprop="image" content="https://web-dev.imgix.net/image/tcFciHGuF3MxnTr1y5ue01OGLBn2/vU99HKzIf5EUPnzGVPf1.png?auto=format&fit=max&w=1200&fm=auto" />
<meta property="og:locale" content="en_US" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://web.dev/life-of-a-payment-transaction/" />
<meta property="og:site_name" content="web.dev" />
<meta property="og:title" content="Life of a payment transaction" />
<meta property="og:description" content="Learn how merchants integrate payment apps, how payment transactions work with the Payment Request API, and what's possible in Web Payments. " />
<meta property="og:image" content="https://web-dev.imgix.net/image/tcFciHGuF3MxnTr1y5ue01OGLBn2/vU99HKzIf5EUPnzGVPf1.png?auto=format&fit=max&w=1200&fm=auto" />
<meta property="og:image:alt" content="" />
<meta property="tag" content="payments" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="Life of a payment transaction" />
<meta name="twitter:description" content="Learn how merchants integrate payment apps, how payment transactions work with the Payment Request API, and what's possible in Web Payments. " />
<meta name="twitter:image" content="https://web-dev.imgix.net/image/tcFciHGuF3MxnTr1y5ue01OGLBn2/vU99HKzIf5EUPnzGVPf1.png?auto=format&fit=max&w=1200&fm=auto" />
<link
  rel="alternate"
  href="/feed.xml"
  type="application/atom+xml"
  data-title="web.dev feed"
/>

<link rel="manifest" href="/manifest.webmanifest" />

<link rel="shortcut icon" href="/images/favicon.ico">
<link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
<link rel="mask-icon" color="#0054ff" href="/images/safari-pinned-tab.svg">



<script>
window.ga =
  window.ga ||
  function () {
    (ga.q = ga.q || []).push(arguments);
  };
ga.l = +new Date();
ga('create', 'UA-126406676-2');
ga('set', 'transport', 'beacon');
ga('set', 'anonymizeIp', true);
ga('set', 'page', window.location.pathname);
ga('set', 'dimension5', '4');
ga('send', 'pageview');
</script>







<script>
function loadScript(url, type) {
  const s = document.createElement('script');
  s.src = url;
  if (type) {
    s.type = type;
  }
  if (type === 'module') {
    s.async = false; // Preserve load order.
    const pre = document.createElement('link');
    pre.rel = 'modulepreload';
    pre.href = url;
    document.head.append(pre);
    // We use DOMContentLoaded as the loader script is running sync, and inserting a module script here doesn't defer. This brings back normal type="module" behavior.
    window.addEventListener('DOMContentLoaded', () => {
      document.head.append(s);
    });
  } else {
    document.head.append(s);
  }
}
loadScript('/js/app.js?v=292c222c9a217', 'module');




  loadScript('/js/content.js?v=02b95297dbc96', 'module');


  loadScript('https://www.google-analytics.com/analytics.js', null);

</script>

  </head>
  <body class="unresolved">
    
    <web-snackbar-container></web-snackbar-container>

    



<web-header class="header-default" role="navigation">
  <button data-open-drawer-button class="w-button--svg w-button--round" aria-label="Open menu">
    








  










  <svg class="icon " role="img" aria-label="menu" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" height="24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>


    <span class="w-tooltip w-tooltip--left">Open menu</span>
  </button>

  <a
    href="/"
    class="header-default__logo-link gc-analytics-event"
    data-category="Site-Wide Custom Events"
    data-label="Site logo"
  >
    <img class="header-default__logo" width="125" height="23" src="/images/lockup.svg" alt="web.dev" />
  </a>

  <div class="header-default__middle">
    <div class="header-default__links">
      <a
        href="/learn/"
        class="header-default__link gc-analytics-event"
        data-category="Site-Wide Custom Events"
        data-label="Tab: Learn"
      >
        Learn
      </a>

      <a
        href="/measure/"
        class="header-default__link gc-analytics-event"
        data-category="Site-Wide Custom Events"
        data-label="Tab: Measure"
      >
        Measure
      </a>

      <a
        href="/blog/"
        class="header-default__link gc-analytics-event"
        data-category="Site-Wide Custom Events"
        data-label="Tab: Blog"
      >
        Blog
      </a>

      <a
        href="/about/"
        class="header-default__link gc-analytics-event"
        data-category="Site-Wide Custom Events"
        data-label="Tab: About"
      >
        About
      </a>
    </div>
    <web-search results-id="search-main-results" i18n="{&quot;search&quot;:{&quot;en&quot;:&quot;Search&quot;},&quot;open_search&quot;:{&quot;en&quot;:&quot;Open search&quot;},&quot;all_articles&quot;:{&quot;en&quot;:&quot;All articles&quot;},&quot;close_search&quot;:{&quot;en&quot;:&quot;Close search&quot;}}"></web-search>
    <web-search-results id="search-main-results"></web-search-results>
  </div>

  <web-profile-switcher-container></web-profile-switcher-container>
</web-header>



<web-navigation-drawer class="drawer-default" type="modal">
  <nav data-drawer-container>
    <div class="drawer-default__contents">
      <div class="drawer-default__header">
        <button
          data-drawer-close-button
          class="drawer-default__hide w-button--svg w-button--round"
          aria-label="Close"
        >
          








  










  <svg class="icon " role="img" aria-label="close" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" height="24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>


          <span class="w-tooltip">Close</span>
        </button>
        <a
          href="/"
          class="gc-analytics-event"
          data-category="Site-Wide Custom Events"
          data-label="Site logo"
        >
          <img
            width="125"
            height="30"
            class="drawer-default__logo"
            src="/images/lockup.svg"
            alt="web.dev"
          />
        </a>
      </div>
      <a
        href="/learn/"
        class="drawer-default__link gc-analytics-event"
        data-category="Site-Wide Custom Events"
        data-label="SideNav: Learn"
      >
        Learn
      </a>
      <a
        href="/measure/"
        class="drawer-default__link gc-analytics-event"
        data-category="Site-Wide Custom Events"
        data-label="SideNav: Measure"
      >
        Measure
      </a>
      <a
        href="/blog/"
        class="drawer-default__link gc-analytics-event"
        data-category="Site-Wide Custom Events"
        data-label="SideNav: Blog"
      >
        Blog
      </a>
      <a
        href="/about/"
        class="drawer-default__link gc-analytics-event"
        data-category="Site-Wide Custom Events"
        data-label="SideNav: About"
      >
        About
      </a>
    </div>
  </nav>
</web-navigation-drawer>

<main>
  <div id="content">
    
      
    
    


<div class="guide-landing-page">
  
    
    
    
  
  

  

  <web-table-of-contents>
    <h2 class="w-toc__header">
      <a href="#life-of-a-payment-transaction" class="w-toc__header--link">
        Life of a payment transaction
      </a>
    </h2>
    <div class="w-toc__list">
        <ul><li><a href="#step-1:-the-merchant-initiates-a-payment-transaction">Step 1: The merchant initiates a payment transaction</a></li><li><a href="#step-2:-the-merchant-shows-a-payment-button">Step 2: The merchant shows a payment button</a><ol><li><a href="#does-the-customer-have-the-payment-app-available">Does the customer have the payment app available?</a></li></ol></li><li><a href="#show">Step 3: The customer presses the payment button</a><ol><li><a href="#deferring-the-launch-of-the-payment-ui">Deferring the launch of the payment UI</a></li></ol></li><li><a href="#launch">Step 4: The browser launches the payment app</a></li><li><a href="#step-5:-how-a-merchant-can-update-the-transaction-details-depending-on-customer's-actions">Step 5: How a merchant can update the transaction details depending on customer's actions</a><ol><li><a href="#payment-method-change-event">Payment method change event</a></li><li><a href="#merchant-validation-event">Merchant validation event</a></li></ol></li><li><a href="#step-6:-the-merchant-validates-the-payment-and-completes-the-transaction">Step 6: The merchant validates the payment and completes the transaction</a><ol><li><a href="#processing-and-validating-the-payment">Processing and validating the payment</a></li><li><a href="#completing-or-retrying-the-transaction">Completing or retrying the transaction</a></li></ol></li><li><a href="#next-steps">Next Steps</a></li></ul></div>
  </web-table-of-contents>
  <web-table-of-contents-button></web-table-of-contents-button>

  
  <div class="w-actions">
    <share-action authors="@agektmr | @bibydigital"
      class="gc-analytics-event w-actions__fab w-actions__fab--share"
      data-category="web.dev"
      data-label="share"
      data-action="click"
      data-icon="share"
      tabindex="0"
      role="button"
    >
      <span>Share</span>
    </share-action>
    
    
  </div>

  <div class="w-layout-container--narrow w-post-content">
    <header class="w-article-header">
      

      <h1 id="life-of-a-payment-transaction" class="w-article-header__headline">Life of a payment transaction</h1>
      
        <p class="w-article-header__subhead w-mb--non">
          <p>Learn how merchants integrate payment apps and how payment transactions work
with the Payment Request API.</p>

        </p>
      

      
        <div class="w-author__published">
          <time>May 25, 2020</time>
           <span class="w-author__separator">•</span> Updated <time>Jul 17, 2020</time> 
        </div>
      

      
      

      <div class="w-layout-container--narrow w-post-signpost">
  <span class="w-post-signpost__title">
    Appears in:
  </span>
  <a
          class="w-post-signpost__link"
          href="/payments"
          >Web Payments</a
        >
</div>

      
        <div class="w-authors w-mt--xl w-pt--sm">
          
            <div class="w-author">
  <a href="/authors/agektmr/"><img     alt="Eiji Kitamura"     class="w-author__image"     decoding="async"     height="64"          loading="lazy"     sizes="(min-width: 64px) 64px, calc(100vw - 48px)"     src="https://web-dev.imgix.net/image/admin/Mh9DRmQhjlroJM9JDqsu.jpg?auto=format&fit=crop&h=64&w=64"     srcset="https://web-dev.imgix.net/image/admin/Mh9DRmQhjlroJM9JDqsu.jpg?fit=crop&h=64&w=64&auto=format&dpr=1&q=75 1x,     https://web-dev.imgix.net/image/admin/Mh9DRmQhjlroJM9JDqsu.jpg?fit=crop&h=64&w=64&auto=format&dpr=2&q=50 2x,     https://web-dev.imgix.net/image/admin/Mh9DRmQhjlroJM9JDqsu.jpg?fit=crop&h=64&w=64&auto=format&dpr=3&q=35 3x,     https://web-dev.imgix.net/image/admin/Mh9DRmQhjlroJM9JDqsu.jpg?fit=crop&h=64&w=64&auto=format&dpr=4&q=23 4x,     https://web-dev.imgix.net/image/admin/Mh9DRmQhjlroJM9JDqsu.jpg?fit=crop&h=64&w=64&auto=format&dpr=5&q=20 5x"          width="64"   /></a>
  <div
    class="w-author__info"
    style="display: flex; flex-direction: column; justify-content: center;"
  >
    <cite class="w-author__name">
      <a class="w-author__name-link" href="/authors/agektmr/">Eiji Kitamura</a>
    </cite>
    <ul class="w-author__link-list">
      <li class="w-author__link-listitem">
        <a class="w-author__link" href="https://twitter.com/agektmr"
          >Twitter</a
        >
      </li>
      <li class="w-author__link-listitem">
        <a class="w-author__link" href="https://github.com/agektmr">GitHub</a>
      </li>
      
      <li class="w-author__link-listitem">
        <a class="w-author__link" href="https://blog.agektmr.com">Blog</a>
      </li>
    </ul>
  </div>
</div>
          
            <div class="w-author">
  <a href="/authors/mihajlija/"><img     alt="Milica Mihajlija"     class="w-author__image"     decoding="async"     height="64"          loading="lazy"     sizes="(min-width: 64px) 64px, calc(100vw - 48px)"     src="https://web-dev.imgix.net/image/admin/WkMOiDtaDgiAA2YkRZ5H.jpg?auto=format&fit=crop&h=64&w=64"     srcset="https://web-dev.imgix.net/image/admin/WkMOiDtaDgiAA2YkRZ5H.jpg?fit=crop&h=64&w=64&auto=format&dpr=1&q=75 1x,     https://web-dev.imgix.net/image/admin/WkMOiDtaDgiAA2YkRZ5H.jpg?fit=crop&h=64&w=64&auto=format&dpr=2&q=50 2x,     https://web-dev.imgix.net/image/admin/WkMOiDtaDgiAA2YkRZ5H.jpg?fit=crop&h=64&w=64&auto=format&dpr=3&q=35 3x,     https://web-dev.imgix.net/image/admin/WkMOiDtaDgiAA2YkRZ5H.jpg?fit=crop&h=64&w=64&auto=format&dpr=4&q=23 4x,     https://web-dev.imgix.net/image/admin/WkMOiDtaDgiAA2YkRZ5H.jpg?fit=crop&h=64&w=64&auto=format&dpr=5&q=20 5x"          width="64"   /></a>
  <div
    class="w-author__info"
    style="display: flex; flex-direction: column; justify-content: center;"
  >
    <cite class="w-author__name">
      <a class="w-author__name-link" href="/authors/mihajlija/">Milica Mihajlija</a>
    </cite>
    <ul class="w-author__link-list">
      <li class="w-author__link-listitem">
        <a class="w-author__link" href="https://twitter.com/bibydigital"
          >Twitter</a
        >
      </li>
      <li class="w-author__link-listitem">
        <a class="w-author__link" href="https://github.com/mihajlija">GitHub</a>
      </li>
      
      <li class="w-author__link-listitem">
        <a class="w-author__link" href="https://mihajlija.github.io/">Blog</a>
      </li>
    </ul>
  </div>
</div>
          
        </div>
      
    </header>

    

    <div class="w-aside w-aside--warning">
<p><strong>Warning</strong>:</p>
<p>Shipping and address support in <a href="https://github.com/w3c/payment-request/pull/955" rel="noopener">the Payment Request API is removed from the
specification</a> and is no longer
functional.</p>
</div>
<p>Web Payments APIs are dedicated payment features built into the browser
for the first time. With Web Payments, merchant integration with payment apps
becomes simpler while the customer experience gets streamlined and more secure.</p>
<p>To learn more about the benefits of using Web Payments check out <a href="/empowering-payment-apps-with-web-payments">Empowering
payment apps with Web Payments</a>.</p>
<p>This article walks you through a payment transaction on a merchant website and
helps you understand how payment app integration works.</p>
<p>The process involves 6 steps:</p>
<ol>
<li>
<p>The merchant initiates a payment transaction.</p>
</li>
<li>
<p>The merchant shows a payment button.</p>
</li>
<li>
<p>The customer presses the payment button.</p>
 <img     alt="A diagram of a cheese shop website with a BobPay (payment app) button."          decoding="async"     height="298"          loading="lazy"          src="https://web-dev.imgix.net/image/tcFciHGuF3MxnTr1y5ue01OGLBn2/NQIh5tt5wsQFC5yKLCaU.svg"               width="786"   />
</li>
<li>
<p>The browser launches the payment app.</p>
 <img     alt="A diagram of the cheese shop website with BobPay app launched in a modal. The modal shows shipping options and total cost."          decoding="async"     height="366"          loading="lazy"          src="https://web-dev.imgix.net/image/tcFciHGuF3MxnTr1y5ue01OGLBn2/IHztIcfJKeWDUIkugTkb.svg"               width="671"   />
</li>
<li>
<p>If the customer changes payment method, the merchant updates the transaction
details reflecting the change.</p>
</li>
<li>
<p>After the customer confirms the purchase, the merchant validates the payment
and completes the transaction.</p>
 <img     alt="A diagram showing the customer pressing the &quot;Pay&quot; button in BobPay, followed by a diagram of the cheese shop page showing &quot;Payment accepted&quot;."          decoding="async"     height="708"          loading="lazy"          src="https://web-dev.imgix.net/image/tcFciHGuF3MxnTr1y5ue01OGLBn2/9Q6VqimbOxJ3ZXHvB8ry.svg"               width="778"   />
</li>
</ol>
<h2 id="step-1:-the-merchant-initiates-a-payment-transaction">Step 1: The merchant initiates a payment transaction <a class="w-headline-link" href="#step-1:-the-merchant-initiates-a-payment-transaction">#</a></h2>
<p>When a customer decides to make a purchase, the merchant initiates the payment
transaction by constructing a
<a href="https://developers.google.com/web/fundamentals/payments/basics/how-payment-request-api-works" rel="noopener"><code>PaymentRequest</code></a>
object. This object includes important information about the transaction:</p>
<ul>
<li>Acceptable payment methods and their data to process the transaction.</li>
<li>Details, such as the total price (required) and information about the items.</li>
</ul>
<web-copy-code><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PaymentRequest</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{</span><br>  supportedMethods<span class="token operator">:</span> <span class="token string">'https://bobpay.xyz/pay'</span><span class="token punctuation">,</span><br>  data<span class="token operator">:</span> <span class="token punctuation">{</span><br>    transactionId<span class="token operator">:</span> <span class="token string">'****'</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><br>  displayItems<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><br>    label<span class="token operator">:</span> <span class="token string">'Anvil L/S Crew Neck - Grey M x1'</span><span class="token punctuation">,</span><br>    amount<span class="token operator">:</span> <span class="token punctuation">{</span> currency<span class="token operator">:</span> <span class="token string">'USD'</span><span class="token punctuation">,</span> value<span class="token operator">:</span> <span class="token string">'22.15'</span> <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>  total<span class="token operator">:</span> <span class="token punctuation">{</span><br>    label<span class="token operator">:</span> <span class="token string">'Total due'</span><span class="token punctuation">,</span><br>    amount<span class="token operator">:</span> <span class="token punctuation">{</span> currency<span class="token operator">:</span> <span class="token string">'USD'</span><span class="token punctuation">,</span> value <span class="token operator">:</span> <span class="token string">'22.15'</span> <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</web-copy-code><details class="w-details" >
<summary class="w-details__summary">
  <h2 class="w-details__header">
    Including a transaction ID
  </h2>
</summary>
<p>Some payment handlers may require the merchant to provide the transaction ID
which they have issued in advance as part of the transaction information. A
typical integration includes communication between the merchant's and the
payment handler's server to reserve the total price. This prevents malicious
customers from manipulating the price and cheating the merchant with a
validation at the end of the transaction.</p>
<p>The merchant can pass a transaction ID as part of the
<a href="https://www.w3.org/TR/payment-request/#dom-paymentmethoddata" rel="noopener"><code>PaymentMethodData</code></a>
object's <code>data</code> property.</p>
</details>
<p>Provided the transaction information, the browser goes through a discovery
process of payment apps specified in the <code>PaymentRequest</code> based on the payment
method identifiers. This way, the browser can determine the payment app to
launch as soon as the merchant is ready to proceed with the transaction.</p>
<p>To learn how the discovery process works in detail check out <a href="/setting-up-a-payment-method#how-a-browser-discovers-a-payment-app">Setting up a
payment
method</a>.</p>
<h2 id="step-2:-the-merchant-shows-a-payment-button">Step 2: The merchant shows a payment button <a class="w-headline-link" href="#step-2:-the-merchant-shows-a-payment-button">#</a></h2>
<p>Merchants can support many payment methods, but should only present the payment
buttons for those that a customer can actually use. Showing a payment button
that is unusable is poor user experience. If a merchant can predict that a
payment method specified in the <code>PaymentRequest</code> object won't work for the
customer, they can provide a fallback solution or not show that button at all.</p>
<p>Using a <code>PaymentRequest</code> instance, a merchant can query whether a customer has
the payment app available.</p>
<h3 id="does-the-customer-have-the-payment-app-available">Does the customer have the payment app available? <a class="w-headline-link" href="#does-the-customer-have-the-payment-app-available">#</a></h3>
<p>The
<a href="https://developer.mozilla.org/docs/Web/API/PaymentRequest/canMakePayment" rel="noopener"><code>canMakePayment()</code></a>
method of <code>PaymentRequest</code> returns <code>true</code> if a payment app is available on the
customer's device. &quot;Available&quot; means that a payment app that supports the
payment method is discovered, and that the platform-specific payment app is installed, or
the web-based payment app is <a href="/setting-up-a-payment-method#jit-register">ready to be
registered</a>.</p>
<web-copy-code><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> canMakePayment <span class="token operator">=</span> <span class="token keyword">await</span> request<span class="token punctuation">.</span><span class="token function">canMakePayment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>canMakePayment<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token comment">// Fallback to other means of payment or hide the button.</span><br><span class="token punctuation">}</span></code></pre>
</web-copy-code><h2 id="show">Step 3: The customer presses the payment button <a class="w-headline-link" href="#show">#</a></h2>
<p>When the customer presses the payment button, the merchant calls the <code>show()</code>
method of the <code>PaymentRequest</code> instance which immediately triggers the launch of
the payment UI.</p>
<p>In case the final total price is set dynamically (for example, retrieved from a
server), the merchant can defer the launch of the payment UI until the total is
known.</p>
<h3 id="deferring-the-launch-of-the-payment-ui">Deferring the launch of the payment UI <a class="w-headline-link" href="#deferring-the-launch-of-the-payment-ui">#</a></h3>
<p>Check out a demo of <a href="https://rsolomakhin.github.io/pr/wait/" rel="noopener">deferring the payment
UI</a> until the final total price is
determined.</p>
<p>To defer the payment UI, the merchant passes a promise to the <code>show()</code> method.
The browser will show a loading indicator until the promise resolves and the
transaction is ready to begin.</p>
<web-copy-code><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">getTotalAmount</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token comment">// Fetch the total amount from the server, etc.</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br><span class="token keyword">try</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> request<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token function">getTotalAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token comment">// Process the result…</span><br><span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token function">handleError</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
</web-copy-code><p>If there is no promise specified as an argument for <code>show()</code>, the browser will
launch the payment UI immediately.</p>
<div class="w-aside w-aside--note">
<p>If the payment handler is designed to return a transaction ID upon setting the
total price, the ID can be passed as part of the promise result.</p>
</div>
<h2 id="launch">Step 4: The browser launches the payment app <a class="w-headline-link" href="#launch">#</a></h2>
<p>The browser can launch a platform-specific or a web-based payment app. (You can learn more
about <a href="/setting-up-a-payment-method#how-chrome-determines-which-payment-app-to-launch">how Chrome determines which payment app to
launch</a>.)</p>
<p>How the payment app is built is up to the developer for the most part, but the
events emitted from and to the merchant, as well as the structure of the data
passed along with those events, are standardized.</p>
<p>When the payment app is launched, it receives <a href="https://w3c.github.io/payment-handler/#the-paymentrequestevent" rel="noopener">the transaction
information</a>
passed to the <code>PaymentRequest</code> object in Step 1, which includes the following:</p>
<ul>
<li>Payment method data</li>
<li>Total price</li>
</ul>
<p>The payment app uses the transaction information to label its UI.</p>
<h2 id="step-5:-how-a-merchant-can-update-the-transaction-details-depending-on-customer's-actions">Step 5: How a merchant can update the transaction details depending on customer's actions <a class="w-headline-link" href="#step-5:-how-a-merchant-can-update-the-transaction-details-depending-on-customer's-actions">#</a></h2>
<p>Customers have an option to change the transaction details such as payment
method in the payment app. While the customer makes changes, the merchant
receives the change events and updates the transaction details.</p>
<p>There are four types of events a merchant can receive:</p>
<ul>
<li>Payment method change event</li>
<li>Merchant validation event</li>
</ul>
<h3 id="payment-method-change-event">Payment method change event <a class="w-headline-link" href="#payment-method-change-event">#</a></h3>
<p>A payment app can support multiple payment methods and a merchant may offer a
special discount depending on the customer's selection. To cover this use case,
the payment method change event can inform the merchant of the new payment
method so that they can update the total price with the discount and return it
back to the payment app.</p>
<web-copy-code><pre class="language-js"><code class="language-js">request<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'paymentmethodchange'</span><span class="token punctuation">,</span> <span class="token parameter">e</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  e<span class="token punctuation">.</span><span class="token function">updateWith</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>    <span class="token comment">// Add discount etc.</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</web-copy-code><h3 id="merchant-validation-event">Merchant validation event <a class="w-headline-link" href="#merchant-validation-event">#</a></h3>
<p>For additional security, a payment app can perform a merchant validation before
proceeding to the payment flow. The design of the validation mechanism is up to
the payment app, but the merchant validation event serves to inform the merchant
of the URL they can use to validate themselves.</p>
<web-copy-code><pre class="language-js"><code class="language-js">request<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'merchantvalidation'</span><span class="token punctuation">,</span> <span class="token parameter">e</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  e<span class="token punctuation">.</span><span class="token function">updateWith</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>    <span class="token comment">// Use `e.validateURL` to validate</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</web-copy-code><div class="w-aside w-aside--note">
<p>The support for the merchant validation event is limited to Apple Safari. Chromium-based
browsers have not implemented this event as of May 2020.</p>
</div>
<h2 id="step-6:-the-merchant-validates-the-payment-and-completes-the-transaction">Step 6: The merchant validates the payment and completes the transaction <a class="w-headline-link" href="#step-6:-the-merchant-validates-the-payment-and-completes-the-transaction">#</a></h2>
<p>When the customer successfully authorizes the payment, the <code>show()</code> method
returns a promise that resolves to a
<a href="https://w3c.github.io/payment-request/#paymentresponse-interface" rel="noopener"><code>PaymentResponse</code></a>.
The <code>PaymentResponse</code> object includes the following information:</p>
<ul>
<li>Payment result details</li>
</ul>
<p>At this point, the browser UI may still show a loading indicator meaning that
the transaction is not completed yet.</p>
<p>If the payment app is terminated because of a payment failure or error, the
promise returned from <code>show()</code> rejects, and the browser terminates the payment
transaction.</p>
<h3 id="processing-and-validating-the-payment">Processing and validating the payment <a class="w-headline-link" href="#processing-and-validating-the-payment">#</a></h3>
<p>The <code>details</code> in <code>PaymentResponse</code> is the payment credential object returned
from the payment app. The merchant can use the credential to process or validate
the payment. How this critical process works is up to the payment handler.</p>
<h3 id="completing-or-retrying-the-transaction">Completing or retrying the transaction <a class="w-headline-link" href="#completing-or-retrying-the-transaction">#</a></h3>
<p>After the merchant determines whether the transaction has succeded or failed,
they can either:</p>
<ul>
<li>Call the <code>.complete()</code> method to complete the transaction and dismiss the
loading indicator.</li>
<li>Let the customer retry by calling the <code>retry()</code> method.</li>
</ul>
<web-copy-code><pre class="language-js"><code class="language-js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">doPaymentRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">try</span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PaymentRequest</span><span class="token punctuation">(</span>methodData<span class="token punctuation">,</span> details<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> request<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">await</span> <span class="token function">validateResponse</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">// AbortError, SecurityError</span><br>    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">validateResponse</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">try</span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> errors <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">checkAllValuesAreGood</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>errors<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token keyword">await</span> response<span class="token punctuation">.</span><span class="token function">retry</span><span class="token punctuation">(</span>errors<span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token keyword">return</span> <span class="token function">validateResponse</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>    <span class="token keyword">await</span> response<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token string">"success"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">// Something went wrong…</span><br>    <span class="token keyword">await</span> response<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token string">"fail"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><span class="token comment">// Must be called as a result of a click</span><br><span class="token comment">// or some explicit user action.</span><br><span class="token function">doPaymentRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</web-copy-code><h2 id="next-steps">Next Steps <a class="w-headline-link" href="#next-steps">#</a></h2>
<ul>
<li>Learn how to declare a payment method identifier in detail in <a href="/setting-up-a-payment-method">Setting up a
payment method</a>.</li>
<li>Learn how to build a platform-specific payment app in
<a href="/android-payment-apps-developers-guide">Android payment apps developer's guide</a>.</li>
<li>Learn how to build a web-based payment app in <a href="/web-based-payment-apps-overview">Web-based payment apps developer's
guide</a>.</li>
</ul>


    

    
  <div class="w-chips ">
    
      
    
      
        
        <a class="w-chip" href="/tags/payments/">Payments</a>
      
    
  </div>


    <div class="w-post-github-link w-mt--l w-mb--l">
      <span class="w-mr--sm">
        
        Last updated: <time>Jul 17, 2020</time>
        
      </span>
      <a
        href="https://github.com/GoogleChrome/web.dev/blob/main/src/site/content/en/payments/life-of-a-payment-transaction/index.md"
      >
        Improve article
      </a>
       
    </div>

    
  </div>

  
    
    <nav class="w-article-navigation">
  <a
    class="w-article-navigation__link w-article-navigation__link--back
      w-article-navigation__link--single gc-analytics-event"
    data-category="web.dev"
    data-label="navigation, go back"
    data-action="click"
    href="/payments"
  >
    Return to all articles
  </a>
</nav>
  
</div>


  </div>
</main>
<footer class="w-footer">
  <nav class="w-footer__linkboxes">
    <ul class="w-footer__linkboxes-list">
      <li class="w-footer__linkbox">
        <h3 class="w-footer__linkbox-heading">Contribute</h3>
        <ul class="w-footer__linkbox-list">
          <li class="w-footer__linkbox-item">
            <a href="https://github.com/GoogleChrome/web.dev/issues/new?assignees=&labels=bug&template=bug_report.md&title="
              class="w-footer__linkbox-link" data-category="Site-Wide Custom Events" data-label="Footer Link (index 1)">
              File a bug
            </a>
          </li>
          <li class="w-footer__linkbox-item">
            <a href="https://github.com/googlechrome/web.dev" class="w-footer__linkbox-link"
              data-category="Site-Wide Custom Events" data-label="Footer Link (index 2)">
              View source
            </a>
          </li>
        </ul>
      </li>
      <li class="w-footer__linkbox">
        <h3 class="w-footer__linkbox-heading">Related content</h3>
        <ul class="w-footer__linkbox-list">
         <li class="w-footer__linkbox-item">
            <a href="https://developer.chrome.com/" class="w-footer__linkbox-link"
              data-category="Site-Wide Custom Events" data-label="Footer Link (index 1)">
              developer.chrome.com
            </a>
          </li>
          <li class="w-footer__linkbox-item">
            <a href="https://blog.chromium.org/" class="w-footer__linkbox-link"
              data-category="Site-Wide Custom Events" data-label="Footer Link (index 1)">
              Chrome updates
            </a>
          </li>
          <li class="w-footer__linkbox-item">
            <a href="https://developers.google.com/web/fundamentals" class="w-footer__linkbox-link"
              data-category="Site-Wide Custom Events" data-label="Footer Link (index 2)">
              Web Fundamentals
            </a>
          </li>
          <li class="w-footer__linkbox-item">
            <a href="https://developers.google.com/web/showcase/" class="w-footer__linkbox-link"
              data-category="Site-Wide Custom Events" data-label="Footer Link (index 3)">
              Case studies
            </a>
          </li>
          <li class="w-footer__linkbox-item">
            <a href="/podcasts/" class="w-footer__linkbox-link"
              data-category="Podcasts" data-label="Footer Link (index 5)">
              Podcasts
            </a>
          </li>
          <li class="w-footer__linkbox-item">
            <a href="/shows/" class="w-footer__linkbox-link"
              data-category="Shows" data-label="Footer Link (index 6)">
              Shows
            </a>
          </li>
        </ul>
      </li>
      <li class="w-footer__linkbox">
        <h3 class="w-footer__linkbox-heading">Connect</h3>
        <ul class="w-footer__linkbox-list">
          <li class="w-footer__linkbox-item">
            <a href="https://www.twitter.com/ChromiumDev" class="w-footer__linkbox-link"
              data-category="Site-Wide Custom Events" data-label="Footer Link (index 1)">
              Twitter
            </a>
          </li>
          <li class="w-footer__linkbox-item">
            <a href="https://www.youtube.com/user/ChromeDevelopers" class="w-footer__linkbox-link"
              data-category="Site-Wide Custom Events" data-label="Footer Link (index 2)">
              YouTube
            </a>
          </li>
        </ul>
      </li>
    </ul>
  </nav>

  <div class="w-footer__utility">
    <nav class="w-footer__utility-nav">
      <a href="https://developers.google.com/" class="w-footer__utility-logo-link"
        data-category="Site-Wide Custom Events" data-label="Footer Google Developers Link">
        <img loading="lazy" width="185" height="33" class="w-footer__utility-logo" src="/images/lockup-color.png"
          alt="Google Developers" />
      </a>
      <ul class="w-footer__utility-list">
        <li class="w-footer__utility-item">
          <a class="w-footer__utility-link" href="https://developer.chrome.com/"
            data-category="Site-Wide Custom Events" data-label="Footer Chrome Link">
            Chrome
          </a>
        </li>
        <li class="w-footer__utility-item">
          <a class="w-footer__utility-link" href="https://firebase.google.com/" data-category="Site-Wide Custom Events"
            data-label="Footer Firebase Link">
            Firebase
          </a>
        </li>
        <li class="w-footer__utility-item">
          <a class="w-footer__utility-link" href="https://cloud.google.com/" data-category="Site-Wide Custom Events"
            data-label="Footer Google Cloud Platform Link">
            Google Cloud Platform
          </a>
        </li>
        <li class="w-footer__utility-item">
          <a class="w-footer__utility-link" href="https://developers.google.com/products"
            data-category="Site-Wide Custom Events" data-label="Footer All products Link">
            All products
          </a>
        </li>
      </ul>
      <web-language-select current="en"></web-language-select>
    </nav>
    <nav class="w-footer__utility-nav">
      <ul class="w-footer__utility-list">
        <li class="w-footer__utility-item">
          <a class="w-footer__utility-link" href="https://policies.google.com/" data-category="Site-Wide Custom Events"
            data-label="Footer Terms and Privacy link">
            Terms &amp; Privacy
          </a>
        </li>
        <li class="w-footer__utility-item">
          <a class="w-footer__utility-link" href="/community-guidelines/" data-category="Site-Wide Custom Events"
            data-label="Footer Community Guidelines link">
            Community Guidelines
          </a>
        </li>
      </ul>
      <div class="w-footer__license">
        <p>
          Except as otherwise noted, the content of this page is licensed
          under the
          <a href="https://creativecommons.org/licenses/by/4.0/">
          Creative Commons Attribution 4.0 License</a>,
          and code samples are licensed under the
          <a href="https://www.apache.org/licenses/LICENSE-2.0">
          Apache 2.0 License</a>. For details, see the
          <a href="https://developers.google.com/terms/site-policies">
          Google Developers Site Policies</a>.
        </p>
      </div>
    </nav>
  </div>
</footer>

  </body>
</html>
